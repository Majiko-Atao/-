<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ArbiMail Â· ä»²è£æµ‹è¯•ï¼ˆå³ä¾§è‡ªåŠ¨å›å¤-ä»…ä»£ç†å¾‹å¸ˆï¼‰</title>
<style>
  :root{
    --ink:#0f172a; --muted:#667085; --line:#e6edf5; --bg:#f6f9fc; --brand:#2f6efb;
    --left:280px; --mid:520px; --side:360px; --gut:8px;
    --shadow:0 10px 28px rgba(15,23,42,.08);
  }
  *{box-sizing:border-box} html,body{height:100%}
  body{margin:0;font:14px/1.55 -apple-system,BlinkMacSystemFont,"Segoe UI","PingFang SC",Arial,sans-serif;color:var(--ink);background:#f6f9fc}
  .topbar{height:54px;display:flex;align-items:center;justify-content:space-between;padding:0 12px;background:#fff;border-bottom:1px solid var(--line)}
  .brand{font-weight:800}
  .actions{display:flex;gap:8px}
  .btn{height:32px;padding:0 12px;border:1px solid var(--line);border-radius:10px;background:#fff;cursor:pointer}
  .btn.primary{background:#2f6efb;border-color:#2f6efb;color:#fff}
  .select{height:32px;border:1px solid var(--line);border-radius:10px;background:#fff;padding:0 10px}

  /* èº«ä»½ & è§†å›¾ */
  .role-switch{display:flex;border:1px solid var(--line);border-radius:10px;overflow:hidden;background:#fff}
  .role-switch button{height:32px;border:0;background:transparent;padding:0 14px;cursor:pointer}
  .role-switch button.on{background:#2f6efb;color:#fff}
  .seg{display:flex;border:1px solid var(--line);border-radius:10px;overflow:hidden;background:#fff}
  .seg button{height:32px;border:0;background:transparent;padding:0 14px;cursor:pointer}
  .seg button.on{background:#eef2ff;color:#1f2a44;font-weight:700}
  .hidden{display:none !important}

  /* å¸ƒå±€ */
  .layout{height:calc(100vh - 54px);display:grid;grid-template-columns:var(--left) var(--gut) 1fr var(--gut) var(--side)}
  .col{min-width:0;overflow:auto}
  .main{padding:12px}
  .card{background:#fff;border:1px solid var(--line);border-radius:12px;box-shadow:var(--shadow);padding:12px;margin-bottom:12px}
  .card h3{margin:0 0 8px}
  .kv{font-weight:700;color:#475569;width:72px}
  .row-flex{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .chip{padding:2px 8px;border:1px solid #e3e8ff;background:#eef2ff;border-radius:999px}
  .chip.link{cursor:pointer}
  .mini{height:30px;padding:0 10px;border:1px solid var(--line);border-radius:8px;background:#fff;cursor:pointer}
  .mini.primary{background:#2f6efb;color:#fff;border-color:#2f6efb}
  .select.sm{height:28px;padding:0 8px}

  /* å·¦ä¾§ï¼šé‚®ç®±/æ¡ˆä»¶/åˆåŒæ–‡ä»¶å¤¹ï¼ˆæ²¿ç”¨ä½ ä¹‹å‰ç»“æ„ï¼‰ */
  .left{background:#fff;border-right:1px solid var(--line);padding:12px 10px}
  .group{margin-bottom:10px}
  .g-head{display:flex;align-items:center;justify-content:space-between;padding:8px;border-radius:10px;font-weight:700;background:#f7fafc;border:1px solid var(--line);cursor:pointer}
  .g-head:hover{background:#f1f6ff}
  .g-title{display:flex;align-items:center;gap:8px}
  .caret{transition:.2s}
  .g-body{margin-top:6px;border-left:2px solid #eaf1fb;padding-left:8px;display:flex;flex-direction:column;gap:6px}
  .item{display:flex;justify-content:space-between;align-items:center;padding:6px 8px;border-radius:10px;cursor:pointer}
  .item:hover{background:#f8fbff}
  .item.active{background:#e7efff}
  .name{white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .subctrl{display:flex;align-items:center;gap:8px}
  .badge{min-width:18px;height:18px;padding:0 6px;border-radius:999px;background:#eef2ff;color:#334155;font-size:12px;display:inline-flex;align-items:center;justify-content:center}
  .tiny{border:1px solid var(--line);border-radius:8px;height:28px;padding:0 10px;background:#fff;cursor:pointer;font-size:12px}
  .tiny.primary{background:#2f6efb;color:#fff;border-color:#2f6efb}
  .tiny[data-act="toggle"]{width:28px;padding:0;display:flex;align-items:center;justify-content:center}
  .sublist{display:flex;flex-direction:column;gap:6px;margin-left:14px}
  .pdf-list{display:flex;flex-direction:column;gap:6px}
  .pdf-row{display:grid;grid-template-columns:20px 1fr auto auto;align-items:center;gap:8px;padding:6px 8px;border:1px solid var(--line);border-radius:10px;background:#fff}
  .pdf-ico{text-align:center}.pdf-name{white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .link-row{display:grid;grid-template-columns:20px 1fr auto;align-items:center;gap:8px;padding:6px 8px;border:1px dashed #e5eaf5;border-radius:10px;background:#fbfdff}
  .pdf-empty{padding:8px;border:1px dashed #e5eaf5;border-radius:10px;background:#fbfdff;color:#94a3b8}

  /* é‚®ä»¶è§†å›¾ï¼ˆåˆ—è¡¨+é˜…è¯»ï¼‰ */
  .list-wrap{display:flex;flex-direction:column;height:100%;background:#fff;border:1px solid var(--line);border-radius:12px;overflow:hidden}
  .toolbar{display:flex;gap:10px;align-items:center;padding:8px;border-bottom:1px solid var(--line);background:#fff}
  .search{flex:1;display:flex;gap:8px;align-items:center;background:#f7f9fd;border:1px solid var(--line);border-radius:10px;padding:6px 10px}
  .search input{flex:1;border:none;background:transparent;outline:none}
  .pill{border:1px solid var(--line);border-radius:999px;padding:2px 10px;background:#fff;color:#334155}
  .list{overflow:auto}
  .section-hd{position:sticky;top:0;background:#fff;padding:6px 10px;color:#7a869f;font-size:12px;border-top:1px solid var(--line);border-bottom:1px solid var(--line)}
  .row-mail{display:grid;grid-template-columns:10px 1fr auto;gap:8px;align-items:center;padding:9px 10px;border-bottom:1px solid var(--line);cursor:pointer}
  .row-mail:hover{background:#f8fbff}.dot{width:8px;height:8px;border-radius:50%;background:#d1d9e8;margin-left:2px}
  .subject{font-weight:650;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}
  .meta{color:#6b7280;font-size:12px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

  .paper{background:#fff;border:1px solid var(--line);box-shadow:var(--shadow);border-radius:12px;padding:0}
  .mailbar{display:flex;gap:6px;flex-wrap:wrap;align-items:center;padding:8px;border-bottom:1px solid var(--line);background:#fbfbfe;border-top-left-radius:12px;border-top-right-radius:12px}
  .mb-btn{height:28px;padding:0 10px;border:1px solid var(--line);border-radius:8px;background:#fff;cursor:pointer;font-size:12px}
  .mb-btn:hover{background:#f5f7ff}
  .header{padding:10px 12px;border-bottom:1px solid var(--line)}
  .h-subject{font-weight:800;font-size:18px;margin-bottom:6px}
  .h-line{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin:6px 0}
  .pill-addr{background:#fff6d7;border:1px solid #f0e3b1;padding:0 8px;height:22px;display:inline-flex;align-items:center;border-radius:999px;font-size:12px}
  .r-grid{display:grid;grid-template-columns:360px 1fr;gap:14px;padding:12px}
  .kp{border:1px dashed #dbeafe;background:#f8fbff;border-radius:10px;padding:10px}
  .info{border:1px solid var(--line);border-radius:10px;padding:10px}
  .kvline{display:flex;flex-wrap:wrap;gap:8px;margin-top:6px}
  .attachments{grid-column:1/3;display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
  .file{border:1px solid var(--line);border-radius:8px;padding:6px 10px;background:#fff}
  .body{grid-column:1/3;white-space:pre-wrap;margin-top:6px;line-height:1.8}
  .pdf-card{grid-column:1/3;margin-top:12px;border:1px solid var(--line);border-radius:12px;box-shadow:var(--shadow);background:#fff}
  .pdf-toolbar{display:flex;gap:8px;align-items:center;justify-content:space-between;padding:8px 10px;border-bottom:1px solid var(--line);background:#fbfdff;border-top-left-radius:12px;border-top-right-radius:12px}
  .pdf-tools{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .pdf-wrap{height:56vh;overflow:hidden;border-bottom-left-radius:12px;border-bottom-right-radius:12px}
  .pdf-frame{width:100%;height:100%;border:0;display:block;background:#f6f9fc}

  /* å³ä¾§æ  */
  .side{background:#fff;border-left:1px solid var(--line);padding:10px}
  .kvtable{width:100%;border-collapse:collapse}
  .kvtable td{padding:6px 4px;border-bottom:1px dashed #eef2f7;font-size:13px}
  .op-group{display:flex;gap:8px;flex-wrap:wrap}
  .switch{display:inline-flex;align-items:center;gap:6px}
  .switch input{accent-color:#2f6efb}
  .bookmark{display:flex;justify-content:space-between;align-items:center;padding:6px 8px;border-radius:8px}
  .bookmark:hover{background:#f7faff}
  .mini-link{font-size:12px;color:#2f6efb;cursor:pointer}
  .rel-list{display:flex;flex-direction:column;gap:8px}
  .rel-item{display:flex;justify-content:space-between;gap:8px}
  .rel-item a{color:#0f172a;text-decoration:none}
  .rel-meta{color:#64748b;font-size:12px}

  /* è‡ªåŠ¨å›å¤ï¼ˆå³ä¾§å¡ç‰‡ï¼‰ */
  .rule{border:1px dashed #e5eaf5;border-radius:10px;padding:10px;margin-bottom:10px}
  .rule-top{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px}
  .rule-title{font-weight:700}
  .rule-row{display:flex;flex-direction:column;gap:6px;margin-top:6px}
  .rule-row label{font-size:12px;color:#64748b}
  .rule-row input,.rule-row textarea,.rule-row select{
    border:1px solid var(--line);border-radius:8px;padding:6px 10px;height:32px
  }
  .rule-range{display:grid;grid-template-columns:1fr 1fr;gap:8px}
  .mono{font-family:ui-monospace, Menlo, Consolas, monospace;white-space:pre-wrap}
  .hint{color:#94a3b8;font-size:12px}

  /* å“åº”å¼ */
  @media (max-width:1360px){
    :root{--side:0px}
    #sideCol{display:none}
    .layout{grid-template-columns:var(--left) var(--gut) 1fr}
  }
</style>
</head>
<body>
  <!-- é¡¶éƒ¨ï¼šèº«ä»½/æ¡ˆä»¶/è§†å›¾ -->
  <div class="topbar">
    <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
      <div class="brand">ArbiMail Â· ä»²è£æµ‹è¯•</div>

      <div class="role-switch" id="roleSwitch">
        <button data-role="counsel">ä»£ç†å¾‹å¸ˆ</button>
        <button data-role="arbitrator">ä»²è£å‘˜</button>
      </div>

      <select id="caseSelect" class="select" title="é€‰æ‹©æ¡ˆä»¶"></select>

      <div class="seg" id="viewSeg">
        <button data-view="recap">å·¥ä½œå°</button>
        <button data-view="matrix">çŸ©é˜µ+Recap</button>
        <button data-view="mail">é‚®ä»¶</button>
        <button data-view="pdf">PDF</button>
      </div>
    </div>
    <div class="actions">
      <button class="btn" onclick="window.print()">å¯¼å‡ºPDF</button>
      <button class="btn primary">æ–°å»ºæ¡ˆä»¶</button>
    </div>
  </div>

  <div class="layout">
    <!-- å·¦åˆ—ï¼šé‚®ç®±/æ¡ˆä»¶/åˆåŒæ–‡ä»¶å¤¹ï¼ˆçœç•¥ï¼šä¸ä¹‹å‰ä¸€è‡´çš„ DOM ä¼šåœ¨è„šæœ¬é‡Œæ¸²æŸ“ï¼‰ -->
    <div class="col left">
      <div class="group">
        <div class="g-head" data-toggle="mbx"><div class="g-title"><span class="caret">â–¾</span> é‚®ä»¶ç®±</div></div>
        <div class="g-body" id="mbxBody"></div>
      </div>
      <div class="group">
        <div class="g-head" data-toggle="case"><div class="g-title"><span class="caret">â–¾</span> æˆ‘çš„æ¡ˆä»¶</div></div>
        <div class="g-body" id="caseBody"></div>
      </div>
      <div class="group">
        <div class="g-head" data-toggle="shelf">
          <div class="g-title"><span class="caret">â–¾</span> åˆåŒæ–‡ä»¶å¤¹</div>
          <div><button class="tiny" id="btnAddPdf">ï¼‹ æ·»åŠ PDF</button><input id="pdfPicker" type="file" accept="application/pdf" style="display:none"></div>
        </div>
        <div class="g-body" id="shelfBody"></div>
      </div>
    </div>

    <div></div> <!-- gutter -->

    <!-- ä¸­åˆ—ï¼šä¸åŒè§†å›¾ï¼ˆä¸ºç®€æ´ï¼Œæ­¤å¤„ä»…æ”¾â€œé‚®ä»¶â€å®Œæ•´ï¼›å…¶ä»–è§†å›¾çš„ç»“æ„ä¸ä¹‹å‰ä¸€è‡´ï¼‰ -->
    <div class="col main" id="mainCol">
      <!-- é‚®ä»¶è§†å›¾ -->
      <div id="mailView" class="mainview">
        <div class="row-flex" style="gap:12px; align-items:flex-start">
          <div style="flex:0 0 480px; min-width:420px">
            <div class="list-wrap">
              <div class="toolbar">
                <div class="search"><span>ğŸ”</span><input id="q" placeholder="æœç´¢ï¼ˆfrom: party: clause: has:attachmentï¼‰"></div>
                <span class="pill" id="viewPill">æ¡ˆä»¶</span>
              </div>
              <div id="list" class="list"></div>
            </div>
          </div>
          <div style="flex:1 1 auto; min-width:420px">
            <article class="paper">
              <div class="mailbar">
                <button class="mb-btn" data-roles="counsel,arbitrator">å›å¤</button>
                <button class="mb-btn" data-roles="counsel,arbitrator">å›å¤å…¨éƒ¨</button>
                <button class="mb-btn" data-roles="counsel,arbitrator">è½¬å‘</button>
                <button class="mb-btn" data-roles="counsel">è‡ªåŠ¨å›å¤</button>
              </div>
              <div class="header" id="mailHeader">
                <div class="h-subject" id="subj">â€”</div>
                <div class="h-line"><div class="kv">å‘ä»¶äºº</div><div id="hFrom"></div></div>
                <div class="h-line"><div class="kv">æ”¶ä»¶äºº</div><div id="hTo"></div></div>
                <div class="h-line" id="ccLine" style="display:none;"><div class="kv">æŠ„é€</div><div id="hCc"></div></div>
                <div class="h-line"><div class="kv">æ—¶é—´</div><div id="hTime"></div></div>
              </div>
              <section class="r-grid">
                <div class="kp"><div style="font-weight:700;margin-bottom:6px">å…³é”®è¦ç‚¹</div><div id="kp"></div></div>
                <div class="info">
                  <div style="font-weight:700;margin-bottom:6px">å…³é”®è¯</div>
                  <div class="kvline" id="chips"></div>
                </div>
                <div class="attachments" id="attach"></div>
                <div class="body" id="body"></div>
                <div class="pdf-card">
                  <div class="pdf-toolbar">
                    <div class="pdf-tools">
                      <button class="mini" id="btnReload">åˆ·æ–°</button>
                      <label class="mini" style="display:flex;align-items:center;gap:6px;cursor:pointer">é€‰æ‹©PDF
                        <input type="file" id="filePicker" accept="application/pdf" style="display:none">
                      </label>
                      <div class="pdf-chips" id="pdfChips"></div>
                    </div>
                    <div>
                      <input id="pdfPage" placeholder="é¡µç â€¦" style="height:30px;border:1px solid var(--line);border-radius:8px;padding:0 10px;width:90px">
                      <button class="mini" id="btnPage">è·³è½¬</button>
                      <input id="pdfFind" placeholder="åœ¨PDFä¸­æŸ¥æ‰¾â€¦" style="height:30px;border:1px solid var(--line);border-radius:8px;padding:0 10px;width:220px;margin-left:8px">
                      <button class="mini" id="btnFind">æŸ¥æ‰¾</button>
                    </div>
                  </div>
                  <div class="pdf-wrap"><iframe id="pdfFrame" class="pdf-frame" title="åˆåŒPDF"></iframe></div>
                </div>
              </section>
            </article>
          </div>
        </div>
      </div>

      <!-- å…¶ä½™è§†å›¾ï¼ˆå ä½ï¼Œä¿ç•™ä½ å·²æœ‰çš„å¸ƒå±€é€»è¾‘ï¼‰ -->
      <div id="recapView" class="mainview hidden"><div class="card">å·¥ä½œå°ï¼ˆè¿™é‡Œä¿ç•™ä½ çš„ Recap/é”šç‚¹/AIè‰æ‹Ÿï¼‰</div></div>
      <div id="matrixView" class="mainview hidden"><div class="card">çŸ©é˜µ+Recapï¼ˆè¿™é‡Œä¿ç•™ä½ çš„çŸ©é˜µè¡¨ï¼‰</div></div>
      <div id="pdfView" class="mainview hidden">
        <div class="card">
          <div class="pdf-toolbar">
            <div class="pdf-tools">
              <button class="mini" id="btnReload2">åˆ·æ–°</button>
              <label class="mini" style="display:flex;align-items:center;gap:6px;cursor:pointer">é€‰æ‹©PDF
                <input type="file" id="filePicker2" accept="application/pdf" style="display:none">
              </label>
              <div class="pdf-chips" id="pdfChips2"></div>
            </div>
            <div>
              <input id="pdfPage2" placeholder="é¡µç â€¦" style="height:30px;border:1px solid var(--line);border-radius:8px;padding:0 10px;width:90px">
              <button class="mini" id="btnPage2">è·³è½¬</button>
              <input id="pdfFind2" placeholder="åœ¨PDFä¸­æŸ¥æ‰¾â€¦" style="height:30px;border:1px solid var(--line);border-radius:8px;padding:0 10px;width:220px;margin-left:8px">
              <button class="mini" id="btnFind2">æŸ¥æ‰¾</button>
            </div>
          </div>
          <div class="pdf-wrap"><iframe id="pdfFrame2" class="pdf-frame" title="åˆåŒPDFï¼ˆæ”¾å¤§ï¼‰"></iframe></div>
        </div>
      </div>
    </div>

    <div></div> <!-- gutter -->

    <!-- å³åˆ—ï¼šå¸¸é©»ä¾§æ  + æ–°çš„è‡ªåŠ¨å›å¤å¡ç‰‡ï¼ˆä»…ä»£ç†å¾‹å¸ˆï¼‰ -->
    <div class="col side" id="sideCol">
      <div class="card" data-roles="counsel">
        <h4>AI æ‘˜è¦</h4><div id="aisum" style="color:#475569">é€‰æ‹©ä¸€å°é‚®ä»¶æŸ¥çœ‹ã€‚</div>
      </div>

      <div class="card" data-roles="counsel">
        <h4>æ™ºèƒ½æŠ½å–å­—æ®µ</h4>
        <table class="kvtable" id="kvExtract">
          <tbody>
            <tr><td style="width:84px;color:#64748b">æ¡ˆä»¶</td><td id="kvCase">â€”</td></tr>
            <tr><td style="color:#64748b">è´¹ç‡/ä»·æ ¼</td><td id="kvRate">â€”</td></tr>
            <tr><td style="color:#64748b">Laycan</td><td id="kvLaycan">â€”</td></tr>
            <tr><td style="color:#64748b">è£…æ¸¯</td><td id="kvLoad">â€”</td></tr>
            <tr><td style="color:#64748b">å¸æ¸¯</td><td id="kvDisc">â€”</td></tr>
            <tr><td style="color:#64748b">è§„åˆ™</td><td id="kvRules">â€”</td></tr>
          </tbody>
        </table>
      </div>

      <!-- æ–°ï¼šè‡ªåŠ¨å›å¤ï¼ˆé˜ˆå€¼ç­–ç•¥ï¼‰ ä»…ä»£ç†å¾‹å¸ˆå¯è§ -->
      <div class="card" data-roles="counsel">
        <h4 style="display:flex;justify-content:space-between;align-items:center">
          <span>è‡ªåŠ¨å›å¤ï¼ˆé˜ˆå€¼ç­–ç•¥ï¼‰</span>
          <label class="switch"><input type="checkbox" id="autoReplyEnable"> å¯ç”¨</label>
        </h4>

        <div class="op-group" style="margin:6px 0 8px">
          <label>åº”ç”¨æ¡ˆä»¶</label>
          <select id="arCaseSelect" class="select sm"></select>
          <button class="mini" id="btnTestReply">æµ‹è¯•å½“å‰é‚®ä»¶</button>
        </div>

        <div id="ruleList"></div>
        <div class="op-group" style="margin:6px 0">
          <button class="mini" id="btnAddRule">ï¼‹ æ·»åŠ å­—æ®µ</button>
          <button class="mini" id="btnSaveRules">ä¿å­˜</button>
          <button class="mini" id="btnResetRules">é‡ç½®</button>
        </div>

        <div class="hint">è¯´æ˜ï¼šä¸Šé¢ä¸ºå­—æ®µå†…å®¹ï¼Œä¸‹é¢è®¾ç½®åŒºé—´èŒƒå›´/å…è®¸åˆ—è¡¨ã€‚å‘½ä¸­å…¨éƒ¨å¯ç”¨å­—æ®µæ—¶å°†å»ºè®®â€œåŒæ„â€ã€‚</div>

        <textarea id="replyDraft" class="mono" placeholder="è‡ªåŠ¨ç”Ÿæˆçš„å›å¤è‰ç¨¿â€¦" style="width:100%;height:120px;margin-top:8px;"></textarea>
        <div class="op-group" style="margin-top:6px">
          <button class="mini primary" id="btnCopyReply">å¤åˆ¶è‰ç¨¿</button>
        </div>
      </div>

      <div class="card" data-roles="counsel">
        <h4>å…³è”ä¿¡æ¯</h4>
        <div id="relInfo" style="color:#475569">â€”</div>
      </div>

      <div class="card" data-roles="counsel,arbitrator">
        <h4>å¿«é€Ÿæ“ä½œ</h4>
        <div class="op-group">
          <label class="switch"><input type="checkbox" id="opFlag"> çº¢æ——</label>
          <label class="switch"><input type="checkbox" id="opArch"> å½’æ¡£</label>
          <button class="mini" id="opToCase">ç§»è‡³å½“å‰æ¡ˆä»¶</button>
        </div>
      </div>

      <div class="card" data-roles="counsel,arbitrator">
        <h4>ç›¸å…³é‚®ä»¶</h4>
        <div class="rel-list" id="relEmails">â€”</div>
      </div>

      <div class="card" data-roles="counsel,arbitrator">
        <h4>PDF ä¹¦ç­¾</h4>
        <div class="op-group" style="margin-bottom:8px">
          <button class="mini" id="bmAddPage">æ·»åŠ é¡µç ä¹¦ç­¾</button>
          <button class="mini" id="bmAddSearch">æ·»åŠ å…³é”®å­—ä¹¦ç­¾</button>
          <button class="mini" id="bmClear">æ¸…ç©º</button>
        </div>
        <div id="bmList">æš‚æ— ä¹¦ç­¾</div>
      </div>
    </div>
  </div>

<script>
/* ========= æ•°æ®ç¤ºä¾‹ ========= */
var PDFS=[{id:'pdfA',name:'Test Contract (ClickDimensions)',url:'https://www.clickdimensions.com/links/TestPDFfile.pdf'},
          {id:'pdfB',name:'W3C Dummy PDF',url:'https://www.w3.org/WAI/ER/tests/xhtml/testfiles/resources/pdf/dummy.pdf'},
          {id:'pdfC',name:'Mozilla Sample (PDF.js)',url:'https://mozilla.github.io/pdf.js/web/compressed.tracemonkey-pldi-09.pdf'}];
var CASES=[{id:'C-001',name:'[ICSID] Procedural Order No.1 å¯¹é½',color:'#3b82f6',pdfIds:['pdfC']},
           {id:'C-002',name:'MV Ocean Star â€” Main Terms',color:'#10b981',pdfIds:['pdfA']},
           {id:'C-003',name:'MV Silver Wave â€” Spot Voyage',color:'#f59e0b',pdfIds:[]}];
var MAILBOXES=[{id:'inbox',name:'æ”¶ä»¶ç®±'},{id:'sent',name:'å·²å‘é€'},{id:'flag',name:'çº¢æ——é‚®ä»¶'},{id:'arch',name:'å·²å½’æ¡£'},{id:'unfiled',name:'æœªå½’æ¡£'}];
var EMAILS=[{id:'e1',folder:'inbox',flag:true,arch:false,subject:'Proposed edits â€” Quorum & Procedural Language',from:'claimant.counsel@example.com',to:['respondent.counsel@example.com'],cc:[],date:'2025-08-12 10:30',body:'We propose: (i) Option 1 (two-person quorum) in Â§4; (ii) Procedural Language: English only (Option 1) in Â§11; (iii) transcript be available in real-time; (iv) Production of Documents to follow ICSID Rules 33â€“36.',attachments:[{name:'TestPDFfile.pdf',url:'https://www.clickdimensions.com/links/TestPDFfile.pdf'}],tags:{topic:['Quorum','Procedural Language','Hearings','Production of Documents']},caseId:'C-001'},
            {id:'e2',folder:'inbox',flag:false,arch:false,subject:'Re: Edits â€” Publication Option 2',from:'respondent.counsel@example.com',to:['claimant.counsel@example.com'],cc:[],date:'2025-08-12 14:10',body:'In Â§23, we prefer Publication Option 2 (award published only with both parties consent).',attachments:[],tags:{topic:['Publication','Option 2']},caseId:'C-001'},
            {id:'e3',folder:'inbox',flag:false,arch:false,subject:'Offer freight at USD 56,000 PDPR for 12 months',from:'broker@ship.com',to:['owners@co.com','charterer@qs.com'],cc:[],date:'2025-08-11 09:12',body:'Laycan 19â€“25 Nov. Load port Beira, discharge Tianjin. Time counting SHINC. Please confirm.',attachments:[{name:'W3C Dummy.pdf',url:'https://www.w3.org/WAI/ER/tests/xhtml/testfiles/resources/pdf/dummy.pdf'}],tags:{topic:['Laycan','PDPR','NOR','SHINC','Beira','Tianjin']},caseId:'C-002'},
            {id:'e4',folder:'inbox',flag:true,arch:false,subject:'NOR validity question at Beira (SHINC)',from:'charterer@qs.com',to:['owners@co.com'],cc:[],date:'2025-08-10 08:23',body:'Please confirm NOR tendering window at Beira and applicable SHINC rule.',attachments:[],tags:{topic:['NOR','SHINC','Beira']},caseId:'C-002'},
            {id:'e5',folder:'inbox',flag:false,arch:false,subject:'MV Silver Wave â€” recap (Busan to Manila, 25â€“27 Aug)',from:'broker@sea.com',to:['ops@ship.com'],cc:[],date:'2025-08-11 16:05',body:'Fixture recap attached; laycan 25â€“27 Aug, Busan to Manila.',attachments:[{name:'Mozilla Sample.pdf',url:'https://mozilla.github.io/pdf.js/web/compressed.tracemonkey-pldi-09.pdf'}],tags:{topic:['Laycan','Recap','Busan','Manila']},caseId:'C-003'}];

/* ========= å·¥å…· ========= */
function $(s){return document.querySelector(s);}
function fmtDate(s){var d=new Date(s);function p(n){return (n<10?'0':'')+n;}return d.getFullYear()+'-'+p(d.getMonth()+1)+'-'+p(d.getDate())+' '+p(d.getHours())+':'+p(d.getMinutes());}
function groupLabel(d){var dd=Math.floor((new Date()-new Date(d))/86400000);return dd<=0?'ä»Šå¤©':dd===1?'æ˜¨å¤©':'æ›´æ—©';}
function findOne(a,p){for(var i=0;i<a.length;i++){if(p(a[i]))return a[i];}return null;}
function strip(html){var n=document.createElement('div'); n.innerHTML=html; return n.innerText||n.textContent||'';}

/* ========= é¡¶éƒ¨çŠ¶æ€ ========= */
var APP={role:localStorage.getItem('arbimail.role')||'counsel', view:location.hash.replace('#','')||'mail', caseId:localStorage.getItem('arbimail.case')|| (CASES[0]&&CASES[0].id) };
function setHash(v){location.hash=v;}

function applyRole(){
  document.querySelectorAll('#roleSwitch button').forEach(function(b){ b.classList.toggle('on', b.getAttribute('data-role')===APP.role); });
  document.querySelectorAll('[data-roles]').forEach(function(el){
    var allow = el.getAttribute('data-roles').split(',').map(function(s){return s.trim();});
    el.classList.toggle('hidden', allow.indexOf(APP.role)===-1);
  });
}
function applyView(){
  document.querySelectorAll('#viewSeg button').forEach(function(b){ b.classList.toggle('on', b.getAttribute('data-view')===APP.view); });
  document.querySelectorAll('.mainview').forEach(function(v){ v.classList.toggle('hidden', v.id!==APP.view+'View'); });
  if(APP.view==='mail'){ state.scope={type:'case',id:APP.caseId}; renderList(); }
  if(APP.view==='pdf'){ syncPdfToBigView(); }
}
function initTopBar(){
  document.querySelectorAll('#roleSwitch button').forEach(function(b){
    b.onclick=function(){ APP.role=this.getAttribute('data-role'); localStorage.setItem('arbimail.role',APP.role); applyRole(); };
  });
  document.querySelectorAll('#viewSeg button').forEach(function(b){
    b.onclick=function(){ APP.view=this.getAttribute('data-view'); setHash(APP.view); applyView(); };
  });
  window.addEventListener('hashchange', function(){ APP.view=location.hash.replace('#','')||'mail'; applyView(); });

  var sel=$('#caseSelect'); sel.innerHTML=CASES.map(function(c){return '<option value="'+c.id+'">'+c.name+'</option>';}).join('');
  sel.value=APP.caseId;
  sel.onchange=function(){ APP.caseId=this.value; localStorage.setItem('arbimail.case',APP.caseId); refreshForCase(); };
}

/* ========= å·¦ä¾§ï¼šé‚®ç®±/æ¡ˆä»¶/åˆåŒ ========= */
var state={scope:{type:'case',id:APP.caseId}, selected:null};
function setBadgeCounts(){
  var c={inbox:EMAILS.filter(function(e){return e.folder==='inbox';}).length,
         sent:EMAILS.filter(function(e){return e.folder==='sent';}).length,
         flag:EMAILS.filter(function(e){return e.flag;}).length,
         arch:EMAILS.filter(function(e){return e.arch;}).length,
         unfiled:EMAILS.filter(function(e){return !e.caseId;}).length};
  ['inbox','sent','flag','arch','unfiled'].forEach(function(k){
    var el=document.getElementById('b_'+k); if(el) el.textContent=c[k]||0;
  });
}
function renderMailboxes(){
  var box=$('#mbxBody'); box.innerHTML='';
  MAILBOXES.forEach(function(m){
    var row=document.createElement('div'); row.className='item';
    row.innerHTML='<div class="name">'+m.name+'</div><div class="subctrl"><span class="badge" id="b_'+m.id+'">0</span></div>';
    row.onclick=function(){ state.scope={type:'mailbox',id:m.id}; renderList(); };
    box.appendChild(row);
  });
  setBadgeCounts();
}
function renderCaseGroup(){
  var wrap=$('#caseBody'); wrap.innerHTML='';
  CASES.forEach(function(c){
    var row=document.createElement('div'); row.className='item';
    row.innerHTML='<div class="name" style="display:flex;align-items:center;gap:8px">'
                 +'<span style="width:8px;height:8px;border-radius:50%;background:'+c.color+'"></span>'+c.name+'</div>'
                 +'<div class="subctrl"><button class="tiny" data-act="toggle">â–¾</button><span class="badge">'
                 +EMAILS.filter(function(e){return e.caseId===c.id;}).length+'</span></div>';
    row.onclick=function(ev){
      if(ev.target && ev.target.getAttribute('data-act')==='toggle'){
        var box = wrap.querySelector('.sublist[data-case="'+c.id+'"]');
        box.style.display = box.style.display==='none'?'':'none'; ev.stopPropagation(); return;
      }
      APP.caseId=c.id; $('#caseSelect').value=c.id; refreshForCase();
    };
    wrap.appendChild(row);

    var sub=document.createElement('div'); sub.className='sublist pdf-list'; sub.setAttribute('data-case',c.id);
    if(!c.pdfIds.length){ sub.innerHTML='<div class="pdf-empty">ï¼ˆæœªå…³è”åˆåŒï¼‰</div>'; }
    else {
      c.pdfIds.forEach(function(pid){
        var p=findOne(PDFS,function(x){return x.id===pid;}); if(!p) return;
        var s=document.createElement('div'); s.className='pdf-row';
        s.innerHTML='<div class="pdf-ico">ğŸ“</div><div class="pdf-name" title="'+p.name+'">'+p.name+'</div>'
                   +'<button class="tiny primary" data-act="open">æ‰“å¼€</button><button class="tiny" data-act="unlink">ç§»é™¤</button>';
        s.onclick=function(ev){
          var act=ev.target && ev.target.getAttribute('data-act');
          if(act==='open'){ openPdf(p.url,{zoom:'page-fit'}); openPdfBig(p.url,{zoom:'page-fit'}); APP.view='pdf'; setHash('pdf'); applyView(); ev.stopPropagation(); }
          if(act==='unlink'){ c.pdfIds=c.pdfIds.filter(function(x){return x!==pid;}); renderCaseGroup(); ev.stopPropagation(); }
        };
        sub.appendChild(s);
      });
    }
    var ctrl=document.createElement('div'); ctrl.className='link-row';
    var sel='<select class="tiny" style="width:100%">'; PDFS.forEach(function(p){ sel+='<option value="'+p.id+'">'+p.name+'</option>'; }); sel+='</select>';
    ctrl.innerHTML='<div class="pdf-ico">â•</div>'+sel+'<button class="tiny" data-act="link">å…³è”</button>';
    ctrl.onclick=function(ev){
      if(ev.target && ev.target.getAttribute('data-act')==='link'){
        var s=ctrl.querySelector('select'); var pid=s.value; if(pid && c.pdfIds.indexOf(pid)<0){ c.pdfIds.push(pid); renderCaseGroup(); }
        ev.stopPropagation();
      }
    };
    sub.appendChild(ctrl);
    wrap.appendChild(sub);
  });
}
function renderShelf(){
  var wrap=$('#shelfBody'); wrap.innerHTML='';
  if(!PDFS.length){ wrap.innerHTML='<div class="pdf-empty">æš‚æ— PDF</div>'; return; }
  PDFS.forEach(function(p){
    var row=document.createElement('div'); row.className='item';
    row.innerHTML='<div class="name">ğŸ“„ '+p.name+'</div><div class="subctrl"><span class="badge">PDF</span></div>';
    row.onclick=function(){ openPdf(p.url,{zoom:'page-fit'}); openPdfBig(p.url,{zoom:'page-fit'}); APP.view='pdf'; setHash('pdf'); applyView(); };
    wrap.appendChild(row);
  });
}

/* ========= é‚®ä»¶åˆ—è¡¨/é˜…è¯» ========= */
function pool(){
  if(state.scope.type==='case') return EMAILS.filter(function(e){return e.caseId===state.scope.id;});
  if(state.scope.id==='flag') return EMAILS.filter(function(e){return e.flag;});
  if(state.scope.id==='arch') return EMAILS.filter(function(e){return e.arch;});
  if(state.scope.id==='unfiled') return EMAILS.filter(function(e){return !e.caseId;});
  return EMAILS.filter(function(e){return e.folder==='inbox';});
}
function renderList(){
  var arr=pool().sort(function(a,b){return new Date(b.date)-new Date(a.date);});
  $('#viewPill').textContent = state.scope.type==='case'
    ? ('æ¡ˆä»¶ Â· '+(findOne(CASES,function(c){return c.id===state.scope.id;})||{}).name) :
      (findOne(MAILBOXES,function(m){return m.id===state.scope.id;})||{name:'è§†å›¾'}).name;

  var box=$('#list'); box.innerHTML='';
  var last=''; arr.forEach(function(e){
    var lb=groupLabel(e.date);
    if(lb!==last){ last=lb; var hd=document.createElement('div'); hd.className='section-hd'; hd.innerText=lb; box.appendChild(hd); }
    var row=document.createElement('div'); row.className='row-mail';
    row.innerHTML='<div class="dot"></div><div style="min-width:0"><div class="subject">'+e.subject+'</div><div class="meta">'
                 +e.from+' Â· '+(e.to||[]).join(', ')+'</div></div><div class="meta">'+fmtDate(e.date)+'</div>';
    row.onclick=function(){ selectMail(e.id); };
    box.appendChild(row);
  });
}
var currentPdfUrl='';
function pills(a){return (a||[]).map(function(x){return '<span class="pill-addr">'+x+'</span>';}).join(' ');}
function selectMail(id){
  var e=findOne(EMAILS,function(x){return x.id===id;}); if(!e) return; state.selected=id; APP.caseId=e.caseId; $('#caseSelect').value=APP.caseId; $('#arCaseSelect').value=APP.caseId;

  $('#subj').textContent=e.subject;
  $('#hFrom').innerHTML=pills([e.from]);
  $('#hTo').innerHTML=pills(e.to||[]);
  if(e.cc && e.cc.length){ $('#ccLine').style.display='flex'; $('#hCc').innerHTML=pills(e.cc); } else { $('#ccLine').style.display='none'; }
  $('#hTime').textContent=fmtDate(e.date);

  $('#kp').innerHTML='â€¢ è®®é¢˜ï¼š'+((e.tags&&e.tags.topic)||[]).join('ã€')+'<br>â€¢ å…³è”æ¡ˆä»¶ï¼š'+((findOne(CASES,function(c){return c.id===e.caseId;})||{}).name||'â€”');
  var kws=extractKeywords(e), chips=kws.map(function(k){return '<span class="chip link" data-k="'+k.replace(/"/g,'&quot;')+'">'+k+'</span>';});
  $('#chips').innerHTML=chips.join(' '); document.querySelectorAll('.chip.link').forEach(function(x){x.onclick=function(){ jumpSearch(this.getAttribute('data-k')); jumpSearchBig(this.getAttribute('data-k')); };});
  $('#attach').innerHTML=(e.attachments||[]).map(function(a){return '<span class="file">ğŸ“ '+a.name+'</span>';}).join(' ');
  $('#body').textContent=e.body||'';

  var url=null, att=(e.attachments||[]).filter(function(a){return /\.pdf$/i.test(a.name);})[0];
  if(att) url=att.url||att.name;
  if(!url && e.caseId){ var c=findOne(CASES,function(x){return x.id===e.caseId;}); if(c && c.pdfIds.length){ var p=findOne(PDFS,function(pp){return pp.id===c.pdfIds[0];}); url=p&&p.url; } }
  if(!url && PDFS.length) url=PDFS[0].url;
  if(url){ openPdf(url,{zoom:'page-fit'}); openPdfBig(url,{zoom:'page-fit'}); }

  updateSidePanels(e);
  // è‹¥å¼€å¯è‡ªåŠ¨å›å¤ï¼Œè‡ªåŠ¨è®¡ç®—è‰ç¨¿
  if($('#autoReplyEnable').checked){ doTestAutoReply(); }
}
function extractKeywords(e){
  var p={},add=function(s){if(s&&!p[s])p[s]=1;}; var t=(e.subject+' '+e.body).toLowerCase(); var a=(e.tags&&e.tags.topic)||[]; a.forEach(add);
  ['Applicable Arbitration Rules','Constitution of the Tribunal','Fees and Expenses','Presence and Quorum','Rulings of the Tribunal','Power to Fix Time Limits','Secretary of the Tribunal','Representation of the Parties','Apportionment of Costs','Place of Proceeding','Procedural Language','Routing of Communications','Number of Copies','Sequence of Pleadings','Production of Documents','Submission of Documents','Witness Statements','Examination of Witnesses','Pre-Hearing','Hearings','Records of Hearings','Post-Hearing','Publication']
    .forEach(function(x){ if(t.indexOf(x.toLowerCase().split(' ')[0])>-1) add(x); });
  ['Laycan','PDPR','NOR','SHINC','Demurrage','Beira','Tianjin','Recap','Busan','Manila']
    .forEach(function(x){ if(t.indexOf(x.toLowerCase())>-1) add(x); });
  (e.body.match(/Option\s*\d/ig)||[]).forEach(add);
  return Object.keys(p).slice(0,12);
}

/* ========= PDF å°/å¤§è§†å›¾ ========= */
function openPdf(url,opts){opts=opts||{};currentPdfUrl=url;var ps=[];if(opts.page)ps.push('page='+opts.page);if(opts.search)ps.push('search='+encodeURIComponent(opts.search));if(opts.zoom)ps.push('zoom='+opts.zoom);$('#pdfFrame').src=url+(ps.length?'#'+ps.join('&'):'#zoom=page-fit');}
function openPdfBig(url,opts){opts=opts||{};var ps=[];if(opts.page)ps.push('page='+opts.page);if(opts.search)ps.push('search='+encodeURIComponent(opts.search));if(opts.zoom)ps.push('zoom='+opts.zoom);$('#pdfFrame2').src=url+(ps.length?'#'+ps.join('&'):'#zoom=page-fit');}
function jumpSearch(q){ if(!currentPdfUrl) return; openPdf(currentPdfUrl,{search:q}); $('#pdfFind').value=q; }
function jumpSearchBig(q){ var url=$('#pdfFrame2').src || currentPdfUrl; if(!url) return; var base=url.split('#')[0]; $('#pdfFrame2').src=base+'#search='+encodeURIComponent(q); $('#pdfFind2').value=q; }
function syncPdfToBigView(){ var url=$('#pdfFrame').src || currentPdfUrl || (PDFS[0]&&PDFS[0].url); if(url) $('#pdfFrame2').src=url; }
$('#btnReload').onclick=function(){ openPdf(currentPdfUrl || (PDFS[0]&&PDFS[0].url), {zoom:'page-fit'}); };
$('#filePicker').onchange=function(ev){ var f=ev.target.files[0]; if(!f) return; openPdf(URL.createObjectURL(f),{zoom:'page-fit'}); };
$('#btnPage').onclick=function(){ var p=parseInt($('#pdfPage').value||''); if(p>0) openPdf(currentPdfUrl || (PDFS[0]&&PDFS[0].url), {page:p}); };
$('#btnFind').onclick=function(){ var q=$('#pdfFind').value.trim(); if(q) {jumpSearch(q); jumpSearchBig(q);} };
$('#btnReload2').onclick=function(){ var url=$('#pdfFrame2').src || currentPdfUrl || (PDFS[0]&&PDFS[0].url); $('#pdfFrame2').src=url.split('#')[0]+'#zoom=page-fit'; };
$('#filePicker2').onchange=function(ev){ var f=ev.target.files[0]; if(!f) return; openPdfBig(URL.createObjectURL(f),{zoom:'page-fit'}); };
$('#btnPage2').onclick=function(){ var p=parseInt($('#pdfPage2').value||''); if(p>0){ var base=($('#pdfFrame2').src||'').split('#')[0]; $('#pdfFrame2').src=base+'#page='+(parseInt(p,10)||1); } };
$('#btnFind2').onclick=function(){ var q=$('#pdfFind2').value.trim(); if(q) jumpSearchBig(q); };
$('#btnAddPdf').onclick=function(){ $('#pdfPicker').click(); };
$('#pdfPicker').onchange=function(ev){
  var f=ev.target.files[0]; if(!f) return; var id='pdf_'+Math.random().toString(36).slice(2,8); var url=URL.createObjectURL(f);
  PDFS.unshift({id:id,name:f.name,url:url}); renderShelf(); renderCaseGroup();
};

/* ========= å³ä¾§ï¼šæ‘˜è¦/æŠ½å–/å…³è”åˆåŒ/ç›¸å…³é‚®ä»¶ ========= */
function extractFields(t){
  var f={rate:null,laycan:null,load:null,disc:null,rules:null};
  var m=t.match(/USD[\s$]*([0-9,]+)\s*PDPR/i); if(m) f.rate='USD '+m[1]+' PDPR';
  m=t.match(/Laycan[^0-9]*([0-3]?\d[\-\â€“â€”][0-3]?\d\s*(Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec))/i); if(m) f.laycan=m[1];
  m=t.match(/Load\s*port\s*([A-Za-z][A-Za-z\s\-]+)/i); if(m) f.load=m[1].trim();
  m=t.match(/discharge\s*([A-Za-z][A-Za-z\s\-]+)/i); if(m) f.disc=m[1].trim();
  if(/SHINC/i.test(t)) f.rules='SHINC';
  if(/ICSID/i.test(t)) f.rules=f.rules?f.rules+', ICSID':'ICSID';
  return f;
}
function updateSidePanels(email){
  var caseObj=email.caseId?findOne(CASES,function(c){return c.id===email.caseId;}):null;
  var topics=(email.tags&&email.tags.topic)||[],brief=topics.length?('æœ¬é‚®ä»¶æ¶‰åŠï¼š'+topics.join('ã€')+'ã€‚å¯åœ¨åˆåŒä¸­å¿«é€Ÿæ£€ç´¢å¹¶æ ¸å¯¹ç›¸åº”æ¡æ¬¾ã€‚'):'æ ¹æ®å…³é”®è¯åœ¨ä¸‹æ–¹åˆåŒä¸­å®šä½æ¡æ¬¾å¹¶é«˜äº®ï¼›å¿…è¦æ—¶åˆ‡æ¢æ¡ˆä»¶å…³è”åˆåŒã€‚';
  $('#aisum').textContent=brief;
  var f=extractFields(email.subject+' '+email.body);
  $('#kvCase').textContent=caseObj?caseObj.name:'â€”'; $('#kvRate').textContent=f.rate||'â€”'; $('#kvLaycan').textContent=f.laycan||'â€”'; $('#kvLoad').textContent=f.load||'â€”'; $('#kvDisc').textContent=f.disc||'â€”'; $('#kvRules').textContent=f.rules||'â€”';

  var html=''; if(caseObj){ html+='<div style="margin-bottom:6px"><b>æ¡ˆä»¶ï¼š</b>'+caseObj.name+'</div>';
    if(caseObj.pdfIds.length){
      caseObj.pdfIds.forEach(function(id){ var p=findOne(PDFS,function(x){return x.id===id;}); if(p){ html+='<div class="bookmark"><span>ğŸ“„ '+p.name+'</span><span class="mini-link" data-open="'+p.url+'">æ‰“å¼€</span></div>'; } });
    } else { html+='<div class="pdf-empty">æš‚æ— å…³è”åˆåŒ</div>'; }
  } else { html='æœªå…³è”åˆ°ä»»ä½•æ¡ˆä»¶ã€‚'; }
  $('#relInfo').innerHTML=html; document.querySelectorAll('[data-open]').forEach(function(a){ a.onclick=function(){ openPdf(a.getAttribute('data-open'),{zoom:'page-fit'}); openPdfBig(a.getAttribute('data-open'),{zoom:'page-fit'}); APP.view='pdf'; setHash('pdf'); applyView(); }; });

  $('#opFlag').checked=!!email.flag; $('#opArch').checked=!!email.arch;
  $('#opFlag').onchange=function(){ email.flag=this.checked; setBadgeCounts(); renderList(); };
  $('#opArch').onchange=function(){ email.arch=this.checked; setBadgeCounts(); renderList(); };
  $('#opToCase').onclick=function(){ if(!caseObj){ alert('è¯¥é‚®ä»¶æœªç»‘å®šæ¡ˆä»¶'); return; } email.caseId=caseObj.id; renderList(); setBadgeCounts(); alert('å·²ç§»åŠ¨åˆ°æ¡ˆä»¶ï¼š'+caseObj.name); };

  var list=$('#relEmails'); list.innerHTML=''; var rel=EMAILS.filter(function(e){return e.caseId && caseObj && e.caseId===caseObj.id && e.id!==email.id;}).sort(function(a,b){return new Date(b.date)-new Date(a.date);}).slice(0,5);
  if(!rel.length){ list.textContent='æš‚æ— '; } rel.forEach(function(r){ var d=document.createElement('div'); d.className='rel-item'; d.innerHTML='<div><a href="javascript:void(0)">'+r.subject+'</a><div class="rel-meta">'+fmtDate(r.date)+'</div></div><div class="rel-meta">'+(r.from||'')+'</div>'; d.onclick=function(){ selectMail(r.id); }; list.appendChild(d); });

  renderBookmarks(email.caseId||'GLOBAL');
}

/* ========= PDF ä¹¦ç­¾ ========= */
function bmKey(c){return 'arbimail.bm.'+(c||'GLOBAL');}
function getBookmarks(c){try{var t=localStorage.getItem(bmKey(c));return t?JSON.parse(t):[];}catch(e){return[]}}
function setBookmarks(c,a){try{localStorage.setItem(bmKey(c),JSON.stringify(a));}catch(e){}}
function renderBookmarks(c){var box=$('#bmList'),arr=getBookmarks(c); if(!arr.length){box.textContent='æš‚æ— ä¹¦ç­¾';return;} box.innerHTML=''; arr.forEach(function(b,idx){ var row=document.createElement('div'); row.className='bookmark'; row.innerHTML='<span>'+(b.type==='page'?'é¡µç  ':'å…³é”®å­— ')+b.value+'</span><span><span class="mini-link" data-goto="'+idx+'">è·³è½¬</span> Â· <span class="mini-link" data-del="'+idx+'">åˆ é™¤</span></span>'; box.appendChild(row);}); box.querySelectorAll('[data-goto]').forEach(function(g){ g.onclick=function(){ var a=getBookmarks(c)[parseInt(g.getAttribute('data-goto'),10)]; if(a){ if(a.type==='page'){ openPdf(currentPdfUrl||(PDFS[0]&&PDFS[0].url),{page:parseInt(a.value,10)||1}); openPdfBig($('#pdfFrame2').src.split('#')[0]||currentPdfUrl,{page:parseInt(a.value,10)||1}); } else { jumpSearch(a.value); jumpSearchBig(a.value); } } };}); box.querySelectorAll('[data-del]').forEach(function(g){ g.onclick=function(){ var idx=parseInt(g.getAttribute('data-del'),10); var arr=getBookmarks(c); arr.splice(idx,1); setBookmarks(c,arr); renderBookmarks(c); }; });}
$('#bmAddPage').onclick=function(){ var page = prompt('è¾“å…¥è¦æ·»åŠ çš„é¡µç ï¼š'); if(!page) return; var key=APP.caseId||'GLOBAL'; var arr=getBookmarks(key); arr.push({type:'page',value:page,ts:Date.now()}); setBookmarks(key,arr); renderBookmarks(key); };
$('#bmAddSearch').onclick=function(){ var kw = $('#pdfFind').value.trim() || $('#pdfFind2').value.trim() || prompt('è¾“å…¥å…³é”®å­—ï¼š'); if(!kw) return; var key=APP.caseId||'GLOBAL'; var arr=getBookmarks(key); arr.push({type:'search',value:kw,ts:Date.now()}); setBookmarks(key,arr); renderBookmarks(key); };
$('#bmClear').onclick=function(){ var key=APP.caseId||'GLOBAL'; setBookmarks(key,[]); renderBookmarks(key); };

/* ========= è‡ªåŠ¨å›å¤ï¼ˆä»…ä»£ç†å¾‹å¸ˆï¼‰ ========= */
/* è§„åˆ™ç»“æ„ï¼š
   {id, type:'amount'|'laycan'|'place'|'clause', label, content, min, max, list:[], enabled:true}
   - amount: content å¦‚ "USD PDPR"ï¼Œmin/max ä¸ºæ•°å€¼ï¼ˆä¾‹å¦‚ 50000,60000ï¼‰
   - laycan: content æ–‡å­—ï¼Œmin/max ä¸ºè£…æœŸæ—¥ï¼ˆæ•°å­—ï¼Œå¦‚19,25ï¼‰
   - place:  content è¯´æ˜ï¼Œlist=["Beira","Tianjin"]
   - clause: content å…³é”®å­ä¸²ï¼ˆå¦‚ "Option 2" / "Â§23"ï¼‰ï¼Œlist å¯ç©º
*/
function rulesKey(caseId){ return 'arbimail.autoreply.rules.'+caseId; }
function enableKey(caseId){ return 'arbimail.autoreply.enable.'+caseId; }
function loadRules(caseId){
  try{ var t=localStorage.getItem(rulesKey(caseId)); if(t) return JSON.parse(t); }catch(e){}
  // é»˜è®¤ç»™ä¸‰æ¡ç¤ºä¾‹
  return [
    {id:rid(), type:'amount', label:'é‡‘é¢ï¼ˆUSD/PDPRï¼‰', content:'USD PDPR', min:52000, max:60000, list:[], enabled:true},
    {id:rid(), type:'laycan', label:'Laycanï¼ˆè£…æœŸï¼‰', content:'è£…æœŸæ—¥åŒºé—´', min:19, max:27, list:[], enabled:true},
    {id:rid(), type:'place',  label:'æ¸¯å£ï¼ˆè£…/å¸ï¼‰', content:'è£…å¸æ¸¯å…è®¸åˆ—è¡¨', list:['Beira','Tianjin','Busan','Manila'], enabled:false}
  ];
}
function saveRules(caseId,arr){ try{ localStorage.setItem(rulesKey(caseId), JSON.stringify(arr)); }catch(e){} }
function rid(){ return Math.random().toString(36).slice(2,8); }

function renderAutoReplyPanel(){
  var sel=$('#arCaseSelect'); sel.innerHTML=CASES.map(function(c){return '<option value="'+c.id+'">'+c.name+'</option>';}).join('');
  sel.value=APP.caseId;

  $('#autoReplyEnable').checked = localStorage.getItem(enableKey(sel.value))==='1';
  $('#autoReplyEnable').onchange=function(){ localStorage.setItem(enableKey(sel.value), this.checked?'1':'0'); };

  var data = loadRules(sel.value);
  drawRules(data);

  sel.onchange=function(){
    localStorage.setItem('arbimail.case', this.value);
    APP.caseId=this.value; $('#caseSelect').value=this.value;
    var d=loadRules(this.value); drawRules(d);
  };

  $('#btnAddRule').onclick=function(){
    var arr=loadRules(sel.value);
    arr.unshift({id:rid(), type:'amount', label:'é‡‘é¢ï¼ˆUSD/PDPRï¼‰', content:'USD PDPR', min:50000, max:60000, list:[], enabled:true});
    saveRules(sel.value,arr); drawRules(arr);
  };
  $('#btnSaveRules').onclick=function(){ alert('è§„åˆ™å·²ä¿å­˜åˆ°æœ¬åœ°ï¼ˆæŒ‰æ¡ˆä»¶ç‹¬ç«‹å­˜å‚¨ï¼‰ã€‚'); };
  $('#btnResetRules').onclick=function(){ localStorage.removeItem(rulesKey(sel.value)); drawRules(loadRules(sel.value)); };
  $('#btnCopyReply').onclick=function(){ navigator.clipboard.writeText($('#replyDraft').value||''); };
  $('#btnTestReply').onclick=doTestAutoReply;
}

function drawRules(arr){
  var box=$('#ruleList'); box.innerHTML='';
  arr.forEach(function(r){
    var wrap=document.createElement('div'); wrap.className='rule'; wrap.setAttribute('data-id',r.id);
    wrap.innerHTML = ''+
      '<div class="rule-top">'+
        '<div class="rule-title"><label class="switch" style="gap:6px"><input type="checkbox" class="r-enable"> å¯ç”¨</label> Â· <select class="r-type select sm"><option value="amount">é‡‘é¢(USD/PDPR)</option><option value="laycan">Laycan</option><option value="place">åœ°ç‚¹</option><option value="clause">æ¡æ¬¾</option></select></div>'+
        '<button class="mini" data-act="del">åˆ é™¤</button>'+
      '</div>'+
      '<div class="rule-row"><label>å­—æ®µåç§° / å†…å®¹è¯´æ˜</label><input class="r-label" placeholder="ä¾‹å¦‚ï¼šé‡‘é¢ï¼ˆUSD/PDPRï¼‰" /></div>'+
      '<div class="rule-row r-content"><label>å­—æ®µå†…å®¹</label><input class="r-content-input" placeholder="å¦‚ï¼šUSD PDPR / Option 2 / Â§23" /></div>'+
      // èŒƒå›´æˆ–åˆ—è¡¨
      (r.type==='place'
        ? ('<div class="rule-row"><label>å…è®¸åˆ—è¡¨ï¼ˆç”¨è‹±æ–‡é€—å·åˆ†éš”ï¼‰</label><input class="r-list" placeholder="Beira,Tianjin,Busan" /></div>')
        : ('<div class="rule-row"><label>åŒºé—´èŒƒå›´</label><div class="rule-range"><input class="r-min" placeholder="ä¸‹é™ï¼ˆé‡‘é¢ï¼š50000ï¼›è£…æœŸæ—¥ï¼š19ï¼‰"><input class="r-max" placeholder="ä¸Šé™ï¼ˆé‡‘é¢ï¼š60000ï¼›è£…æœŸæ—¥ï¼š27ï¼‰"></div></div>')
      )+
      '';
    // æŒ‚è½½
    box.appendChild(wrap);

    // åˆå€¼
    wrap.querySelector('.r-enable').checked=!!r.enabled;
    wrap.querySelector('.r-type').value=r.type;
    wrap.querySelector('.r-label').value=r.label||'';
    wrap.querySelector('.r-content-input').value=r.content||'';
    var listEl=wrap.querySelector('.r-list');
    if(listEl) listEl.value=(r.list||[]).join(',');
    var minEl=wrap.querySelector('.r-min'), maxEl=wrap.querySelector('.r-max');
    if(minEl) minEl.value=(r.min!=null?r.min:'');
    if(maxEl) maxEl.value=(r.max!=null?r.max:'');

    // äº‹ä»¶ï¼šåˆ é™¤
    wrap.querySelector('[data-act="del"]').onclick=function(){
      var all=loadRules($('#arCaseSelect').value).filter(function(x){return x.id!==r.id;});
      saveRules($('#arCaseSelect').value,all); drawRules(all);
    };
    // äº‹ä»¶ï¼šç±»å‹åˆ‡æ¢ -> é‡æ–°æ¸²æŸ“è¯¥æ¡
    wrap.querySelector('.r-type').onchange=function(){
      r.type=this.value;
      // ä¿å­˜ç±»å‹åé‡ç»˜å…¨éƒ¨ï¼ˆç®€å•å¤„ç†ï¼‰
      var all=collectRulesFromUI(); all=all.map(function(x){ if(x.id===r.id) x.type=r.type; return x; });
      saveRules($('#arCaseSelect').value,all); drawRules(all);
    };
    // æŒä¹…åŒ–ï¼ˆç®€åŒ–ï¼šå¤±ç„¦ä¿å­˜ï¼‰
    function persist(){ saveRules($('#arCaseSelect').value, collectRulesFromUI()); }
    wrap.querySelectorAll('input,textarea,select').forEach(function(el){
      el.onblur=persist; el.onchange=persist;
    });
  });
}
function collectRulesFromUI(){
  var arr=[]; document.querySelectorAll('#ruleList .rule').forEach(function(wrap){
    var type=wrap.querySelector('.r-type').value;
    var r={id:wrap.getAttribute('data-id'), type:type, enabled:wrap.querySelector('.r-enable').checked,
           label:wrap.querySelector('.r-label').value.trim(),
           content:wrap.querySelector('.r-content-input').value.trim(),
           min:null,max:null,list:[]};
    var minEl=wrap.querySelector('.r-min'), maxEl=wrap.querySelector('.r-max'), listEl=wrap.querySelector('.r-list');
    if(minEl) r.min = parseFloat(minEl.value)||null;
    if(maxEl) r.max = parseFloat(maxEl.value)||null;
    if(listEl) r.list = listEl.value.split(',').map(function(s){return s.trim();}).filter(Boolean);
    arr.push(r);
  });
  return arr;
}

function doTestAutoReply(){
  if(APP.role!=='counsel'){ alert('ä»…ä»£ç†å¾‹å¸ˆå¯ç”¨'); return; }
  if(!state.selected){ alert('è¯·å…ˆé€‰æ‹©ä¸€å°é‚®ä»¶'); return; }
  var e=findOne(EMAILS,function(x){return x.id===state.selected;}); if(!e) return;
  var rules=collectRulesFromUI(); var res = evaluateEmail(e, rules);
  $('#replyDraft').value = buildReplyDraft(e,res);
}

function evaluateEmail(email, rules){
  var text=(email.subject||'')+'\n'+(email.body||''); var okAll=true, fails=[], hits={};
  // ç®€å•æŠ½å–
  var m=text.match(/USD[\s$]*([\d,]+)\s*PDPR/i); var price = m? parseFloat(m[1].replace(/,/g,'')) : null;
  var l=text.match(/Laycan[^0-9]*([0-3]?\d)\s*[\-\â€“â€”]\s*([0-3]?\d)/i); var layMin = l?parseInt(l[1],10):null, layMax = l?parseInt(l[2],10):null;
  var places=['Beira','Tianjin','Busan','Manila','Qingdao','Shanghai'].filter(function(p){return new RegExp('\\b'+p+'\\b','i').test(text);});

  rules.filter(function(r){return r.enabled;}).forEach(function(r){
    if(r.type==='amount'){
      if(price==null){ okAll=false; fails.push('é‡‘é¢æœªè¯†åˆ«'); }
      else{
        if(r.min!=null && price<r.min){ okAll=false; fails.push('é‡‘é¢ä½äºä¸‹é™'); }
        if(r.max!=null && price>r.max){ okAll=false; fails.push('é‡‘é¢é«˜äºä¸Šé™'); }
        hits.amount=price;
      }
    }else if(r.type==='laycan'){
      if(layMin==null||layMax==null){ okAll=false; fails.push('Laycan æœªè¯†åˆ«'); }
      else{
        if(r.min!=null && layMin<r.min){ okAll=false; fails.push('Laycan å¼€å§‹æ—¥ä½äºä¸‹é™'); }
        if(r.max!=null && layMax>r.max){ okAll=false; fails.push('Laycan ç»“æŸæ—¥é«˜äºä¸Šé™'); }
        hits.laycan=layMin+'â€“'+layMax;
      }
    }else if(r.type==='place'){
      if(!r.list || !r.list.length){ /* æ— åˆ—è¡¨åˆ™è·³è¿‡ */ }
      var hit = r.list.some(function(p){ return new RegExp('\\b'+p+'\\b','i').test(text); });
      if(!hit){ okAll=false; fails.push('åœ°ç‚¹ä¸åœ¨å…è®¸åˆ—è¡¨'); } else { hits.place=(places.join(', ')||r.list.join(',')); }
    }else if(r.type==='clause'){
      if(r.content && !new RegExp(r.content.replace(/[.*+?^${}()|[\]\\]/g,'\\$&'), 'i').test(text)){
        okAll=false; fails.push('æœªåŒ…å«æ¡æ¬¾ï¼š'+r.content);
      } else { hits.clause=r.content||''; }
    }
  });
  return {ok:okAll, fails:fails, hits:hits, price:price, lay: (layMin&&layMax)?(layMin+'â€“'+layMax):null, places:places};
}
function buildReplyDraft(email, res){
  var head = res.ok ? 'åŒæ„ / Agree' : 'ä¸åŒæ„ / Not agreeable';
  var lines = [
    'Subject: Re: '+(email.subject||''),
    '',
    (res.ok?'æˆ‘æ–¹åŒæ„è´µæ–¹åœ¨é‚®ä»¶æ‰€è¿°æ¡ä»¶å†…çš„æŠ¥ä»·/æ¡æ¬¾ï¼Œå…·ä½“å¦‚ä¸‹ï¼š'
           :'ç»æ ¸å¯¹ï¼Œä»¥ä¸‹è¦ç´ æœªæ»¡è¶³æˆ‘æ–¹é¢„è®¾é˜ˆå€¼ï¼Œæš‚ä¸äºˆåŒæ„ï¼š'),
    ''
  ];
  if(res.ok){
    if(res.price!=null) lines.push('â€¢ ä»·æ ¼ï¼šUSD '+res.price+' PDPR');
    if(res.lay) lines.push('â€¢ Laycanï¼š'+res.lay);
    if(res.places && res.places.length) lines.push('â€¢ æ¶‰åŠæ¸¯å£ï¼š'+res.places.join(', '));
    if(res.hits && res.hits.clause) lines.push('â€¢ æ¡æ¬¾ï¼šåŒ…å« '+res.hits.clause);
  }else{
    res.fails.forEach(function(f){ lines.push('â€¢ '+f); });
  }
  lines.push('', 'æ­¤è‡´');
  return lines.join('\n');
}

/* ========= åˆå§‹åŒ– ========= */
function init(){
  initTopBar(); applyRole(); applyView();
  renderMailboxes(); renderCaseGroup(); renderShelf();
  // é‚®ä»¶åˆ—è¡¨é»˜è®¤æ˜¾ç¤ºå½“å‰æ¡ˆ
  state.scope={type:'case',id:APP.caseId}; renderList();

  // æ¸²æŸ“å³ä¾§è‡ªåŠ¨å›å¤é¢æ¿ï¼ˆä»…ä»£ç†å¾‹å¸ˆï¼‰
  renderAutoReplyPanel();

  // é»˜è®¤é€‰ç¬¬ä¸€å°è¯¥æ¡ˆé‚®ä»¶
  var first = EMAILS.find(function(e){return e.caseId===APP.caseId;}) || EMAILS[0];
  if(first) selectMail(first.id);
}
function refreshForCase(){
  state.scope={type:'case',id:APP.caseId};
  renderList(); renderAutoReplyPanel();
}
init();
</script>
</body>
</html>
