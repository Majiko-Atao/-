<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ArbiMail ¬∑ ÈÇÆ‰ª∂</title>
<style>
  :root{
    --ink:#0f172a; --muted:#667085; --line:#e6edf5; --bg:#f6f9fc; --brand:#2f6efb;
    --left:300px; --side:360px; --gut:8px;
    --shadow:0 10px 28px rgba(15,23,42,.08);
  }
  *{box-sizing:border-box} html,body{height:100%}
  body{margin:0;font:14px/1.55 -apple-system,BlinkMacSystemFont,"Segoe UI","PingFang SC",Arial,sans-serif;color:var(--ink);background:#f6f9fc}

  /* È°∂ÈÉ® */
  .topbar{height:54px;display:flex;align-items:center;gap:12px;padding:0 12px;background:#fff;border-bottom:1px solid var(--line)}
  .brand{font-weight:800}
  .seg{display:flex;border:1px solid var(--line);border-radius:10px;overflow:hidden;background:#fff}
  .seg button{height:32px;border:0;background:transparent;padding:0 14px;cursor:pointer}
  .seg button.on{background:#eef2ff;color:#1f2a44;font-weight:700}
  .search-global{flex:1;display:flex;gap:8px;align-items:center;background:#f7f9fd;border:1px solid var(--line);border-radius:10px;padding:6px 10px;margin-left:auto}
  .search-global input{flex:1;border:0;background:transparent;outline:none}
  .tiny{border:1px solid var(--line);border-radius:8px;height:28px;padding:0 10px;background:#fff;cursor:pointer;font-size:12px}
  .tiny.primary{background:#2f6efb;color:#fff;border-color:#2f6efb}

  /* ‰∏âÊ†èÂ∏ÉÂ±Ä */
  .layout{height:calc(100vh - 54px);display:grid;grid-template-columns:var(--left) var(--gut) 1fr var(--gut) var(--side)}
  .col{min-width:0;overflow:auto}

  /* Â∑¶‰æßÂàÜÁªÑ */
  .left{background:#fff;border-right:1px solid var(--line);padding:12px 10px}
  .group{margin-bottom:10px}
  .g-head{display:flex;align-items:center;justify-content:space-between;padding:8px;border-radius:10px;font-weight:700;background:#f7fafc;border:1px solid var(--line)}
  .g-title{display:flex;align-items:center;gap:8px}
  .g-tools{display:flex;gap:8px;align-items:center}
  .g-body{margin-top:6px;border-left:2px solid #eaf1fb;padding-left:8px;display:flex;flex-direction:column;gap:6px}
  .item{display:flex;justify-content:space-between;align-items:center;padding:6px 8px;border-radius:10px;cursor:pointer}
  .item:hover{background:#f8fbff}
  .name{white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .subctrl{display:flex;align-items:center;gap:8px}
  .badge{min-width:18px;height:18px;padding:0 6px;border-radius:999px;background:#eef2ff;color:#334155;font-size:12px;display:inline-flex;align-items:center;justify-content:center}
  .sublist{display:flex;flex-direction:column;gap:6px;margin-left:14px}
  .pdf-list{display:flex;flex-direction:column;gap:6px}
  .pdf-row{display:grid;grid-template-columns:20px 1fr auto auto;align-items:center;gap:8px;padding:6px 8px;border:1px solid var(--line);border-radius:10px;background:#fff}
  .pdf-ico{text-align:center}.pdf-name{white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .link-row{display:grid;grid-template-columns:20px 1fr auto;align-items:center;gap:8px;padding:6px 8px;border:1px dashed #e5eaf5;border-radius:10px;background:#fbfdff}
  .pdf-empty{padding:8px;border:1px dashed #e5eaf5;border-radius:10px;background:#fbfdff;color:#94a3b8}

  /* ‰∏≠ÂàóÔºöÂàóË°® + ÈòÖËØªÂå∫ */
  .main{padding:12px}
  .flex{display:flex;gap:12px;align-items:flex-start}
  .list-wrap{flex:0 0 520px;min-width:420px;display:flex;flex-direction:column;height:100%;background:#fff;border:1px solid var(--line);border-radius:12px;overflow:hidden}
  .list{overflow:auto}
  .section-hd{position:sticky;top:0;background:#fff;padding:6px 10px;color:#7a869f;font-size:12px;border-top:1px solid var(--line);border-bottom:1px solid var(--line)}
  .row-mail{display:grid;grid-template-columns:10px 1fr auto;gap:8px;align-items:center;padding:9px 10px;border-bottom:1px solid var(--line);cursor:pointer}
  .row-mail:hover{background:#f8fbff}.dot{width:8px;height:8px;border-radius:50%;background:#d1d9e8;margin-left:2px}
  .subject{font-weight:650;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}
  .meta{color:#6b7280;font-size:12px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

  .paper{flex:1 1 auto;min-width:420px;background:#fff;border:1px solid var(--line);box-shadow:var(--shadow);border-radius:12px;padding:0}
  .mailbar{display:flex;gap:6px;flex-wrap:wrap;align-items:center;padding:8px;border-bottom:1px solid var(--line);background:#fbfbfe;border-top-left-radius:12px;border-top-right-radius:12px}
  .mb-btn{height:28px;padding:0 10px;border:1px solid var(--line);border-radius:8px;background:#fff;cursor:pointer;font-size:12px}
  .mb-btn:hover{background:#f5f7ff}
  .header{padding:10px 12px;border-bottom:1px solid var(--line)}
  .h-subject{font-weight:800;font-size:18px;margin-bottom:6px}
  .h-line{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin:6px 0}
  .pill-addr{background:#fff6d7;border:1px solid #f0e3b1;padding:0 8px;height:22px;display:inline-flex;align-items:center;border-radius:999px;font-size:12px}
  .r-grid{display:grid;grid-template-columns:360px 1fr;gap:14px;padding:12px}
  .kp{border:1px dashed #dbeafe;background:#f8fbff;border-radius:10px;padding:10px}
  .info{border:1px solid var(--line);border-radius:10px;padding:10px}
  .kvline{display:flex;flex-wrap:wrap;gap:8px;margin-top:6px}
  .attachments{grid-column:1/3;display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
  .file{border:1px solid var(--line);border-radius:8px;padding:6px 10px;background:#fff}
  .body{grid-column:1/3;white-space:pre-wrap;margin-top:6px;line-height:1.8}
  .pdf-card{grid-column:1/3;margin-top:12px;border:1px solid var(--line);border-radius:12px;box-shadow:var(--shadow);background:#fff}
  .pdf-toolbar{display:flex;gap:8px;align-items:center;justify-content:space-between;padding:8px 10px;border-bottom:1px solid var(--line);background:#fbfdff;border-top-left-radius:12px;border-top-right-radius:12px}
  .pdf-tools{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .pdf-wrap{height:56vh;overflow:hidden;border-bottom-left-radius:12px;border-bottom-right-radius:12px}
  .pdf-frame{width:100%;height:100%;border:0;display:block;background:#f6f9fc}

  /* Âè≥‰æßÊ†è */
  .side{background:#fff;border-left:1px solid var(--line);padding:10px}
  .card{background:#fff;border:1px solid var(--line);border-radius:12px;box-shadow:var(--shadow);padding:12px;margin-bottom:12px}
  .card h4{margin:0 0 8px}
  .kvtable{width:100%;border-collapse:collapse}
  .kvtable td{padding:6px 4px;border-bottom:1px dashed #eef2f7;font-size:13px}
  .op-group{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .switch{display:inline-flex;align-items:center;gap:6px}
  .switch input{accent-color:#2f6efb}
  .bookmark{display:flex;justify-content:space-between;align-items:center;padding:6px 8px;border-radius:8px}
  .bookmark:hover{background:#f7faff}
  .mini-link{font-size:12px;color:#2f6efb;cursor:pointer}
  .rel-list{display:flex;flex-direction:column;gap:8px}
  .rel-item{display:flex;justify-content:space-between;gap:8px}
  .rel-item a{color:#0f172a;text-decoration:none}
  .rel-meta{color:#64748b;font-size:12px}

  /* Ëá™Âä®ÂõûÂ§çËßÑÂàôÂç°Áâá */
  .rule{border:1px dashed #e5eaf5;border-radius:10px;padding:10px;margin-bottom:10px}
  .rule-top{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px}
  .rule-title{font-weight:700}
  .rule-row{display:flex;flex-direction:column;gap:6px;margin-top:6px}
  .rule-row label{font-size:12px;color:#64748b}
  .rule-row input,.rule-row select{border:1px solid var(--line);border-radius:8px;padding:6px 10px;height:32px}
  .rule-range{display:grid;grid-template-columns:1fr 1fr;gap:8px}
  .mono{font-family:ui-monospace, Menlo, Consolas, monospace;white-space:pre-wrap}

  /* Êó∂Èó¥ËΩ¥ */
  .timeline{position:relative;padding-left:16px}
  .timeline::before{content:'';position:absolute;left:7px;top:0;bottom:0;width:2px;background:#e5eaf5}
  .tl-item{position:relative;margin:12px 0;padding-left:10px}
  .tl-item::before{content:'';position:absolute;left:3px;top:8px;width:8px;height:8px;border-radius:50%;background:#2f6efb}
  .tl-card{border:1px solid var(--line);border-radius:10px;padding:8px;background:#fff}
  .tl-title{font-weight:700;margin-bottom:4px}
  .tl-meta{font-size:12px;color:#64748b;margin-bottom:4px}
  .tl-body{font-size:13px;color:#334155;white-space:pre-wrap}

  @media (max-width:1360px){
    :root{--side:0px}
    #sideCol{display:none}
    .layout{grid-template-columns:var(--left) var(--gut) 1fr}
  }
</style>
</head>
<body>
  <!-- È°∂ÈÉ®ÔºöÂäüËÉΩÈîÆ + ÂÖ®Â±ÄÊêúÁ¥¢ + AIËá™Âä®ÂàÜÁ±ªÊåâÈíÆ -->
  <div class="topbar">
    <div class="brand">ArbiMail ¬∑ ÈÇÆ‰ª∂</div>
    <div class="seg" title="‰ªÖÂ±ïÁ§∫Ôºå‰∏çË∑≥ËΩ¨">
      <button>Â∑•‰ΩúÂè∞</button>
      <button class="on">ÈÇÆ‰ª∂</button>
    </div>
    <button class="tiny" id="btnAutoClass" title="AI Ëá™Âä®ÂàÜÁ±ªÔºàÊºîÁ§∫ÊåâÈíÆÔºâ">AI Ëá™Âä®ÂàÜÁ±ª</button>
    <div class="search-global">
      <span>üîé</span>
      <input id="qGlobal" placeholder="ÂÖ®Â±ÄÊêúÁ¥¢Ôºà‰∏ªÈ¢ò/Ê≠£Êñá/Âèë‰ª∂‰∫∫/Êî∂‰ª∂‰∫∫Ôºâ">
    </div>
  </div>

  <div class="layout">
    <!-- Â∑¶ÔºöÈÇÆ‰ª∂ÁÆ± + ÊàëË¥üË¥£ÁöÑÊ≥ïÂæã‰∫ãÂä°/‰ª≤Ë£ÅÊ°à‰ª∂ + ÂêàÂêåÊñá‰ª∂Â§π -->
    <div class="col left">
      <!-- ÈÇÆ‰ª∂ÁÆ± -->
      <div class="group">
        <div class="g-head"><div class="g-title">ÈÇÆ‰ª∂ÁÆ±</div></div>
        <div class="g-body" id="mbxBody"></div>
      </div>

      <!-- ÊàëË¥üË¥£ÁöÑÊ≥ïÂæã‰∫ãÂä° -->
      <div class="group">
        <div class="g-head">
          <div class="g-title">ÊàëË¥üË¥£ÁöÑÊ≥ïÂæã‰∫ãÂä°</div>
          <div class="g-tools"><button class="tiny" id="btnImportLegal">ÂØºÂÖ•Ê°à‰ª∂</button></div>
        </div>
        <div class="g-body" id="legalBody"></div>
      </div>

      <!-- ÊàëË¥üË¥£ÁöÑ‰ª≤Ë£ÅÊ°à‰ª∂ -->
      <div class="group">
        <div class="g-head">
          <div class="g-title">ÊàëË¥üË¥£ÁöÑ‰ª≤Ë£ÅÊ°à‰ª∂</div>
          <div class="g-tools"><button class="tiny" id="btnImportArb">Â§ñÈÉ®ÂØºÂÖ•</button></div>
        </div>
        <div class="g-body" id="arbBody"></div>
      </div>

      <!-- ÂêàÂêåÊñá‰ª∂Â§π -->
      <div class="group">
        <div class="g-head">
          <div class="g-title">ÂêàÂêåÊñá‰ª∂Â§π</div>
          <div class="g-tools">
            <button class="tiny" id="btnAddPdf">Ôºã Ê∑ªÂä†PDF</button>
            <input id="pdfPicker" type="file" accept="application/pdf" style="display:none">
          </div>
        </div>
        <div class="g-body" id="shelfBody"></div>
      </div>
    </div>

    <div></div><!-- gutter -->

    <!-- ‰∏≠ÔºöÂàóË°® + ÈòÖËØª -->
    <div class="col main">
      <div class="flex">
        <!-- ÂàóË°® -->
        <div class="list-wrap">
          <div id="list" class="list"></div>
        </div>

        <!-- ÈòÖËØª -->
        <article class="paper">
          <div class="mailbar">
            <button class="mb-btn">ÂõûÂ§ç</button>
            <button class="mb-btn">ÂõûÂ§çÂÖ®ÈÉ®</button>
            <button class="mb-btn">ËΩ¨Âèë</button>
          </div>
          <div class="header" id="mailHeader">
            <div class="h-subject" id="subj">‚Äî</div>
            <div class="h-line"><div style="width:56px;font-weight:700;color:#475569">Âèë‰ª∂‰∫∫</div><div id="hFrom"></div></div>
            <div class="h-line"><div style="width:56px;font-weight:700;color:#475569">Êî∂‰ª∂‰∫∫</div><div id="hTo"></div></div>
            <div class="h-line" id="ccLine" style="display:none;"><div style="width:56px;font-weight:700;color:#475569">ÊäÑÈÄÅ</div><div id="hCc"></div></div>
            <div class="h-line"><div style="width:56px;font-weight:700;color:#475569">Êó∂Èó¥</div><div id="hTime"></div></div>
          </div>
          <section class="r-grid">
            <div class="kp"><div style="font-weight:700;margin-bottom:6px">ÂÖ≥ÈîÆË¶ÅÁÇπ</div><div id="kp"></div></div>
            <div class="info">
              <div style="font-weight:700;margin-bottom:6px">ÂÖ≥ÈîÆËØç</div>
              <div class="kvline" id="chips"></div>
            </div>
            <div class="attachments" id="attach"></div>
            <div class="body" id="body"></div>

            <div class="pdf-card">
              <div class="pdf-toolbar">
                <div class="pdf-tools">
                  <button class="tiny" id="btnReload">Âà∑Êñ∞</button>
                  <label class="tiny" style="display:flex;align-items:center;gap:6px;cursor:pointer">ÈÄâÊã©PDF
                    <input type="file" id="filePickerMail" accept="application/pdf" style="display:none">
                  </label>
                </div>
                <div>
                  <input id="pdfPage" placeholder="È°µÁ†Å‚Ä¶" style="height:30px;border:1px solid var(--line);border-radius:8px;padding:0 10px;width:90px">
                  <button class="tiny" id="btnPage">Ë∑≥ËΩ¨</button>
                  <input id="pdfFind" placeholder="Âú®PDF‰∏≠Êü•Êâæ‚Ä¶" style="height:30px;border:1px solid var(--line);border-radius:8px;padding:0 10px;width:220px;margin-left:8px">
                  <button class="tiny" id="btnFind">Êü•Êâæ</button>
                </div>
              </div>
              <div class="pdf-wrap"><iframe id="pdfFrame" class="pdf-frame" title="ÂêàÂêåPDF"></iframe></div>
            </div>
          </section>
        </article>
      </div>
    </div>

    <div></div><!-- gutter -->

    <!-- Âè≥ÔºöÂäüËÉΩÂå∫ -->
    <div class="col side" id="sideCol">
      <div class="card">
        <h4>AI ÊëòË¶Å</h4>
        <div id="aisum" style="color:#475569">ÈÄâÊã©‰∏ÄÂ∞ÅÈÇÆ‰ª∂Êü•Áúã„ÄÇ</div>
      </div>

      <div class="card">
        <h4>Êô∫ËÉΩÊäΩÂèñÂ≠óÊÆµ</h4>
        <table class="kvtable">
          <tbody>
            <tr><td style="width:84px;color:#64748b">Ê°à‰ª∂</td><td id="kvCase">‚Äî</td></tr>
            <tr><td style="color:#64748b">Ë¥πÁéá/‰ª∑Ê†º</td><td id="kvRate">‚Äî</td></tr>
            <tr><td style="color:#64748b">Laycan</td><td id="kvLaycan">‚Äî</td></tr>
            <tr><td style="color:#64748b">Ë£ÖÊ∏Ø</td><td id="kvLoad">‚Äî</td></tr>
            <tr><td style="color:#64748b">Âç∏Ê∏Ø</td><td id="kvDisc">‚Äî</td></tr>
            <tr><td style="color:#64748b">ËßÑÂàô</td><td id="kvRules">‚Äî</td></tr>
          </tbody>
        </table>
      </div>

      <!-- Ëá™Âä®ÂõûÂ§çÔºàÊó∂Èó¥Á™óÂú®ËøôÈáåÔºå‰∏çÂú®ËßÑÂàôÈáåÔºâ -->
      <div class="card">
        <h4 style="display:flex;justify-content:space-between;align-items:center">
          <span>Ëá™Âä®ÂõûÂ§çÔºàÈòàÂÄºÁ≠ñÁï•Ôºâ</span>
          <label class="switch"><input type="checkbox" id="autoReplyEnable"> ÂêØÁî®</label>
        </h4>

        <div class="op-group" style="margin:6px 0 8px">
          <label>Â∫îÁî®Ê°à‰ª∂</label>
          <select id="arCaseSelect" class="tiny" style="height:28px"></select>

          <label>Ëá™Âä®ÂõûÂ§çÊó∂Èó¥Á™ó</label>
          <select id="arTimeStart" class="tiny"></select>
          <span>Ëá≥</span>
          <select id="arTimeEnd" class="tiny"></select>
          <button class="tiny" id="btnSaveTime">‰øùÂ≠ò</button>

          <button class="tiny" id="btnTestReply">ÊµãËØïÂΩìÂâçÈÇÆ‰ª∂</button>
        </div>

        <div id="ruleList"></div>
        <div class="op-group" style="margin:6px 0">
          <button class="tiny" id="btnAddRule">Ôºã Ê∑ªÂä†Â≠óÊÆµ</button>
          <button class="tiny" id="btnSaveRules">‰øùÂ≠ò</button>
          <button class="tiny" id="btnResetRules">ÈáçÁΩÆ</button>
        </div>

        <textarea id="replyDraft" class="mono" placeholder="Ëá™Âä®ÁîüÊàêÁöÑÂõûÂ§çËçâÁ®ø‚Ä¶" style="width:100%;height:120px;margin-top:8px;"></textarea>
        <div class="op-group" style="margin-top:6px">
          <button class="tiny primary" id="btnCopyReply">Â§çÂà∂ËçâÁ®ø</button>
        </div>
      </div>

      <div class="card">
        <h4>ÂÖ≥ËÅî‰ø°ÊÅØ</h4>
        <div id="relInfo" style="color:#475569">‚Äî</div>
      </div>

      <div class="card">
        <h4>Âø´ÈÄüÊìç‰Ωú</h4>
        <div class="op-group">
          <label class="switch"><input type="checkbox" id="opFlag"> Á∫¢Êóó</label>
          <label class="switch"><input type="checkbox" id="opArch"> ÂΩíÊ°£</label>
          <button class="tiny" id="opToCase">ÁßªËá≥ÂΩìÂâçÊ°à‰ª∂</button>
        </div>
      </div>

      <div class="card">
        <h4>Áõ∏ÂÖ≥ÈÇÆ‰ª∂</h4>
        <div class="rel-list" id="relEmails">‚Äî</div>
      </div>

      <div class="card">
        <h4>PDF ‰π¶Á≠æ</h4>
        <div class="op-group" style="margin-bottom:8px">
          <button class="tiny" id="bmAddPage">Ê∑ªÂä†È°µÁ†Å‰π¶Á≠æ</button>
          <button class="tiny" id="bmAddSearch">Ê∑ªÂä†ÂÖ≥ÈîÆÂ≠ó‰π¶Á≠æ</button>
          <button class="tiny" id="bmClear">Ê∏ÖÁ©∫</button>
        </div>
        <div id="bmList">ÊöÇÊó†‰π¶Á≠æ</div>
      </div>

      <!-- Áõ¥Êé•Â±ïÁ§∫ÁöÑÊ°à‰ª∂Êó∂Èó¥ËΩ¥ -->
      <div class="card">
        <h4>Ê°à‰ª∂Êó∂Èó¥ËΩ¥</h4>
        <div id="caseTimeline" class="timeline">‚Äî</div>
      </div>
    </div>
  </div>

<script>
/* ========= Êï∞ÊçÆ ========= */
var PDFS=[{id:'pdfA',name:'Test Contract (ClickDimensions)',url:'https://www.clickdimensions.com/links/TestPDFfile.pdf'},
          {id:'pdfB',name:'W3C Dummy PDF',url:'https://www.w3.org/WAI/ER/tests/xhtml/testfiles/resources/pdf/dummy.pdf'},
          {id:'pdfC',name:'Mozilla Sample (PDF.js)',url:'https://mozilla.github.io/pdf.js/web/compressed.tracemonkey-pldi-09.pdf'}];

var MAILBOXES=[{id:'inbox',name:'Êî∂‰ª∂ÁÆ±'},{id:'sent',name:'Â∑≤ÂèëÈÄÅ'},{id:'flag',name:'Á∫¢ÊóóÈÇÆ‰ª∂'},{id:'arch',name:'Â∑≤ÂΩíÊ°£'},{id:'unfiled',name:'Êú™ÂΩíÊ°£'}];

var CASES=[
  {id:'C-001',cat:'arb',  name:'[ICSID] Procedural Order No.1 ÂØπÈΩê',color:'#3b82f6',pdfIds:['pdfC']},
  {id:'C-002',cat:'legal',name:'MV Ocean Star ‚Äî Main Terms',color:'#10b981',pdfIds:['pdfA']},
  {id:'C-003',cat:'legal',name:'MV Silver Wave ‚Äî Spot Voyage',color:'#f59e0b',pdfIds:[]}
];

var EMAILS=[
  {id:'e1',folder:'inbox',flag:true,arch:false,subject:'Proposed edits ‚Äî Quorum & Procedural Language',from:'claimant.counsel@example.com',to:['respondent.counsel@example.com'],cc:[],date:'2025-08-12 10:30',
   body:'We propose: (i) Option 1 (two-person quorum) in ¬ß4; (ii) Procedural Language: English only (Option 1) in ¬ß11; (iii) transcript be available in real-time; (iv) Production of Documents to follow ICSID Rules 33‚Äì36.',
   attachments:[{name:'TestPDFfile.pdf',url:'https://www.clickdimensions.com/links/TestPDFfile.pdf'}],
   tags:{topic:['Quorum','Procedural Language','Hearings','Production of Documents']},caseId:'C-001'},
  {id:'e2',folder:'inbox',flag:false,arch:false,subject:'Re: Edits ‚Äî Publication Option 2',from:'respondent.counsel@example.com',to:['claimant.counsel@example.com'],cc:[],date:'2025-08-12 14:10',
   body:'In ¬ß23, we prefer Publication Option 2 (award published only with both parties consent).',
   attachments:[],tags:{topic:['Publication','Option 2']},caseId:'C-001'},
  {id:'e3',folder:'inbox',flag:false,arch:false,subject:'Offer freight at USD 56,000 PDPR for 12 months',from:'broker@ship.com',to:['owners@co.com','charterer@qs.com'],cc:[],date:'2025-08-11 09:12',
   body:'Laycan 19‚Äì25 Nov. Load port Beira, discharge Tianjin. Time counting SHINC. Please confirm.',
   attachments:[{name:'W3C Dummy.pdf',url:'https://www.w3.org/WAI/ER/tests/xhtml/testfiles/resources/pdf/dummy.pdf'}],
   tags:{topic:['Laycan','PDPR','NOR','SHINC','Beira','Tianjin']},caseId:'C-002'},
  {id:'e4',folder:'inbox',flag:true,arch:false,subject:'NOR validity question at Beira (SHINC)',from:'charterer@qs.com',to:['owners@co.com'],cc:[],date:'2025-08-10 08:23',
   body:'Please confirm NOR tendering window at Beira and applicable SHINC rule.',
   attachments:[],tags:{topic:['NOR','SHINC','Beira']},caseId:'C-002'},
  {id:'e5',folder:'inbox',flag:false,arch:false,subject:'MV Silver Wave ‚Äî recap (Busan to Manila, 25‚Äì27 Aug)',from:'broker@sea.com',to:['ops@ship.com'],cc:[],date:'2025-08-11 16:05',
   body:'Fixture recap attached; laycan 25‚Äì27 Aug, Busan to Manila.',
   attachments:[{name:'Mozilla Sample.pdf',url:'https://mozilla.github.io/pdf.js/web/compressed.tracemonkey-pldi-09.pdf'}],
   tags:{topic:['Laycan','Recap','Busan','Manila']},caseId:'C-003'}
];

/* ========= Â∑•ÂÖ∑ ========= */
function $(s){return document.querySelector(s);}
function fmtDate(s){var d=new Date(s);function p(n){return (n<10?'0':'')+n;}return d.getFullYear()+'-'+p(d.getMonth()+1)+'-'+p(d.getDate())+' '+p(d.getHours())+':'+p(d.getMinutes());}
function groupLabel(d){var dd=Math.floor((new Date()-new Date(d))/86400000);return dd<=0?'‰ªäÂ§©':dd===1?'Êò®Â§©':'Êõ¥Êó©';}
function findOne(a,p){for(var i=0;i<a.length;i++){if(p(a[i]))return a[i];}return null;}
function rid(){ return Math.random().toString(36).slice(2,8); }

/* ========= ÂÖ®Â±ÄÁä∂ÊÄÅ ========= */
var APP={caseId:(localStorage.getItem('arbimail.case')||'')};
var state={scope:{type:'case',id:null}, selected:null};
var currentPdfUrl='';

/* ========= È°∂ÈÉ®ÊåâÈíÆ ========= */
document.getElementById('btnAutoClass').onclick=function(){
  alert('Â∑≤Êèê‰∫§ ‚ÄúAI Ëá™Âä®ÂàÜÁ±ª‚Äù ËØ∑Ê±ÇÔºàÊºîÁ§∫ÊåâÈíÆÔºåÊó†ÂÆûÈôÖÂàÜÁ±ªÔºâ„ÄÇ');
};

/* ========= Â∑¶‰æßÔºöÈÇÆ‰ª∂ÁÆ± ========= */
function setBadgeCounts(){
  var c={
    inbox:EMAILS.filter(e=>e.folder==='inbox').length,
    sent: EMAILS.filter(e=>e.folder==='sent').length,
    flag: EMAILS.filter(e=>e.flag).length,
    arch: EMAILS.filter(e=>e.arch).length,
    unfiled: EMAILS.filter(e=>!e.caseId).length
  };
  ['inbox','sent','flag','arch','unfiled'].forEach(function(k){
    var el=document.getElementById('b_'+k); if(el) el.textContent=c[k]||0;
  });
}
function renderMailboxes(){
  var box=$('#mbxBody'); box.innerHTML='';
  MAILBOXES.forEach(function(m){
    var row=document.createElement('div'); row.className='item';
    row.innerHTML='<div class="name">'+m.name+'</div><div class="subctrl"><span class="badge" id="b_'+m.id+'">0</span></div>';
    row.onclick=function(){ state.scope={type:'mailbox',id:m.id}; renderList(); };
    box.appendChild(row);
  });
  setBadgeCounts();
}

/* ========= Â∑¶‰æßÔºöÊ°à‰ª∂‰∏éÂêàÂêå ========= */
function renderCaseGroups(){
  var legal=$('#legalBody'), arb=$('#arbBody'); legal.innerHTML=''; arb.innerHTML='';
  CASES.filter(c=>c.cat==='legal').forEach(c=>appendCaseRow(legal,c));
  CASES.filter(c=>c.cat==='arb').forEach(c=>appendCaseRow(arb,c));
}
function appendCaseRow(container,c){
  var row=document.createElement('div'); row.className='item';
  row.innerHTML='<div class="name" style="display:flex;align-items:center;gap:8px"><span style="width:8px;height:8px;border-radius:50%;background:'+c.color+'"></span>'+c.name+'</div>'+
                '<div class="subctrl"><span class="badge" id="cnt_'+c.id+'">0</span></div>';
  row.onclick=function(){ APP.caseId=c.id; localStorage.setItem('arbimail.case',APP.caseId); state.scope={type:'case',id:c.id}; renderList(); updateCounts(); syncAutoReplyCase(); };
  container.appendChild(row);

  var sub=document.createElement('div'); sub.className='sublist pdf-list';
  if(!c.pdfIds.length){ sub.innerHTML='<div class="pdf-empty">ÔºàÊú™ÂÖ≥ËÅîÂêàÂêåÔºâ</div>'; }
  else c.pdfIds.forEach(function(pid){
    var p=findOne(PDFS,x=>x.id===pid); if(!p) return;
    var s=document.createElement('div'); s.className='pdf-row';
    s.innerHTML='<div class="pdf-ico">üìé</div><div class="pdf-name" title="'+p.name+'">'+p.name+'</div>'+
                '<button class="tiny primary" data-act="open">ÊâìÂºÄ</button>'+
                '<button class="tiny" data-act="unlink">ÁßªÈô§</button>';
    s.onclick=function(ev){
      var act=ev.target && ev.target.getAttribute('data-act');
      if(act==='open'){ openPdf(p.url,{zoom:'page-fit'}); ev.stopPropagation(); }
      if(act==='unlink'){ c.pdfIds=c.pdfIds.filter(x=>x!==pid); renderCaseGroups(); ev.stopPropagation(); }
    };
    sub.appendChild(s);
  });
  var ctrl=document.createElement('div'); ctrl.className='link-row';
  var sel='<select class="tiny" style="width:100%">'; PDFS.forEach(p=>sel+='<option value="'+p.id+'">'+p.name+'</option>'); sel+='</select>';
  ctrl.innerHTML='<div class="pdf-ico">‚ûï</div>'+sel+'<button class="tiny" data-act="link">ÂÖ≥ËÅî</button>';
  ctrl.onclick=function(ev){
    if(ev.target && ev.target.getAttribute('data-act')==='link'){
      var s=ctrl.querySelector('select'); var pid=s.value; if(pid && c.pdfIds.indexOf(pid)<0){ c.pdfIds.push(pid); renderCaseGroups(); }
      ev.stopPropagation();
    }
  };
  sub.appendChild(ctrl);
  container.appendChild(sub);
}
function renderShelf(){
  var wrap=$('#shelfBody'); wrap.innerHTML='';
  if(!PDFS.length){ wrap.innerHTML='<div class="pdf-empty">ÊöÇÊó†PDF</div>'; return; }
  PDFS.forEach(function(p){
    var row=document.createElement('div'); row.className='item';
    row.innerHTML='<div class="name">üìÑ '+p.name+'</div><div class="subctrl"><span class="badge">PDF</span></div>';
    row.onclick=function(){ openPdf(p.url,{zoom:'page-fit'}); };
    wrap.appendChild(row);
  });
}
function updateCounts(){
  CASES.forEach(function(c){
    var el=$('#cnt_'+c.id); if(!el) return;
    el.textContent = EMAILS.filter(e=>e.caseId===c.id).length;
  });
  setBadgeCounts();
}

/* ========= Êñá‰ª∂ & ÂØºÂÖ• ========= */
$('#btnAddPdf').onclick=function(){ $('#pdfPicker').click(); };
$('#pdfPicker').onchange=function(e){
  var f=e.target.files[0]; if(!f) return;
  var id='pdf_'+rid(), url=URL.createObjectURL(f);
  PDFS.unshift({id:id,name:f.name,url:url}); renderShelf(); renderCaseGroups();
};
$('#btnImportLegal').onclick=function(){
  var name=prompt('ËæìÂÖ•Ê≥ïÂæã‰∫ãÂä°Ê°à‰ª∂ÂêçÁß∞Ôºö'); if(!name) return;
  var c={id:'L-'+rid(),cat:'legal',name:name,color:'#0ea5e9',pdfIds:[]}; CASES.unshift(c);
  renderCaseGroups(); updateCounts();
};
$('#btnImportArb').onclick=function(){
  var name=prompt('ËæìÂÖ•‰ª≤Ë£ÅÊ°à‰ª∂ÂêçÁß∞Ôºö'); if(!name) return;
  var c={id:'A-'+rid(),cat:'arb',name:name,color:'#a855f7',pdfIds:[]}; CASES.unshift(c);
  renderCaseGroups(); updateCounts();
};

/* ========= ÂàóË°®/ÈòÖËØª ========= */
function pool(){
  var q=$('#qGlobal').value.trim().toLowerCase();
  var base = EMAILS.slice();
  if(q){
    return base.filter(function(e){
      var hay=(e.subject+' '+e.body+' '+e.from+' '+(e.to||[]).join(' ')).toLowerCase();
      return hay.indexOf(q)>-1;
    }).sort((a,b)=>new Date(b.date)-new Date(a.date));
  }
  if(state.scope.type==='mailbox'){
    if(state.scope.id==='inbox')  return base.filter(e=>e.folder==='inbox' && !e.arch).sort((a,b)=>new Date(b.date)-new Date(a.date));
    if(state.scope.id==='sent')   return base.filter(e=>e.folder==='sent').sort((a,b)=>new Date(b.date)-new Date(a.date));
    if(state.scope.id==='flag')   return base.filter(e=>e.flag).sort((a,b)=>new Date(b.date)-new Date(a.date));
    if(state.scope.id==='arch')   return base.filter(e=>e.arch).sort((a,b)=>new Date(b.date)-new Date(a.date));
    if(state.scope.id==='unfiled')return base.filter(e=>!e.caseId).sort((a,b)=>new Date(b.date)-new Date(a.date));
  }
  if(state.scope.type==='case' && state.scope.id){
    return base.filter(e=>e.caseId===state.scope.id).sort((a,b)=>new Date(b.date)-new Date(a.date));
  }
  return base.sort((a,b)=>new Date(b.date)-new Date(a.date));
}
function renderList(){
  var arr=pool();
  var box=$('#list'); box.innerHTML='';
  var last=''; arr.forEach(function(e){
    var lb=groupLabel(e.date);
    if(lb!==last){ last=lb; var hd=document.createElement('div'); hd.className='section-hd'; hd.innerText=lb; box.appendChild(hd); }
    var row=document.createElement('div'); row.className='row-mail';
    row.innerHTML='<div class="dot"></div><div style="min-width:0"><div class="subject">'+e.subject+'</div><div class="meta">'+e.from+' ¬∑ '+(e.to||[]).join(', ')+'</div></div><div class="meta">'+fmtDate(e.date)+'</div>';
    row.onclick=function(){ selectMail(e.id); };
    box.appendChild(row);
  });
}
$('#qGlobal').oninput=renderList;

function pills(a){return (a||[]).map(x=>'<span class="pill-addr">'+x+'</span>').join(' ');}
function selectMail(id){
  var e=findOne(EMAILS,x=>x.id===id); if(!e) return; state.selected=id; APP.caseId=e.caseId; localStorage.setItem('arbimail.case',APP.caseId);
  $('#subj').textContent=e.subject;
  $('#hFrom').innerHTML=pills([e.from]); $('#hTo').innerHTML=pills(e.to||[]);
  if(e.cc && e.cc.length){ $('#ccLine').style.display='flex'; $('#hCc').innerHTML=pills(e.cc); } else $('#ccLine').style.display='none';
  $('#hTime').textContent=fmtDate(e.date);
  $('#kp').innerHTML='‚Ä¢ ËÆÆÈ¢òÔºö'+((e.tags&&e.tags.topic)||[]).join('„ÄÅ')+'<br>‚Ä¢ ÂÖ≥ËÅîÊ°à‰ª∂Ôºö'+((findOne(CASES,c=>c.id===e.caseId)||{}).name||'‚Äî');
  var chips=extractKeywords(e).map(k=>'<span class="mini-link" style="color:#2f6efb;cursor:pointer" data-k="'+k.replace(/"/g,'&quot;')+'">'+k+'</span>').join(' ');
  $('#chips').innerHTML=chips; document.querySelectorAll('[data-k]').forEach(x=>x.onclick=function(){ jumpSearch(this.getAttribute('data-k')); });
  $('#attach').innerHTML=(e.attachments||[]).map(a=>'<span class="file">üìé '+a.name+'</span>').join(' ');
  $('#body').textContent=e.body||'';
  var url=null, att=(e.attachments||[]).filter(a=>/\.pdf$/i.test(a.name))[0];
  if(att) url=att.url||att.name;
  if(!url && e.caseId){ var c=findOne(CASES,x=>x.id===e.caseId); if(c && c.pdfIds.length){ var p=findOne(PDFS,pp=>pp.id===c.pdfIds[0]); url=p&&p.url; } }
  if(!url && PDFS.length) url=PDFS[0].url;
  if(url) openPdf(url,{zoom:'page-fit'});
  updateSidePanels(e);
  if($('#autoReplyEnable').checked){ doTestAutoReply(); }
}

/* ÂÖ≥ÈîÆËØçÊèêÂèñÔºàÁÆÄÁâàÔºâ */
function extractKeywords(e){
  var p={},add=function(s){if(s&&!p[s])p[s]=1;}; var t=(e.subject+' '+e.body).toLowerCase(); var a=(e.tags&&e.tags.topic)||[]; a.forEach(add);
  ['Applicable Arbitration Rules','Constitution of the Tribunal','Fees and Expenses','Presence and Quorum','Rulings of the Tribunal','Power to Fix Time Limits','Secretary of the Tribunal','Representation of the Parties','Apportionment of Costs','Place of Proceeding','Procedural Language','Routing of Communications','Number of Copies','Sequence of Pleadings','Production of Documents','Submission of Documents','Witness Statements','Examination of Witnesses','Pre-Hearing','Hearings','Records of Hearings','Post-Hearing','Publication']
    .forEach(function(x){ if(t.indexOf(x.toLowerCase().split(' ')[0])>-1) add(x); });
  ['Laycan','PDPR','NOR','SHINC','Demurrage','Beira','Tianjin','Recap','Busan','Manila']
    .forEach(function(x){ if(t.indexOf(x.toLowerCase())>-1) add(x); });
  (e.body.match(/Option\s*\d/ig)||[]).forEach(add);
  return Object.keys(p).slice(0,12);
}

/* ========= PDF ========= */
function openPdf(url,opts){opts=opts||{};currentPdfUrl=url;var ps=[];if(opts.page)ps.push('page='+opts.page);if(opts.search)ps.push('search='+encodeURIComponent(opts.search));if(opts.zoom)ps.push('zoom='+opts.zoom);$('#pdfFrame').src=url+(ps.length?'#'+ps.join('&'):'#zoom=page-fit');}
function jumpSearch(q){ if(!currentPdfUrl) return; openPdf(currentPdfUrl,{search:q}); $('#pdfFind').value=q; }
$('#btnReload').onclick=function(){ openPdf(currentPdfUrl||(PDFS[0]&&PDFS[0].url),{zoom:'page-fit'}); };
$('#filePickerMail').onchange=function(e){ var f=e.target.files[0]; if(!f)return; openPdf(URL.createObjectURL(f),{zoom:'page-fit'}); };
$('#btnPage').onclick=function(){ var p=parseInt($('#pdfPage').value||''); if(p>0) openPdf(currentPdfUrl||(PDFS[0]&&PDFS[0].url),{page:p}); };
$('#btnFind').onclick=function(){ var q=$('#pdfFind').value.trim(); if(q) jumpSearch(q); };

/* ========= Âè≥‰æßÔºöÊëòË¶Å/ÊäΩÂèñ/ÂÖ≥ËÅîÂêàÂêå/Áõ∏ÂÖ≥ÈÇÆ‰ª∂/Êó∂Èó¥ËΩ¥ ========= */
function extractFields(t){
  var f={rate:null,laycan:null,load:null,disc:null,rules:null};
  var m=t.match(/USD[\s$]*([0-9,]+)\s*PDPR/i); if(m) f.rate='USD '+m[1]+' PDPR';
  m=t.match(/Laycan[^0-9]*([0-3]?\d[\-\‚Äì‚Äî][0-3]?\d\s*(Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec))/i); if(m) f.laycan=m[1];
  m=t.match(/Load\s*port\s*([A-Za-z][A-Za-z\s\-]+)/i); if(m) f.load=m[1].trim();
  m=t.match(/discharge\s*([A-Za-z][A-Za-z\s\-]+)/i); if(m) f.disc=m[1].trim();
  if(/SHINC/i.test(t)) f.rules='SHINC';
  if(/ICSID/i.test(t)) f.rules=f.rules?f.rules+', ICSID':'ICSID';
  return f;
}
function updateSidePanels(email){
  var caseObj=email.caseId?findOne(CASES,c=>c.id===email.caseId):null;
  var topics=(email.tags&&email.tags.topic)||[],brief=topics.length?('Êú¨ÈÇÆ‰ª∂Ê∂âÂèäÔºö'+topics.join('„ÄÅ')+'„ÄÇÂèØÂú®ÂêàÂêå‰∏≠Âø´ÈÄüÊ£ÄÁ¥¢Âπ∂Ê†∏ÂØπÁõ∏Â∫îÊù°Ê¨æ„ÄÇ'):'Ê†πÊçÆÂÖ≥ÈîÆËØçÂú®‰∏ãÊñπÂêàÂêå‰∏≠ÂÆö‰ΩçÊù°Ê¨æÂπ∂È´ò‰∫ÆÔºõÂøÖË¶ÅÊó∂ÂàáÊç¢Ê°à‰ª∂ÂÖ≥ËÅîÂêàÂêå„ÄÇ';
  $('#aisum').textContent=brief;
  var f=extractFields(email.subject+' '+email.body);
  $('#kvCase').textContent=caseObj?caseObj.name:'‚Äî'; $('#kvRate').textContent=f.rate||'‚Äî'; $('#kvLaycan').textContent=f.laycan||'‚Äî'; $('#kvLoad').textContent=f.load||'‚Äî'; $('#kvDisc').textContent=f.disc||'‚Äî'; $('#kvRules').textContent=f.rules||'‚Äî';

  var html=''; if(caseObj){ html+='<div style="margin-bottom:6px"><b>Ê°à‰ª∂Ôºö</b>'+caseObj.name+'</div>';
    if(caseObj.pdfIds.length){
      caseObj.pdfIds.forEach(function(id){ var p=findOne(PDFS,x=>x.id===id); if(p){ html+='<div class="bookmark"><span>üìÑ '+p.name+'</span><span class="mini-link" data-open="'+p.url+'">ÊâìÂºÄ</span></div>'; } });
    } else { html+='<div class="pdf-empty">ÊöÇÊó†ÂÖ≥ËÅîÂêàÂêå</div>'; }
  } else { html='Êú™ÂÖ≥ËÅîÂà∞‰ªª‰ΩïÊ°à‰ª∂„ÄÇ'; }
  $('#relInfo').innerHTML=html; document.querySelectorAll('[data-open]').forEach(function(a){ a.onclick=function(){ openPdf(a.getAttribute('data-open'),{zoom:'page-fit'}); }; });

  $('#opFlag').checked=!!email.flag; $('#opArch').checked=!!email.arch;
  $('#opFlag').onchange=function(){ email.flag=this.checked; setBadgeCounts(); renderList(); };
  $('#opArch').onchange=function(){ email.arch=this.checked; setBadgeCounts(); renderList(); };
  $('#opToCase').onclick=function(){ if(!caseObj){ alert('ËØ•ÈÇÆ‰ª∂Êú™ÁªëÂÆöÊ°à‰ª∂'); return; } email.caseId=caseObj.id; renderList(); alert('Â∑≤ÁßªÂä®Âà∞Ê°à‰ª∂Ôºö'+caseObj.name); };

  var list=$('#relEmails'); list.innerHTML=''; var rel=EMAILS.filter(e=>e.caseId && caseObj && e.caseId===caseObj.id && e.id!==email.id).sort((a,b)=>new Date(b.date)-new Date(a.date)).slice(0,5);
  if(!rel.length){ list.textContent='ÊöÇÊó†'; } else rel.forEach(function(r){ var d=document.createElement('div'); d.className='rel-item'; d.innerHTML='<div>'+r.subject+'<div class="rel-meta">'+fmtDate(r.date)+'</div></div><div class="rel-meta">'+(r.from||'')+'</div>'; list.appendChild(d); });

  renderBookmarks(email.caseId||'GLOBAL');
  renderCaseTimeline(email.caseId);
}

/* Êó∂Èó¥ËΩ¥Ê∏≤Êüì */
function renderCaseTimeline(caseId){
  var box=$('#caseTimeline'); if(!caseId){ box.textContent='ÊöÇÊó†'; return; }
  var arr=EMAILS.filter(e=>e.caseId===caseId).sort((a,b)=>new Date(b.date)-new Date(a.date)).slice(0,12);
  if(!arr.length){ box.textContent='ÊöÇÊó†'; return; }
  box.innerHTML='';
  arr.forEach(function(e){
    var row=document.createElement('div'); row.className='tl-item';
    row.innerHTML='<div class="tl-card">'+
                    '<div class="tl-title">'+e.subject+'</div>'+
                    '<div class="tl-meta">'+fmtDate(e.date)+' ¬∑ '+(e.from||'')+'</div>'+
                    '<div class="tl-body">'+(e.body||'').slice(0,180)+((e.body&&e.body.length>180)?'‚Ä¶':'')+'</div>'+
                  '</div>';
    box.appendChild(row);
  });
}

/* ========= ‰π¶Á≠æ ========= */
function bmKey(c){return 'arbimail.bm.'+(c||'GLOBAL');}
function getBookmarks(c){try{var t=localStorage.getItem(bmKey(c));return t?JSON.parse(t):[];}catch(e){return[]}}
function setBookmarks(c,a){try{localStorage.setItem(bmKey(c),JSON.stringify(a));}catch(e){}}
function renderBookmarks(c){var box=$('#bmList'),arr=getBookmarks(c); if(!arr.length){box.textContent='ÊöÇÊó†‰π¶Á≠æ';return;} box.innerHTML=''; arr.forEach(function(b,idx){ var row=document.createElement('div'); row.className='bookmark'; row.innerHTML='<span>'+(b.type==='page'?'È°µÁ†Å ':'ÂÖ≥ÈîÆÂ≠ó ')+b.value+'</span><span><span class="mini-link" data-goto="'+idx+'">Ë∑≥ËΩ¨</span> ¬∑ <span class="mini-link" data-del="'+idx+'">Âà†Èô§</span></span>'; box.appendChild(row);}); box.querySelectorAll('[data-goto]').forEach(function(g){ g.onclick=function(){ var a=getBookmarks(c)[parseInt(g.getAttribute('data-goto'),10)]; if(a){ if(a.type==='page')openPdf(currentPdfUrl||(PDFS[0]&&PDFS[0].url),{page:parseInt(a.value,10)||1}); else jumpSearch(a.value); } };}); box.querySelectorAll('[data-del]').forEach(function(g){ g.onclick=function(){ var idx=parseInt(g.getAttribute('data-del'),10); var arr=getBookmarks(c); arr.splice(idx,1); setBookmarks(c,arr); renderBookmarks(c); }; });}
$('#bmAddPage').onclick=function(){ var page=prompt('ËæìÂÖ•‰π¶Á≠æÈ°µÁ†ÅÔºö'); if(!page) return; var key=APP.caseId||'GLOBAL'; var arr=getBookmarks(key); arr.push({type:'page',value:page,ts:Date.now()}); setBookmarks(key,arr); renderBookmarks(key); };
$('#bmAddSearch').onclick=function(){ var kw=$('#pdfFind').value.trim()||prompt('ËæìÂÖ•ÂÖ≥ÈîÆÂ≠óÔºö'); if(!kw) return; var key=APP.caseId||'GLOBAL'; var arr=getBookmarks(key); arr.push({type:'search',value:kw,ts:Date.now()}); setBookmarks(key,arr); renderBookmarks(key); };
$('#bmClear').onclick=function(){ var key=APP.caseId||'GLOBAL'; setBookmarks(key,[]); renderBookmarks(key); };

/* ========= Ëá™Âä®ÂõûÂ§çÔºöÊó∂Èó¥Á™óÔºàÊåâÊ°à‰ª∂Ôºâ + ÂÖ∂‰ªñËßÑÂàô ========= */
function rulesKey(caseId){ return 'arbimail.autoreply.rules.'+caseId; }
function enableKey(caseId){ return 'arbimail.autoreply.enable.'+caseId; }
function timeKey(caseId){ return 'arbimail.autoreply.time.'+caseId; }

function loadRules(caseId){
  try{ var t=localStorage.getItem(rulesKey(caseId)); if(t) return JSON.parse(t); }catch(e){}
  return [
    {id:rid(), type:'amount', label:'ÈáëÈ¢ùÔºàUSD/PDPRÔºâ', content:'USD PDPR', min:52000, max:60000, list:[], enabled:false},
    {id:rid(), type:'place',  label:'Ê∏ØÂè£ÔºàË£Ö/Âç∏Ôºâ',     content:'Ë£ÖÂç∏Ê∏ØÂÖÅËÆ∏ÂàóË°®', list:['Beira','Tianjin','Busan','Manila'], enabled:false},
    {id:rid(), type:'clause', label:'Êù°Ê¨æÂåÖÂê´',         content:'Option 2', min:null, max:null, list:[], enabled:false}
  ];
}
function saveRules(caseId,arr){ try{ localStorage.setItem(rulesKey(caseId), JSON.stringify(arr)); }catch(e){} }

function loadTime(caseId){
  try{ var t=localStorage.getItem(timeKey(caseId)); if(t) return JSON.parse(t); }catch(e){}
  return {start:0,end:24}; // ÈªòËÆ§ÂÖ®Êó∂ÊÆµ
}
function saveTime(caseId,obj){ try{ localStorage.setItem(timeKey(caseId), JSON.stringify(obj)); }catch(e){} }

function hourOptions(){ var s=''; for(var i=0;i<=24;i++){ s+='<option value="'+i+'">'+i+'</option>'; } return s; }
function fillTimeSelectors(obj){
  $('#arTimeStart').innerHTML=hourOptions();
  $('#arTimeEnd').innerHTML=hourOptions();
  $('#arTimeStart').value = obj.start;
  $('#arTimeEnd').value   = obj.end;
}

function syncAutoReplyCase(){
  var sel=$('#arCaseSelect');
  sel.innerHTML=CASES.map(c=>'<option value="'+c.id+'">'+c.name+'</option>').join('');
  sel.value=APP.caseId|| (CASES[0]&&CASES[0].id);

  $('#autoReplyEnable').checked = localStorage.getItem(enableKey(sel.value))==='1';
  // Êó∂Èó¥Á™ó
  var tw=loadTime(sel.value); fillTimeSelectors(tw);
  // ËßÑÂàô
  drawRules(loadRules(sel.value));
}

$('#arCaseSelect').onchange=function(){
  APP.caseId=this.value; localStorage.setItem('arbimail.case',APP.caseId);
  $('#autoReplyEnable').checked = localStorage.getItem(enableKey(APP.caseId))==='1';
  fillTimeSelectors(loadTime(APP.caseId));
  drawRules(loadRules(APP.caseId));
};
$('#btnSaveTime').onclick=function(){
  var cid=$('#arCaseSelect').value||APP.caseId;
  saveTime(cid,{start:parseInt($('#arTimeStart').value,10), end:parseInt($('#arTimeEnd').value,10)});
  alert('Êó∂Èó¥Á™óÂ∑≤‰øùÂ≠òÂà∞Ê°à‰ª∂„ÄÇ');
};
$('#autoReplyEnable').onchange=function(){
  var id=$('#arCaseSelect').value||APP.caseId; if(!id) return;
  localStorage.setItem(enableKey(id), this.checked?'1':'0');
};

function drawRules(arr){
  var box=$('#ruleList'); box.innerHTML='';
  arr.forEach(function(r){
    var wrap=document.createElement('div'); wrap.className='rule'; wrap.setAttribute('data-id',r.id);
    wrap.innerHTML='' +
      '<div class="rule-top">'+
        '<div class="rule-title"><label class="switch" style="gap:6px"><input type="checkbox" class="r-enable"> ÂêØÁî®</label> ¬∑ '+
        '<select class="tiny r-type">'+
          '<option value="amount">ÈáëÈ¢ù(USD/PDPR)</option>'+
          '<option value="place">Âú∞ÁÇπ</option>'+
          '<option value="clause">Êù°Ê¨æ</option>'+
        '</select></div>'+
        '<button class="tiny" data-act="del">Âà†Èô§</button>'+
      '</div>'+
      '<div class="rule-row"><label>Â≠óÊÆµÂêçÁß∞ / ÂÜÖÂÆπËØ¥Êòé</label><input class="r-label" placeholder="‰æãÂ¶ÇÔºöÈáëÈ¢ùÔºàUSD/PDPRÔºâ" /></div>'+
      '<div class="rule-row"><label>Â≠óÊÆµÂÜÖÂÆπ</label><input class="r-content" placeholder="Â¶ÇÔºöUSD PDPR / Option 2 / ¬ß23" /></div>'+
      (r.type==='place'
        ? ('<div class="rule-row"><label>ÂÖÅËÆ∏ÂàóË°®ÔºàÈÄóÂè∑ÂàÜÈöîÔºâ</label><input class="r-list-input" placeholder="Beira,Tianjin,Busan"></div>')
        : ('<div class="rule-row"><label>Âå∫Èó¥ËåÉÂõ¥</label><div class="rule-range"><input class="r-min" placeholder="‰∏ãÈôê"><input class="r-max" placeholder="‰∏äÈôê"></div></div>')
      );
    box.appendChild(wrap);
    // ÂàùÂÄº
    wrap.querySelector('.r-enable').checked=!!r.enabled;
    wrap.querySelector('.r-type').value=r.type;
    wrap.querySelector('.r-label').value=r.label||'';
    wrap.querySelector('.r-content').value=r.content||'';
    if(r.type==='place'){
      if(wrap.querySelector('.r-list-input')) wrap.querySelector('.r-list-input').value=(r.list||[]).join(',');
    }else{
      if(wrap.querySelector('.r-min')) wrap.querySelector('.r-min').value=(r.min!=null?r.min:'');
      if(wrap.querySelector('.r-max')) wrap.querySelector('.r-max').value=(r.max!=null?r.max:'');
    }
    // Á±ªÂûãÂàáÊç¢Êó∂ÈáçÁªò
    wrap.querySelector('.r-type').onchange=function(){
      r.type=this.value;
      var all=collectRulesFromUI(); all=all.map(function(x){ if(x.id===r.id) x.type=r.type; return x; });
      saveRules($('#arCaseSelect').value,all); drawRules(all);
    };
    wrap.querySelector('[data-act="del"]').onclick=function(){
      var all=loadRules($('#arCaseSelect').value).filter(x=>x.id!==r.id);
      saveRules($('#arCaseSelect').value,all); drawRules(all);
    };
    // Â§±ÁÑ¶‰øùÂ≠ò
    wrap.querySelectorAll('input,select').forEach(function(el){ el.onchange=function(){ saveRules($('#arCaseSelect').value, collectRulesFromUI()); }; el.onblur=function(){ saveRules($('#arCaseSelect').value, collectRulesFromUI()); }; });
  });
}
function collectRulesFromUI(){
  var arr=[]; document.querySelectorAll('#ruleList .rule').forEach(function(wrap){
    var type=wrap.querySelector('.r-type').value;
    var r={id:wrap.getAttribute('data-id'),
           enabled:wrap.querySelector('.r-enable').checked,
           type:type,
           label:wrap.querySelector('.r-label').value.trim(),
           content:wrap.querySelector('.r-content').value.trim(),
           min:null,max:null,list:[]};
    if(type==='place'){
      r.list = (wrap.querySelector('.r-list-input').value||'').split(',').map(s=>s.trim()).filter(Boolean);
    }else{ // amount / clause
      var mi=wrap.querySelector('.r-min'), ma=wrap.querySelector('.r-max');
      if(mi) r.min=parseFloat(mi.value)||null;
      if(ma) r.max=parseFloat(ma.value)||null;
    }
    arr.push(r);
  });
  return arr;
}
$('#btnAddRule').onclick=function(){
  var cid=$('#arCaseSelect').value||APP.caseId; var arr=loadRules(cid);
  arr.unshift({id:rid(), type:'amount', label:'ÈáëÈ¢ùÔºàUSD/PDPRÔºâ', content:'USD PDPR', min:50000, max:60000, list:[], enabled:true});
  saveRules(cid,arr); drawRules(arr);
};
$('#btnSaveRules').onclick=function(){ alert('ËßÑÂàôÂ∑≤‰øùÂ≠òÔºàÊú¨Âú∞ÊµèËßàÂô®Â≠òÂÇ®Ôºâ„ÄÇ'); };
$('#btnResetRules').onclick=function(){ var cid=$('#arCaseSelect').value||APP.caseId; localStorage.removeItem(rulesKey(cid)); drawRules(loadRules(cid)); };
$('#btnCopyReply').onclick=function(){ navigator.clipboard.writeText($('#replyDraft').value||''); };

/* ËØÑ‰º∞ÔºöÊó∂Èó¥Á™ó‰Ωú‰∏∫ÂÖ®Â±ÄÂºÄÂÖ≥ÔºàÊîØÊåÅË∑®ÂçàÂ§úÔºâ */
function inWindow(hour, start, end){
  return start<=end ? (hour>=start && hour<=end) : (hour>=start || hour<=end);
}
function evaluateEmail(email, rules){
  var text=(email.subject||'')+'\n'+(email.body||''); var okAll=true, fails=[], hits={};
  var m=text.match(/USD[\s$]*([\d,]+)\s*PDPR/i); var price = m? parseFloat(m[1].replace(/,/g,'')) : null;
  var places=['Beira','Tianjin','Busan','Manila','Qingdao','Shanghai'].filter(function(p){return new RegExp('\\b'+p+'\\b','i').test(text);});
  var sendHour=(new Date(email.date)).getHours();
  // Êó∂Èó¥Á™ó
  var tw=loadTime(email.caseId||($('#arCaseSelect').value||APP.caseId));
  var timeOk=inWindow(sendHour, tw.start, tw.end);

  rules.filter(r=>r.enabled).forEach(function(r){
    if(r.type==='amount'){
      if(price==null){ okAll=false; fails.push('ÈáëÈ¢ùÊú™ËØÜÂà´'); }
      else{
        if(r.min!=null && price<r.min){ okAll=false; fails.push('ÈáëÈ¢ù‰Ωé‰∫é‰∏ãÈôê'); }
        if(r.max!=null && price>r.max){ okAll=false; fails.push('ÈáëÈ¢ùÈ´ò‰∫é‰∏äÈôê'); }
        hits.amount=price;
      }
    }else if(r.type==='place'){
      if(!r.list || !r.list.length){ /* Êó†ÂàóË°®ÂàôË∑≥Ëøá */ }
      var hit = r.list.some(function(p){ return new RegExp('\\b'+p+'\\b','i').test(text); });
      if(!hit){ okAll=false; fails.push('Âú∞ÁÇπ‰∏çÂú®ÂÖÅËÆ∏ÂàóË°®'); } else { hits.place=(places.join(', ')||r.list.join(',')); }
    }else if(r.type==='clause'){
      if(r.content && !new RegExp(r.content.replace(/[.*+?^${}()|[\]\\]/g,'\\$&'),'i').test(text)){
        okAll=false; fails.push('Êú™ÂåÖÂê´Êù°Ê¨æÔºö'+r.content);
      }else{ hits.clause=r.content||''; }
    }
  });
  return {ok:okAll, fails:fails, hits:hits, price:price, places:places, sendHour:sendHour, win:tw, timeOk:timeOk};
}
function buildReplyDraft(email, res){
  var lines = [
    'Subject: Re: '+(email.subject||''),
    '',
    (res.ok?'ÊàëÊñπÂêåÊÑèË¥µÊñπÂú®ÈÇÆ‰ª∂ÊâÄËø∞Êù°‰ª∂ÂÜÖÁöÑÊä•‰ª∑/Êù°Ê¨æÔºåÂÖ∑‰ΩìÂ¶Ç‰∏ãÔºö'
           :'ÁªèÊ†∏ÂØπÔºå‰ª•‰∏ãË¶ÅÁ¥†Êú™Êª°Ë∂≥ÊàëÊñπÈ¢ÑËÆæÈòàÂÄºÔºåÊöÇ‰∏ç‰∫àÂêåÊÑèÔºö'),
    ''
  ];
  if(res.ok){
    if(res.price!=null) lines.push('‚Ä¢ ‰ª∑Ê†ºÔºöUSD '+res.price+' PDPR');
    if(res.places && res.places.length) lines.push('‚Ä¢ Ê∂âÂèäÊ∏ØÂè£Ôºö'+res.places.join(', '));
    if(res.hits && res.hits.clause) lines.push('‚Ä¢ Êù°Ê¨æÔºöÂåÖÂê´ '+res.hits.clause);
  }else{
    res.fails.forEach(function(f){ lines.push('‚Ä¢ '+f); });
  }
  lines.push('');
  lines.push('ÔºàÂΩìÂâçÈÇÆ‰ª∂Êó∂Èó¥Ôºö'+res.sendHour+'hÔºå'+(res.timeOk?'‰Ωç‰∫é':'‰∏çÂú®')+'Ëá™Âä®ÂõûÂ§çÊó∂Èó¥Á™ó '+res.win.start+'‚Äì'+res.win.end+'hÔºâ');
  lines.push('', 'Ê≠§Ëá¥');
  return lines.join('\n');
}
function doTestAutoReply(){
  if(!state.selected){ alert('ËØ∑ÂÖàÈÄâÊã©‰∏ÄÂ∞ÅÈÇÆ‰ª∂'); return; }
  var e=findOne(EMAILS,x=>x.id===state.selected); if(!e) return;
  var rules=collectRulesFromUI(); var res=evaluateEmail(e,rules);
  $('#replyDraft').value=buildReplyDraft(e,res);
}

/* ========= ÂàùÂßãÂåñ ========= */
function init(){
  renderMailboxes();
  renderCaseGroups(); renderShelf(); updateCounts();
  if(!APP.caseId){ APP.caseId = (CASES[0]&&CASES[0].id); }
  state.scope={type:'case',id:APP.caseId};
  renderList();
  syncAutoReplyCase();
  var first = EMAILS.find(e=>e.caseId===APP.caseId) || EMAILS[0]; if(first) selectMail(first.id);
}
init();
</script>
</body>
</html>
