<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ä»²è£æµ‹è¯• Â· å·¥ä½œå°ï¼ˆçŸ©é˜µ+Recap+åˆåŒ+è‡ªåŠ¨å›å¤ï¼‰ & é‚®ä»¶ä¸€ä½“</title>
<style>
  :root{
    --ink:#0f172a; --muted:#667085; --line:#e6edf5; --bg:#f6f9fc; --brand:#2f6efb;
    --shadow:0 10px 28px rgba(15,23,42,.08);
    --left:280px; --list:420px; --side:360px; --gut:8px;
  }
  *{box-sizing:border-box} html,body{height:100%} body{margin:0;font:14px/1.55 -apple-system,BlinkMacSystemFont,"Segoe UI","PingFang SC",Arial,sans-serif;color:var(--ink);background:var(--bg)}

  /* é¡¶éƒ¨æ¡ */
  .topbar{height:54px;display:flex;align-items:center;justify-content:space-between;padding:0 12px;background:#fff;border-bottom:1px solid var(--line);position:sticky;top:0;z-index:10}
  .brand{font-weight:800}
  .row{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
  .seg{display:flex;border:1px solid var(--line);border-radius:10px;overflow:hidden;background:#fff}
  .seg button{height:32px;border:0;background:transparent;padding:0 14px;cursor:pointer}
  .seg button.on{background:#2f6efb;color:#fff}
  .btn{height:32px;padding:0 12px;border:1px solid var(--line);border-radius:10px;background:#fff;cursor:pointer}
  .btn.primary{background:#2f6efb;border-color:#2f6efb;color:#fff}
  .select{height:32px;border:1px solid var(--line);border-radius:10px;background:#fff;padding:0 10px}

  /* è§†å›¾åˆ‡æ¢å®¹å™¨ */
  .view{display:none}
  .view.active{display:block}

  /* ===== å·¥ä½œå°ï¼ˆçŸ©é˜µ+é‡‡çº³+åˆåŒ+è‡ªåŠ¨å›å¤ï¼‰ ===== */
  .desk{padding:12px}
  .desk-grid{display:grid;grid-template-columns:1.1fr .9fr;gap:12px}
  .card{background:#fff;border:1px solid var(--line);border-radius:12px;box-shadow:var(--shadow);padding:12px}
  .card h3{margin:0 0 8px}
  .muted{color:#64748b}
  .mini{height:28px;padding:0 10px;border:1px solid var(--line);border-radius:8px;background:#fff;cursor:pointer;font-size:12px}
  .mini.primary{background:#2f6efb;border-color:#2f6efb;color:#fff}
  .ghost{height:28px;padding:0 10px;border:1px dashed #dbeafe;border-radius:8px;background:#f8fbff;cursor:pointer;font-size:12px}
  .bar{display:flex;align-items:center;gap:8px;flex-wrap:wrap}

  /* çŸ©é˜µè¡¨ */
  .matrix-wrap{border:1px solid var(--line);border-radius:10px;overflow:auto;max-height:52vh;background:#fff}
  table{border-collapse:collapse;width:100%}
  th,td{border-bottom:1px solid #eef2f7;padding:8px 10px;vertical-align:top;font-size:13px}
  th{position:sticky;top:0;background:#fbfdff;z-index:1}
  .m-topic{font-weight:700}
  .m-sub{color:#64748b;font-size:12px}
  .m-badge{display:inline-flex;align-items:center;gap:6px;padding:2px 8px;border-radius:999px;border:1px solid var(--line);background:#fbfdff;font-size:12px;color:#475569;margin-right:4px}
  .m-badge.us{background:#eef2ff;border-color:#dbeafe}
  .m-badge.them{background:#fff1f2;border-color:#ffe4e6}
  .m-badge.ai{background:#ecfeff;border-color:#cffafe}
  .mini-link{font-size:12px;color:#2f6efb;cursor:pointer}

  /* å³ä¾§ï¼šé‡‡çº³æ¸…å• & Recap è‰ç¨¿ & è‡ªåŠ¨å›å¤ */
  .tabs{display:flex;gap:6px;margin-bottom:8px}
  .tabs button{height:28px;padding:0 10px;border:1px solid var(--line);background:#fff;border-radius:8px;cursor:pointer}
  .tabs button.on{background:#eef2ff;border-color:#dbeafe}
  .pick-list{display:flex;flex-direction:column;gap:8px}
  .pick-row{display:flex;justify-content:space-between;gap:8px;border:1px solid var(--line);border-radius:10px;padding:8px}
  .cap{color:#64748b}
  textarea{width:100%;min-height:180px;border:1px solid var(--line);border-radius:10px;padding:8px;font-family:ui-monospace,Menlo,Consolas,monospace}

  /* åº•éƒ¨ï¼šåˆåŒé¢„è§ˆ */
  .contract{margin-top:12px}
  .contract textarea{min-height:28vh}

  /* ===== é‚®ä»¶é¡µï¼ˆä¿æŒä½ çš„ä¿®å¤ç‰ˆï¼‰ ===== */
  .layout{height:calc(100vh - 54px);display:grid;grid-template-columns:var(--left) var(--gut) var(--list) var(--gut) 1fr var(--gut) var(--side)}
  .col{min-width:0;overflow:auto}
  .left{background:#fff;border-right:1px solid var(--line);padding:12px 10px}
  .group{margin-bottom:10px}
  .g-head{display:flex;align-items:center;justify-content:space-between;padding:8px;border-radius:10px;font-weight:700;background:#f7fafc;border:1px solid var(--line);cursor:pointer}
  .g-head:hover{background:#f1f6ff}
  .g-title{display:flex;align-items:center;gap:8px}
  .caret{transition:.2s}
  .g-body{margin-top:6px;border-left:2px solid #eaf1fb;padding-left:8px;display:flex;flex-direction:column;gap:6px}
  .item{display:flex;justify-content:space-between;align-items:center;padding:6px 8px;border-radius:10px;cursor:pointer}
  .item:hover{background:#f8fbff}
  .item.active{background:#e7efff}
  .name{white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .subctrl{display:flex;align-items:center;gap:8px}
  .badge{min-width:18px;height:18px;padding:0 6px;border-radius:999px;background:#eef2ff;color:#334155;font-size:12px;display:inline-flex;align-items:center;justify-content:center}
  .tiny{border:1px solid var(--line);border-radius:8px;height:28px;padding:0 10px;background:#fff;cursor:pointer;font-size:12px}
  .tiny.primary{background:#2f6efb;color:#fff;border-color:#2f6efb}
  .tiny[data-act="toggle"]{width:28px;padding:0;display:flex;align-items:center;justify-content:center}
  .sublist{display:flex;flex-direction:column;gap:6px;margin-left:14px}
  .pdf-list{display:flex;flex-direction:column;gap:6px}
  .pdf-row{display:grid;grid-template-columns:20px 1fr auto auto;align-items:center;gap:8px;padding:6px 8px;border:1px solid var(--line);border-radius:10px;background:#fff}
  .pdf-ico{text-align:center}
  .pdf-name{white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .link-row{display:grid;grid-template-columns:20px 1fr auto;align-items:center;gap:8px;padding:6px 8px;border:1px dashed #e5eaf5;border-radius:10px;background:#fbfdff}
  .pdf-empty{padding:8px;border:1px dashed #e5eaf5;border-radius:10px;background:#fbfdff;color:#94a3b8}

  .list-wrap{display:flex;flex-direction:column;height:100%;background:#fff;border-right:1px solid var(--line)}
  .toolbar{display:flex;gap:10px;align-items:center;padding:8px;border-bottom:1px solid var(--line)}
  .pill{border:1px solid var(--line);border-radius:999px;padding:2px 10px;background:#fff;color:#334155}
  .search{flex:1;display:flex;gap:8px;align-items:center;background:#f7f9fd;border:1px solid var(--line);border-radius:10px;padding:6px 10px}
  .search input{flex:1;border:none;background:transparent;outline:none}
  .list{overflow:auto}
  .section-hd{position:sticky;top:0;background:#fff;padding:6px 10px;color:#7a869f;font-size:12px;border-top:1px solid var(--line);border-bottom:1px solid var(--line)}
  .row-mail{display:grid;grid-template-columns:10px 1fr auto;gap:8px;align-items:center;padding:9px 10px;border-bottom:1px solid var(--line);cursor:pointer}
  .row-mail:hover{background:#f8fbff} .dot{width:8px;height:8px;border-radius:50%;background:#d1d9e8;margin-left:2px}
  .subject{font-weight:650;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}
  .meta{color:#6b7280;font-size:12px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

  .reader{display:flex;flex-direction:column;height:100%}
  .stage{padding:12px}
  .paper{background:#fff;border:1px solid var(--line);box-shadow:var(--shadow);border-radius:12px;padding:0}
  .mailbar{display:flex;gap:6px;flex-wrap:wrap;align-items:center;padding:8px;border-bottom:1px solid var(--line);background:#fbfbfe;border-top-left-radius:12px;border-top-right-radius:12px}
  .mb-btn{height:28px;padding:0 10px;border:1px solid var(--line);border-radius:8px;background:#fff;cursor:pointer;font-size:12px}
  .mb-btn:hover{background:#f5f7ff}
  .header{padding:10px 12px;border-bottom:1px solid var(--line)}
  .h-subject{font-weight:800;font-size:18px;margin-bottom:6px}
  .h-line{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin:6px 0}
  .pill-addr{background:#fff6d7;border:1px solid #f0e3b1;padding:0 8px;height:22px;display:inline-flex;align-items:center;border-radius:999px;font-size:12px}
  .kv{font-weight:700;color:#475569;width:56px}
  .r-grid{display:grid;grid-template-columns:360px 1fr;gap:14px;padding:12px}
  .kp{border:1px dashed #dbeafe;background:#f8fbff;border-radius:10px;padding:10px}
  .info{border:1px solid var(--line);border-radius:10px;padding:10px}
  .kvline{display:flex;flex-wrap:wrap;gap:8px;margin-top:6px}
  .chip{padding:2px 8px;border:1px solid #e3e8ff;background:#eef2ff;border-radius:999px}
  .chip.link{cursor:pointer}
  .attachments{grid-column:1/3;display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
  .file{border:1px solid var(--line);border-radius:8px;padding:6px 10px;background:#fff}
  .body{grid-column:1/3;white-space:pre-wrap;margin-top:6px;line-height:1.8}

  .pdf-card{grid-column:1/3;margin-top:12px;border:1px solid var(--line);border-radius:12px;box-shadow:var(--shadow);background:#fff}
  .pdf-toolbar{display:flex;gap:8px;align-items:center;justify-content:space-between;padding:8px 10px;border-bottom:1px solid var(--line);background:#fbfdff;border-top-left-radius:12px;border-top-right-radius:12px}
  .pdf-tools{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .pdf-wrap{height:56vh;overflow:hidden;border-bottom-left-radius:12px;border-bottom-right-radius:12px}
  .pdf-frame{width:100%;height:100%;border:0;display:block;background:#f6f9fc}

  .side{background:#fff;border-left:1px solid var(--line);padding:10px}
  .kvtable{width:100%;border-collapse:collapse}
  .kvtable td{padding:6px 4px;border-bottom:1px dashed #eef2f7;font-size:13px}
  .op-group{display:flex;gap:8px;flex-wrap:wrap}
  .switch{display:inline-flex;align-items:center;gap:6px}
  .switch input{accent-color:#2f6efb}
  .bookmark{display:flex;justify-content:space-between;align-items:center;padding:6px 8px;border-radius:8px}
  .bookmark:hover{background:#f7faff}
  .rel-list{display:flex;flex-direction:column;gap:8px}
  .rel-item{display:flex;justify-content:space-between;gap:8px}
  .rel-item a{color:#0f172a;text-decoration:none}
  .rel-meta{color:#64748b;font-size:12px}

  @media (max-width:1360px){
    :root{--side:0px}
    #mailSide{display:none}
    .layout{grid-template-columns:var(--left) var(--gut) var(--list) var(--gut) 1fr}
    .r-grid{grid-template-columns:1fr}
    .attachments,.body,.pdf-card{grid-column:1/1}
  }
</style>
</head>
<body>
  <!-- é¡¶éƒ¨ -->
  <div class="topbar">
    <div class="row">
      <div class="brand">ArbiMail</div>
      <!-- èº«ä»½åˆ‡æ¢ -->
      <div class="seg" id="roleSeg">
        <button data-role="counsel">ä»£ç†å¾‹å¸ˆ</button>
        <button data-role="arbitrator">ä»²è£å‘˜</button>
      </div>
      <!-- æ¡ˆä»¶ä¸‹æ‹‰ -->
      <select id="caseSelect" class="select"></select>
      <!-- é¡µç­¾ -->
      <div class="seg" id="tabSeg">
        <button data-tab="desk">å·¥ä½œå°</button>
        <button data-tab="mail">é‚®ä»¶</button>
      </div>
    </div>
    <div class="row">
      <button class="btn" onclick="window.print()">å¯¼å‡ºPDF</button>
      <button class="btn primary">æ–°å»ºæ¡ˆä»¶</button>
    </div>
  </div>

  <!-- ===== è§†å›¾ï¼šå·¥ä½œå° ===== -->
  <div id="deskView" class="view active">
    <div class="desk">
      <div class="desk-grid">
        <!-- å·¦ï¼šçŸ©é˜µè¡¨ -->
        <div class="card">
          <div class="bar" style="justify-content:space-between">
            <h3 style="margin:0">çŸ©é˜µï¼ˆæŠ½å–è‡ªé‚®ä»¶ï¼‰</h3>
            <div class="bar">
              <button class="mini" id="btnPickAIAll">AI ä¸€é”®é‡‡çº³</button>
              <button class="mini" id="btnClearPicks">æ¸…ç©ºé‡‡çº³</button>
              <span class="muted" id="matrixHint">è¯·é€‰æ‹©æ¡ˆä»¶åæŸ¥çœ‹ã€‚</span>
            </div>
          </div>
          <div class="matrix-wrap">
            <table id="matrixTbl">
              <thead>
                <tr>
                  <th style="width:220px">è®®é¢˜</th>
                  <th>æˆ‘æ–¹</th><th>å¯¹æ–¹</th><th>AI</th>
                  <th style="width:200px">é‡‡çº³</th>
                  <th style="width:100px">è¯æ®</th>
                </tr>
              </thead>
              <tbody id="matrixBody"><tr><td colspan="6" style="text-align:center;color:#94a3b8">â€” é€‰æ‹©æ¡ˆä»¶ä»¥ç”ŸæˆçŸ©é˜µ â€”</td></tr></tbody>
            </table>
          </div>
        </div>

        <!-- å³ï¼šé‡‡çº³æ¸…å• / Recap è‰ç¨¿ / è‡ªåŠ¨å›å¤ -->
        <div class="card">
          <div class="tabs">
            <button id="tabPicks" class="on">å·²é‡‡çº³æ¸…å•</button>
            <button id="tabRecap">Recap è‰ç¨¿</button>
            <button id="tabReply">è‡ªåŠ¨å›å¤</button>
          </div>

          <!-- å·²é‡‡çº³æ¸…å• -->
          <div id="picksPane">
            <div class="bar" style="margin-bottom:6px">
              <span class="muted">åŒæ­¥å·¦ä¾§å•é€‰ï¼Œæ”¯æŒåˆ é™¤/ä¸Šç§»/ä¸‹ç§»</span>
              <span style="flex:1"></span>
              <button class="mini" id="btnCopyPicks">å¤åˆ¶æ¸…å•</button>
            </div>
            <div class="pick-list" id="pickList"><div class="muted">æš‚æ— é‡‡çº³é¡¹ã€‚</div></div>
          </div>

          <!-- Recap è‰ç¨¿ -->
          <div id="recapPane" style="display:none">
            <div class="bar" style="margin-bottom:6px">
              <select id="recapTone" class="select" style="height:28px">
                <option value="auto">è·Ÿéšèº«ä»½ï¼ˆå½“å‰ï¼‰</option>
                <option value="counsel">ä»£ç†å¾‹å¸ˆè¯­æ°”</option>
                <option value="arbitrator">ä»²è£å‘˜è¯­æ°”</option>
              </select>
              <button class="mini" id="btnRegenRecap">é‡æ–°ç”Ÿæˆ</button>
              <button class="mini" id="btnCopyRecap">å¤åˆ¶</button>
              <button class="mini" id="btnSaveRecap">ä¿å­˜è‰ç¨¿</button>
              <button class="mini" id="btnLoadRecap">æ¢å¤è‰ç¨¿</button>
            </div>
            <textarea id="recapDraft" placeholder="ç³»ç»Ÿå°†åŸºäºé‡‡çº³æ¸…å•ä¸æ¡ˆä»¶è¦ç‚¹ï¼Œç”Ÿæˆ Recap è‰ç¨¿â€¦"></textarea>
          </div>

          <!-- è‡ªåŠ¨å›å¤ï¼ˆåˆ†èº«ç³»ç»Ÿï¼‰ -->
          <div id="replyPane" style="display:none">
            <div class="bar" style="margin-bottom:6px;gap:6px">
              <select id="replyTone" class="select" style="height:28px">
                <option value="auto">è·Ÿéšèº«ä»½ï¼ˆå½“å‰ï¼‰</option>
                <option value="counsel">ä»£ç†å¾‹å¸ˆè¯­æ°”</option>
                <option value="arbitrator">ä»²è£å‘˜è¯­æ°”</option>
              </select>
              <select id="replyBase" class="select" style="height:28px">
                <option value="email">åŸºäºå½“å‰é€‰ä¸­é‚®ä»¶</option>
                <option value="picks">åŸºäºå·²é‡‡çº³æ¸…å•</option>
              </select>
              <button class="mini" id="btnRegenReply">é‡æ–°ç”Ÿæˆ</button>
              <button class="mini" id="btnCopyReply">å¤åˆ¶</button>
              <button class="mini" id="btnSaveReply">ä¿å­˜è‰ç¨¿</button>
              <button class="mini" id="btnLoadReply">æ¢å¤è‰ç¨¿</button>
            </div>
            <div class="muted" id="replyCtx" style="margin-bottom:6px">â€”</div>
            <textarea id="replyDraft" placeholder="è‡ªåŠ¨å›å¤è‰ç¨¿ä¼šåœ¨æ­¤ç”Ÿæˆï¼Œå¯ç›´æ¥å¤åˆ¶åˆ°é‚®ç®±å®¢æˆ·ç«¯â€¦"></textarea>
          </div>
        </div>
      </div>

      <!-- åº•éƒ¨ï¼šåˆåŒé¢„è§ˆ -->
      <div class="card contract">
        <div class="bar" style="margin-bottom:6px">
          <h3 style="margin:0">åˆåŒ/ç¨‹åºä»¤ é¢„è§ˆ</h3>
          <select id="tplSelect" class="select" style="height:28px">
            <option value="recap">Recapï¼ˆç¡®è®¤å‡½ï¼‰</option>
            <option value="po1">ç¨‹åºä»¤ PO-1ï¼ˆç®€ç‰ˆï¼‰</option>
          </select>
          <button class="mini primary" id="btnGenContract">ä¸€é”®ç”ŸæˆåˆåŒ</button>
          <button class="mini" id="btnCopyContract">å¤åˆ¶</button>
          <button class="mini" id="btnDownloadTxt">ä¸‹è½½TXT</button>
        </div>
        <textarea id="contractBox" placeholder="ç‚¹å‡»â€œä¸€é”®ç”ŸæˆåˆåŒâ€åœ¨æ­¤ç”Ÿæˆå¯ç¼–è¾‘æ–‡æœ¬â€¦"></textarea>
      </div>
    </div>
  </div>

  <!-- ===== è§†å›¾ï¼šé‚®ä»¶ï¼ˆä¿®å¤ç‰ˆï¼‰ ===== -->
  <div id="mailView" class="view">
    <div class="layout">
      <!-- å·¦ -->
      <div class="col left">
        <div class="group">
          <div class="g-head" data-toggle="mbx"><div class="g-title"><span class="caret">â–¾</span> é‚®ä»¶ç®±</div></div>
          <div class="g-body" id="mbxBody">
            <div class="item" data-mailbox="inbox"><div class="name">æ”¶ä»¶ç®±</div><div class="subctrl"><span class="badge" id="b_inbox">0</span></div></div>
            <div class="item" data-mailbox="sent"><div class="name">å·²å‘é€</div><div class="subctrl"><span class="badge" id="b_sent">0</span></div></div>
            <div class="item" data-mailbox="flag"><div class="name">çº¢æ——é‚®ä»¶</div><div class="subctrl"><span class="badge" id="b_flag">0</span></div></div>
            <div class="item" data-mailbox="arch"><div class="name">å·²å½’æ¡£</div><div class="subctrl"><span class="badge" id="b_arch">0</span></div></div>
            <div class="item" data-mailbox="unfiled"><div class="name">æœªå½’æ¡£</div><div class="subctrl"><span class="badge" id="b_unfiled">0</span></div></div>
          </div>
        </div>

        <div class="group">
          <div class="g-head" data-toggle="case"><div class="g-title"><span class="caret">â–¾</span> æˆ‘çš„æ¡ˆä»¶</div></div>
          <div class="g-body" id="caseBody"></div>
        </div>

        <div class="group">
          <div class="g-head" data-toggle="shelf">
            <div class="g-title"><span class="caret">â–¾</span> åˆåŒæ–‡ä»¶å¤¹</div>
            <div><button class="tiny" id="btnAddPdf">ï¼‹ æ·»åŠ PDF</button><input id="pdfPicker" type="file" accept="application/pdf" style="display:none"></div>
          </div>
          <div class="g-body" id="shelfBody"></div>
        </div>
      </div>

      <div></div>

      <!-- åˆ—è¡¨ -->
      <div class="col list-wrap">
        <div class="toolbar">
          <div class="search"><span>ğŸ”</span><input id="q" placeholder="æœç´¢ï¼ˆfrom: party: clause: has:attachmentï¼‰"></div>
          <span class="pill" id="viewPill">æ”¶ä»¶ç®±</span>
        </div>
        <div id="list" class="list"></div>
      </div>

      <div></div>

      <!-- é˜…è¯»åŒº -->
      <div class="col reader">
        <div class="stage">
          <article class="paper">
            <div class="mailbar">
              <button class="mb-btn">å›å¤</button>
              <button class="mb-btn">å›å¤å…¨éƒ¨</button>
              <button class="mb-btn">è½¬å‘</button>
              <button class="mb-btn">æ ‡è®°</button>
              <button class="mb-btn">ç§»åŠ¨åˆ°</button>
              <button class="mb-btn" id="btnAutoReply">è‡ªåŠ¨å›å¤</button>
            </div>
            <div class="header" id="mailHeader">
              <div class="h-subject" id="subj">â€”</div>
              <div class="h-line"><div class="kv">å‘ä»¶äºº</div><div id="hFrom"></div></div>
              <div class="h-line"><div class="kv">æ”¶ä»¶äºº</div><div id="hTo"></div></div>
              <div class="h-line" id="ccLine" style="display:none;"><div class="kv">æŠ„é€</div><div id="hCc"></div></div>
              <div class="h-line"><div class="kv">æ—¶é—´</div><div id="hTime"></div></div>
            </div>

            <section class="r-grid">
              <div class="kp"><div style="font-weight:700;margin-bottom:6px">å…³é”®è¦ç‚¹</div><div id="kp"></div></div>
              <div class="info">
                <div style="font-weight:700;margin-bottom:6px">å…³é”®è¯</div>
                <div class="kvline" id="chips"></div>
              </div>
              <div class="attachments" id="attach"></div>
              <div class="body" id="body"></div>

              <div class="pdf-card">
                <div class="pdf-toolbar">
                  <div class="pdf-tools">
                    <button class="mini" id="btnReload">åˆ·æ–°</button>
                    <label class="mini" style="display:flex;align-items:center;gap:6px;cursor:pointer">é€‰æ‹©PDF
                      <input type="file" id="filePicker2" accept="application/pdf" style="display:none">
                    </label>
                    <div class="pdf-chips" id="pdfChips"></div>
                  </div>
                  <div>
                    <input id="pdfPage" placeholder="é¡µç â€¦" style="height:30px;border:1px solid var(--line);border-radius:8px;padding:0 10px;width:90px">
                    <button class="mini" id="btnPage">è·³è½¬</button>
                    <input id="pdfFind" placeholder="åœ¨PDFä¸­æŸ¥æ‰¾â€¦" style="height:30px;border:1px solid var(--line);border-radius:8px;padding:0 10px;width:220px;margin-left:8px">
                    <button class="mini" id="btnFind">æŸ¥æ‰¾</button>
                  </div>
                </div>
                <div class="pdf-wrap"><iframe id="pdfFrame" class="pdf-frame" title="åˆåŒPDF"></iframe></div>
              </div>
            </section>
          </article>
        </div>
      </div>

      <div></div>

      <!-- å³ä¾§ -->
      <div class="col side" id="mailSide">
        <div class="card"><h4>AI æ‘˜è¦</h4><div id="aisum" style="color:#475569">é€‰æ‹©ä¸€å°é‚®ä»¶æŸ¥çœ‹ã€‚</div></div>

        <div class="card">
          <h4>æ™ºèƒ½æŠ½å–å­—æ®µ</h4>
          <table class="kvtable" id="kvExtract">
            <tbody>
              <tr><td style="width:84px;color:#64748b">æ¡ˆä»¶</td><td id="kvCase">â€”</td></tr>
              <tr><td style="color:#64748b">è´¹ç‡/ä»·æ ¼</td><td id="kvRate">â€”</td></tr>
              <tr><td style="color:#64748b">Laycan</td><td id="kvLaycan">â€”</td></tr>
              <tr><td style="color:#64748b">è£…æ¸¯</td><td id="kvLoad">â€”</td></tr>
              <tr><td style="color:#64748b">å¸æ¸¯</td><td id="kvDisc">â€”</td></tr>
              <tr><td style="color:#64748b">è§„åˆ™</td><td id="kvRules">â€”</td></tr>
            </tbody>
          </table>
        </div>

        <div class="card">
          <h4>å…³è”ä¿¡æ¯</h4>
          <div id="relInfo" style="color:#475569">â€”</div>
        </div>

        <div class="card">
          <h4>å¿«é€Ÿæ“ä½œ</h4>
          <div class="op-group">
            <label class="switch"><input type="checkbox" id="opFlag"> çº¢æ——</label>
            <label class="switch"><input type="checkbox" id="opArch"> å½’æ¡£</label>
            <button class="mini" id="opToCase">ç§»è‡³å½“å‰æ¡ˆä»¶</button>
          </div>
        </div>

        <div class="card">
          <h4>ç›¸å…³é‚®ä»¶</h4>
          <div class="rel-list" id="relEmails">â€”</div>
        </div>

        <div class="card">
          <h4>PDF ä¹¦ç­¾</h4>
          <div class="op-group" style="margin-bottom:8px">
            <button class="mini" id="bmAddPage">æ·»åŠ é¡µç ä¹¦ç­¾</button>
            <button class="mini" id="bmAddSearch">æ·»åŠ å…³é”®å­—ä¹¦ç­¾</button>
            <button class="mini" id="bmClear">æ¸…ç©º</button>
          </div>
          <div id="bmList">æš‚æ— ä¹¦ç­¾</div>
        </div>
      </div>
    </div>
  </div>

<script>
/* ===== ç¤ºä¾‹æ•°æ®ï¼ˆä¸â€œä»²è£æµ‹è¯•â€ä¸€è‡´ï¼‰ ===== */
var PDFS=[{id:'pdfA',name:'Test Contract (ClickDimensions)',url:'https://www.clickdimensions.com/links/TestPDFfile.pdf'},
          {id:'pdfB',name:'W3C Dummy PDF',url:'https://www.w3.org/WAI/ER/tests/xhtml/testfiles/resources/pdf/dummy.pdf'},
          {id:'pdfC',name:'Mozilla Sample (PDF.js)',url:'https://mozilla.github.io/pdf.js/web/compressed.tracemonkey-pldi-09.pdf'}];
var CASES=[{id:'C-001',name:'[ICSID] Procedural Order No.1 å¯¹é½',color:'#3b82f6',pdfIds:['pdfC']},
           {id:'C-002',name:'MV Ocean Star â€” Main Terms',color:'#10b981',pdfIds:['pdfA']},
           {id:'C-003',name:'MV Silver Wave â€” Spot Voyage',color:'#f59e0b',pdfIds:[]}];
var MAILBOXES=[{id:'inbox',name:'æ”¶ä»¶ç®±'},{id:'sent',name:'å·²å‘é€'},{id:'flag',name:'çº¢æ——é‚®ä»¶'},{id:'arch',name:'å·²å½’æ¡£'},{id:'unfiled',name:'æœªå½’æ¡£'}];
var EMAILS=[
  {id:'e1',folder:'inbox',flag:true,arch:false,subject:'Proposed edits â€” Quorum & Procedural Language',from:'claimant.counsel@example.com',to:['respondent.counsel@example.com'],cc:[],date:'2025-08-12 10:30',
   body:'We propose: (i) Option 1 (two-person quorum) in Â§4; (ii) Procedural Language: English only (Option 1) in Â§11; (iii) transcript be available in real-time; (iv) Production of Documents to follow ICSID Rules 33â€“36.',
   attachments:[{name:'TestPDFfile.pdf',url:'https://www.clickdimensions.com/links/TestPDFfile.pdf'}],
   tags:{topic:['Quorum','Procedural Language','Hearings','Production of Documents']},caseId:'C-001'},
  {id:'e2',folder:'inbox',flag:false,arch:false,subject:'Re: Edits â€” Publication Option 2',from:'respondent.counsel@example.com',to:['claimant.counsel@example.com'],cc:[],date:'2025-08-12 14:10',
   body:'In Â§23, we prefer Publication Option 2 (award published only with both parties consent).',
   attachments:[],tags:{topic:['Publication','Option 2']},caseId:'C-001'},
  {id:'e3',folder:'inbox',flag:false,arch:false,subject:'Offer freight at USD 56,000 PDPR for 12 months',from:'broker@ship.com',to:['owners@co.com','charterer@qs.com'],cc:[],date:'2025-08-11 09:12',
   body:'Laycan 19â€“25 Nov. Load port Beira, discharge Tianjin. Time counting SHINC. Please confirm.',
   attachments:[{name:'W3C Dummy.pdf',url:'https://www.w3.org/WAI/ER/tests/xhtml/testfiles/resources/pdf/dummy.pdf'}],
   tags:{topic:['Laycan','PDPR','NOR','SHINC','Beira','Tianjin']},caseId:'C-002'},
  {id:'e4',folder:'inbox',flag:true,arch:false,subject:'NOR validity question at Beira (SHINC)',from:'charterer@qs.com',to:['owners@co.com'],cc:[],date:'2025-08-10 08:23',
   body:'Please confirm NOR tendering window at Beira and applicable SHINC rule.',
   attachments:[],tags:{topic:['NOR','SHINC','Beira']},caseId:'C-002'},
  {id:'e5',folder:'inbox',flag:false,arch:false,subject:'MV Silver Wave â€” recap (Busan to Manila, 25â€“27 Aug)',from:'broker@sea.com',to:['ops@ship.com'],cc:[],date:'2025-08-11 16:05',
   body:'Fixture recap attached; laycan 25â€“27 Aug, Busan to Manila.',
   attachments:[{name:'Mozilla Sample.pdf',url:'https://mozilla.github.io/pdf.js/web/compressed.tracemonkey-pldi-09.pdf'}],
   tags:{topic:['Laycan','Recap','Busan','Manila']},caseId:'C-003'}
];

/* ===== å°å·¥å…· & å…¨å±€çŠ¶æ€ ===== */
function $(s){return document.querySelector(s);}
function fmtDate(s){var d=new Date(s);function p(n){return (n<10?'0':'')+n;}return d.getFullYear()+'-'+p(d.getMonth()+1)+'-'+p(d.getDate())+' '+p(d.getHours())+':'+p(d.getMinutes());}
function groupLabel(d){var dd=Math.floor((new Date()-new Date(d))/86400000);return dd<=0?'ä»Šå¤©':dd===1?'æ˜¨å¤©':'æ›´æ—©';}
function findOne(a,p){for(var i=0;i<a.length;i++){if(p(a[i]))return a[i];}return null;}
var APP={role:localStorage.getItem('arbimail.role')||'counsel', tab:localStorage.getItem('arbimail.tab')||'desk', caseId:localStorage.getItem('arbimail.case')||CASES[0].id};
var pendingPdfSearch=null;
var CURRENT_MAIL_ID=null;

/* ===== èº«ä»½/é¡µç­¾/æ¡ˆä»¶ ===== */
function applyRole(){
  document.querySelectorAll('#roleSeg button').forEach(function(b){ b.classList.toggle('on', b.getAttribute('data-role')===APP.role); });
}
function applyTab(){
  document.querySelectorAll('#tabSeg button').forEach(function(b){ b.classList.toggle('on', b.getAttribute('data-tab')===APP.tab); });
  document.querySelectorAll('.view').forEach(function(v){ v.classList.remove('active'); });
  (APP.tab==='desk'?$('#deskView'):$('#mailView')).classList.add('active');
  localStorage.setItem('arbimail.tab',APP.tab);
}
function initTop(){
  // è§’è‰²
  document.querySelectorAll('#roleSeg button').forEach(function(b){
    b.onclick=function(){ APP.role=this.getAttribute('data-role'); localStorage.setItem('arbimail.role',APP.role); applyRole(); regenRecapDraft(); regenReplyDraft(); };
  });
  applyRole();
  // æ¡ˆä»¶
  var sel=$('#caseSelect'); sel.innerHTML=CASES.map(function(c){return '<option value="'+c.id+'">'+c.name+'</option>';}).join('');
  sel.value=APP.caseId; sel.onchange=function(){ APP.caseId=this.value; localStorage.setItem('arbimail.case',APP.caseId); refreshAllForCase(); };
  // é¡µç­¾
  document.querySelectorAll('#tabSeg button').forEach(function(b){ b.onclick=function(){ APP.tab=this.getAttribute('data-tab'); applyTab(); if(APP.tab==='mail' && pendingPdfSearch){ setTimeout(function(){ jumpSearch(pendingPdfSearch); pendingPdfSearch=null; },100); } }; });
  applyTab();
}

/* ====== çŸ©é˜µè§„åˆ™/æ„å»º ====== */
function mailSide(email){
  if(/claimant\.counsel/i.test(email.from)) return 'us';
  if(/respondent\.counsel/i.test(email.from)) return 'them';
  return 'neutral';
}
var MATRIX_RULES=[
 {key:'quorum',title:'Presence & Quorumï¼ˆæ³•å®šäººæ•°ï¼‰',
  hit:function(t){return /quorum/i.test(t)||/two[-\s]?person/i.test(t);},
  norm:function(t){if(/two[-\s]?person/i.test(t))return'Option 1ï¼šä¸¤äººæˆå‘˜åˆ°åœºä¸ºæ³•å®šäººæ•°';return'ç»´æŒå¸¸è§„æ³•å®šäººæ•°ï¼ˆæœªæŒ‡æ˜ï¼‰';}},
 {key:'language',title:'Procedural Languageï¼ˆç¨‹åºè¯­è¨€ï¼‰',
  hit:function(t){return /procedural\s+language/i.test(t)||/english only/i.test(t);},
  norm:function(t){return /english\s+only/i.test(t)?'Option 1ï¼šä»…ç”¨è‹±æ–‡':'åŒè¯­/æœªæŒ‡æ˜';}},
 {key:'publication',title:'Publicationï¼ˆè£å†³å…¬å¸ƒï¼‰',
  hit:function(t){return /publication\s+option/i.test(t);},
  norm:function(t){var m=t.match(/publication\s+option\s*(\d)/i);return m?('Option '+m[1]):'æœªæŒ‡æ˜';}},
 {key:'transcript',title:'Hearing Transcriptï¼ˆåº­å®¡é€Ÿè®°ï¼‰',
  hit:function(t){return /transcript/i.test(t);},
  norm:function(t){return /real[-\s]?time/i.test(t)?'å®æ—¶é€Ÿè®°':'å¸¸è§„é€Ÿè®°';}},
 {key:'production',title:'Production of Documentsï¼ˆæ–‡ä¹¦å±•ç¤ºï¼‰',
  hit:function(t){return /production of documents|rules?\s*33[\-\â€“]36/i.test(t);},
  norm:function(){return'ä¾ ICSID è§„åˆ™ 33â€“36';}},
 {key:'laycan',title:'Laycanï¼ˆè£…æœŸï¼‰',
  hit:function(t){return /laycan/i.test(t);},
  norm:function(t){var m=t.match(/laycan[^0-9]*([0-3]?\d[\-\â€“â€”][0-3]?\d\s*(Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec))/i);return m?m[1]:'æœªæŒ‡æ˜';}},
 {key:'ports',title:'è£…/å¸æ¸¯',
  hit:function(t){return /load\s*port|discharge/i.test(t);},
  norm:function(t){var l=t.match(/Load\s*port\s*([A-Za-z][A-Za-z\s\-]+)/i);var d=t.match(/discharge\s*([A-Za-z][A-Za-z\s\-]+)/i);return (l?('è£… '+l[1].trim()):'è£…æœªæŒ‡æ˜')+'ï¼›'+(d?('å¸ '+d[1].trim()):'å¸æœªæŒ‡æ˜');}},
 {key:'rate',title:'è´¹ç‡/è§„åˆ™',
  hit:function(t){return /USD/i.test(t)||/PDPR/i.test(t)||/SHINC/i.test(t);},
  norm:function(t){var r=t.match(/USD[\s$]*([\d,]+)\s*PDPR/i);var s=/SHINC/i.test(t)?'ï¼›SHINC':'';return r?('USD '+r[1]+' PDPR'+s):('ï¼ˆæœªæ˜ï¼‰'+s);}},
 {key:'nor',title:'NORï¼ˆå‡†å¤‡å°±ç»ªé€šçŸ¥ï¼‰',
  hit:function(t){return /\bNOR\b/i.test(t);},
  norm:function(t){return /window|valid/i.test(t)?'NOR æœ‰æ•ˆæ€§/æ—¶é—´çª—éœ€ç¡®è®¤':'NOR æ¡æ¬¾';}}
];
function buildMatrix(caseId){
  var mails=EMAILS.filter(function(e){return e.caseId===caseId;});
  var rows={};
  mails.forEach(function(m){
    var t=(m.subject||'')+'\n'+(m.body||'');
    MATRIX_RULES.forEach(function(r){
      if(r.hit(t)){
        var val=r.norm(t);
        if(!rows[r.key]) rows[r.key]={key:r.key,title:r.title,us:null,them:null,neutral:null,ai:null};
        var side=mailSide(m);
        rows[r.key][side]=rows[r.key][side]||{text:val,mailId:m.id,from:m.from,date:m.date};
      }
    });
  });
  Object.keys(rows).forEach(function(k){
    var r=rows[k];
    var pick=r.us && r.them ? ((r.us.text.length>=r.them.text.length)?r.us:r.them) : (r.us||r.them||r.neutral);
    r.ai=pick?{text:pick.text,from:'AI',mailId:(pick.mailId||null),date:pick.date}:null;
  });
  return Object.keys(rows).map(function(k){return rows[k];});
}

/* ===== å·¥ä½œå°ï¼šçŸ©é˜µæ¸²æŸ“ + é‡‡çº³æ¸…å• ===== */
function picksKey(){ return 'arbimail.matrix.pick.'+APP.caseId; }
function getPicks(){ try{return JSON.parse(localStorage.getItem(picksKey())||'{}');}catch(e){return {}} }
function setPicks(o){ localStorage.setItem(picksKey(),JSON.stringify(o)); }

function renderMatrix(){
  var body=$('#matrixBody'); var rows=buildMatrix(APP.caseId);
  if(!rows.length){ body.innerHTML='<tr><td colspan="6" style="text-align:center;color:#94a3b8">æœªåœ¨é‚®ä»¶ä¸­è¯†åˆ«åˆ°å¯ç»“æ„åŒ–çš„è®®é¢˜ã€‚</td></tr>'; $('#matrixHint').textContent=''; renderPickList(rows); return; }
  $('#matrixHint').textContent='å·²è¯†åˆ« '+rows.length+' ä¸ªè®®é¢˜';
  var saved=getPicks();
  body.innerHTML='';
  rows.forEach(function(r){
    var tr=document.createElement('tr');
    var td0=document.createElement('td'); td0.innerHTML='<div class="m-topic">'+r.title+'</div><div class="m-sub">'+r.key+'</div>'; tr.appendChild(td0);
    function cell(who,label){
      var td=document.createElement('td'); var d=r[who];
      td.innerHTML=d?('<div class="m-badge '+who+'">'+label+'</div>'+d.text+' <span class="mini-link" data-find="'+encodeURIComponent(d.text)+'">ï¼ˆé«˜äº®ï¼‰</span>'):('<span class="muted">â€”</span>');
      return td;
    }
    tr.appendChild(cell('us','æˆ‘æ–¹')); tr.appendChild(cell('them','å¯¹æ–¹')); tr.appendChild(cell('ai','AI'));
    var tdPick=document.createElement('td'); tdPick.style.whiteSpace='nowrap';
    ['us','them','ai'].forEach(function(k){
      var dis=!r[k]; var checked=(saved[r.key]||'ai')===k && !dis;
      tdPick.innerHTML+='<label style="margin-right:8px;opacity:'+(dis?'.4':'1')+'"><input type="radio" name="pick_'+r.key+'" value="'+k+'" '+(checked?'checked':'')+' '+(dis?'disabled':'')+'> '+({'us':'é‡‡çº³æˆ‘æ–¹','them':'é‡‡çº³å¯¹æ–¹','ai':'é‡‡çº³AI'})[k]+'</label>';
    });
    tr.appendChild(tdPick);

    var tdEv=document.createElement('td');
    var ev=r.us||r.them||r.neutral;
    tdEv.innerHTML=ev?('<span class="mini-link" data-goto="'+ev.mailId+'">æŸ¥çœ‹é‚®ä»¶</span>'):'<span class="muted">â€”</span>';
    tr.appendChild(tdEv);

    body.appendChild(tr);
  });

  body.querySelectorAll('[data-goto]').forEach(function(a){ a.onclick=function(){ APP.tab='mail'; applyTab(); selectMail(this.getAttribute('data-goto')); }; });
  body.querySelectorAll('[data-find]').forEach(function(a){ a.onclick=function(){ var q=decodeURIComponent(this.getAttribute('data-find')); pendingPdfSearch=q; APP.tab='mail'; applyTab(); if($('#pdfFrame').src) setTimeout(function(){ jumpSearch(q); },80); }; });
  body.querySelectorAll('input[type=radio]').forEach(function(rdo){
    rdo.onchange=function(){ var key=this.name.replace('pick_',''); var val=this.value; var saved=getPicks(); saved[key]=val; setPicks(saved); renderPickList(buildMatrix(APP.caseId)); };
  });

  renderPickList(rows);
}
function renderPickList(rows){
  rows=rows||buildMatrix(APP.caseId);
  var list=$('#pickList'); var saved=getPicks();
  var items=[];
  rows.forEach(function(r){
    var k=saved[r.key]||null; if(!k||!r[k]) return;
    items.push({key:r.key,title:r.title,choice:k,text:r[k].text});
  });
  if(!items.length){ list.innerHTML='<div class="muted">æš‚æ— é‡‡çº³é¡¹ã€‚</div>'; return; }
  list.innerHTML='';
  items.forEach(function(it,idx){
    var row=document.createElement('div'); row.className='pick-row';
    row.innerHTML='<div><div>'+it.title+' <span class="cap">ï¼ˆ'+({'us':'æˆ‘æ–¹','them':'å¯¹æ–¹','ai':'AI'}[it.choice])+'ï¼‰</span></div><div class="muted">'+it.text+'</div></div>'+
                  '<div class="bar"><button class="mini" data-act="up" data-k="'+it.key+'">ä¸Šç§»</button><button class="mini" data-act="down" data-k="'+it.key+'">ä¸‹ç§»</button><button class="mini" data-act="del" data-k="'+it.key+'">åˆ é™¤</button></div>';
    list.appendChild(row);
  });
  list.querySelectorAll('button[data-act]').forEach(function(btn){
    btn.onclick=function(){
      var act=this.getAttribute('data-act'); var k=this.getAttribute('data-k'); var saved=getPicks();
      function rebuild(keys){ var o={}; keys.forEach(function(x){ o[x]=saved[x]; }); setPicks(o); renderPickList(rows); }
      if(act==='del'){ delete saved[k]; setPicks(saved); renderPickList(rows); return; }
      var keys=Object.keys(saved); var i=keys.indexOf(k); if(i<0) return;
      if(act==='up' && i>0){ var t=keys[i-1]; keys[i-1]=keys[i]; keys[i]=t; rebuild(keys); }
      if(act==='down' && i<keys.length-1){ var t2=keys[i+1]; keys[i+1]=keys[i]; keys[i]=t2; rebuild(keys); }
    };
  });
}

/* ===== Recap è‰ç¨¿ & åˆåŒæ¨¡æ¿ ===== */
function strip(html){var d=document.createElement('div'); d.innerHTML=html; return d.innerText||d.textContent||'';}
var PERSONAS={
  counsel:{name:'ä»£ç†å¾‹å¸ˆ',template:function(sum,lines){
    return [
      'å„ä½å¥½ï¼Œ',
      '',
      'åŸºäºç›®å‰å¾€æ¥é‚®ä»¶ï¼Œæˆ‘æ–¹å¯¹è¦ç‚¹çš„ç†è§£å¦‚ä¸‹ï¼š',
      'â€¢ èˆ¹åï¼š'+(sum.vessel||'â€”'),
      'â€¢ Laycanï¼š'+(sum.laycan||'â€”'),
      'â€¢ è£…/å¸æ¸¯ï¼š'+(sum.load||'â€”')+' / '+(sum.disc||'â€”'),
      'â€¢ è´¹ç‡ï¼š'+(sum.rate||'â€”'),
      'â€¢ è§„åˆ™ï¼š'+(sum.rules&&sum.rules.length?sum.rules.join('ã€'):'â€”'),
      lines&&lines.length?('â€¢ é‡‡çº³è¦ç‚¹ï¼š\n  - '+lines.join('\n  - ')):'',
      '',
      'å¦‚æ— å¼‚è®®ï¼Œæˆ‘æ–¹å°†æ®æ­¤æ›´æ–°Recap/åˆåŒæ¡æ¬¾å¹¶å›ä¼ ã€‚',
      '',
      'æ­¤è‡´'
    ].filter(Boolean).join('\n');
  }},
  arbitrator:{name:'ä»²è£å‘˜',template:function(sum,lines){
    return [
      'å„ä½ä»£ç†äººï¼š',
      '',
      'ä¸ºç¡®ä¿ç¨‹åºæ¸…æ™°ï¼Œç°æ±‡æ€»æœ¬æ¡ˆå½“å‰èŠ‚ç‚¹è¦ç‚¹ï¼š',
      'â€¢ èˆ¹åï¼š'+(sum.vessel||'â€”')+'ï¼›Laycanï¼š'+(sum.laycan||'â€”'),
      'â€¢ è£…/å¸æ¸¯ï¼š'+(sum.load||'â€”')+' / '+(sum.disc||'â€”'),
      'â€¢ è´¹ç‡ä¸è§„åˆ™ï¼š'+(sum.rate||'â€”')+'ï¼›'+(sum.rules&&sum.rules.length?sum.rules.join('ã€'):'â€”'),
      lines&&lines.length?('â€¢ é‡‡çº³è¦ç‚¹ï¼š\n  - '+lines.join('\n  - ')):'',
      '',
      'è‹¥å¯¹ä»¥ä¸Šè¦ç‚¹å­˜åœ¨åˆ†æ­§ï¼Œè¯·åœ¨ä¸¤ä¸ªå·¥ä½œæ—¥å†…ä»¥ä¹¦é¢è¯´æ˜ï¼Œä¾¿äºç¡®å®šåç»­ç¨‹åºå®‰æ’ï¼ˆå«æäº¤é¡ºåºä¸æœŸé™ï¼‰ã€‚'
    ].filter(Boolean).join('\n');
  }}
};
function caseMails(id){return EMAILS.filter(function(e){return e.caseId===id;}).sort(function(a,b){return new Date(a.date)-new Date(b.date);});}
function extractLite(text){
  var res={vessel:null, rate:null, laycan:null, load:null, disc:null, rules:[]};
  var m=text.match(/(MV\s+[A-Za-z][\w\- ]+)/i); if(m) res.vessel=m[1];
  var r, rre=/USD[\s$]*([\d,]+(?:\.\d+)?)\s*(PDPR|PCT|MT|day)?/ig; while((r=rre.exec(text))){ var v=('USD '+r[1]+(r[2]?' '+r[2].toUpperCase():'')); if(!res.rate && /PDPR/i.test(v)) res.rate=v; }
  m=text.match(/Laycan[^0-9]*([0-3]?\d[\-\â€“â€”][0-3]?\d\s*(Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec))/i); if(m) res.laycan=m[1];
  m=text.match(/Load\s*port\s*([A-Za-z][A-Za-z\s\-]+)/i); if(m) res.load=m[1]&&m[1].trim();
  m=text.match(/discharge\s*([A-Za-z][A-Za-z\s\-]+)/i); if(m) res.disc=m[1]&&m[1].trim();
  (text.match(/\b(NOR|SHINC|ICSID)\b/ig)||[]).forEach(function(x){ if(res.rules.indexOf(x.toUpperCase())<0) res.rules.push(x.toUpperCase()); });
  return res;
}
function buildSummary(){
  var mails=caseMails(APP.caseId); if(!mails.length) return {rules:[]};
  var sum={vessel:null,rate:null,laycan:null,load:null,disc:null,rules:[]};
  mails.forEach(function(m){ var e=extractLite((m.subject||'')+'\n'+(m.body||'')); ['vessel','rate','laycan','load','disc'].forEach(function(k){ if(!sum[k]&&e[k]) sum[k]=e[k]; }); e.rules.forEach(function(r){ if(sum.rules.indexOf(r)<0) sum.rules.push(r); }); });
  return sum;
}
function selectedLines(){
  var rows=buildMatrix(APP.caseId); var saved=getPicks(); var out=[];
  rows.forEach(function(r){ var k=saved[r.key]; if(k && r[k] && r[k].text) out.push(r.title+'ï¼š'+r[k].text+'ï¼ˆ'+({'us':'æˆ‘æ–¹','them':'å¯¹æ–¹','ai':'AI'}[k])+'ï¼‰'); });
  return out;
}

/* ===== Recap ç”Ÿæˆ ===== */
function recapKey(){ return 'arbimail.contract.'+APP.caseId+'.'+($('#tplSelect').value||'recap'); }
function regenRecapDraft(){
  var tone=$('#recapTone').value; if(tone==='auto') tone=APP.role;
  var persona=PERSONAS[tone]||PERSONAS.counsel;
  var sum=buildSummary(); var lines=selectedLines();
  $('#recapDraft').value=persona.template(sum,lines);
}
$('#tabPicks').onclick=function(){ this.classList.add('on'); $('#tabRecap').classList.remove('on'); $('#tabReply').classList.remove('on'); $('#picksPane').style.display='block'; $('#recapPane').style.display='none'; $('#replyPane').style.display='none'; };
$('#tabRecap').onclick=function(){ this.classList.add('on'); $('#tabPicks').classList.remove('on'); $('#tabReply').classList.remove('on'); $('#picksPane').style.display='none'; $('#recapPane').style.display='block'; $('#replyPane').style.display='none'; regenRecapDraft(); };
$('#tabReply').onclick=function(){ this.classList.add('on'); $('#tabPicks').classList.remove('on'); $('#tabRecap').classList.remove('on'); $('#picksPane').style.display='none'; $('#recapPane').style.display='none'; $('#replyPane').style.display='block'; regenReplyDraft(); };

$('#recapTone').onchange=regenRecapDraft;
$('#btnRegenRecap').onclick=regenRecapDraft;
$('#btnCopyPicks').onclick=function(){ navigator.clipboard.writeText(selectedLines().join('\n')); };
$('#btnCopyRecap').onclick=function(){ navigator.clipboard.writeText($('#recapDraft').value||''); };
$('#btnSaveRecap').onclick=function(){ localStorage.setItem(recapKey(), $('#recapDraft').value||''); alert('å·²ä¿å­˜è‰ç¨¿'); };
$('#btnLoadRecap').onclick=function(){ var t=localStorage.getItem(recapKey()); if(t!=null){ $('#recapDraft').value=t; } else { alert('æ— ä¿å­˜çš„è‰ç¨¿'); } };

/* ä¸€é”®ç”ŸæˆåˆåŒ */
function genContract(){
  var tpl=$('#tplSelect').value||'recap';
  var sum=buildSummary(); var lines=selectedLines();
  var head=''; var body=''; var foot='';
  if(tpl==='recap'){
    head='Subject: Recap Confirmation â€” '+(findOne(CASES,function(c){return c.id===APP.caseId;})||{}).name+'\n\n';
    body = $('#recapDraft').value || (PERSONAS[APP.role]||PERSONAS.counsel).template(sum,lines);
  }else{ // po1
    head='Procedural Order No.1 (Draft)\n\n';
    body=[
      '1. Presence & Quorum: '+(lines.find(function(x){return x.indexOf('Presence & Quorum')===0;})||'å¾…ç¡®è®¤'),
      '2. Procedural Language: '+(lines.find(function(x){return x.indexOf('Procedural Language')===0;})||'å¾…ç¡®è®¤'),
      '3. Hearing Transcript: '+(lines.find(function(x){return x.indexOf('Hearing Transcript')===0;})||'å¾…ç¡®è®¤'),
      '4. Production of Documents: '+(lines.find(function(x){return x.indexOf('Production of Documents')===0;})||'å¾…ç¡®è®¤'),
      '5. Publication: '+(lines.find(function(x){return x.indexOf('Publication')===0;})||'å¾…ç¡®è®¤'),
      '',
      'Other: Vessel '+(sum.vessel||'â€”')+', Laycan '+(sum.laycan||'â€”')+', Ports '+(sum.load||'â€”')+' / '+(sum.disc||'â€”')+', Rate '+(sum.rate||'â€”')+', Rules '+(sum.rules.join(', ')||'â€”')
    ].join('\n');
  }
  var full=head+body+(foot?('\n\n'+foot):'');
  $('#contractBox').value=full;
}
$('#btnGenContract').onclick=genContract;
$('#btnCopyContract').onclick=function(){ navigator.clipboard.writeText($('#contractBox').value||''); };
$('#btnDownloadTxt').onclick=function(){
  var blob=new Blob([$('#contractBox').value||''],{type:'text/plain;charset=utf-8'});
  var a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=(findOne(CASES,function(c){return c.id===APP.caseId;})||{name:'contract'}).name+'.txt'; a.click();
};

/* å¿«æ·ï¼šAIä¸€é”®é‡‡çº³/æ¸…ç©º */
$('#btnPickAIAll').onclick=function(){
  var rows=buildMatrix(APP.caseId), saved={}; rows.forEach(function(r){ if(r.ai) saved[r.key]='ai'; }); setPicks(saved); renderMatrix();
};
$('#btnClearPicks').onclick=function(){ setPicks({}); renderMatrix(); };

/* ===== è‡ªåŠ¨å›å¤ï¼ˆåˆ†èº«ç³»ç»Ÿï¼‰ ===== */
function replyKey(){ return 'arbimail.reply.'+APP.caseId; }
function getCurrentMailForCase(){
  var m=CURRENT_MAIL_ID ? findOne(EMAILS,function(e){return e.id===CURRENT_MAIL_ID;}) : null;
  if(m && m.caseId===APP.caseId) return m;
  var arr=caseMails(APP.caseId); return arr.length?arr[arr.length-1]:null;
}
function regenReplyDraft(){
  var toneSel=$('#replyTone').value; if(toneSel==='auto') toneSel=APP.role;
  var base=$('#replyBase').value||'email';
  var sum=buildSummary(); var lines=selectedLines();
  var mail=getCurrentMailForCase();
  $('#replyCtx').textContent = mail ? ('å½“å‰é‚®ä»¶ï¼š'+mail.subject+'ï¼ˆ'+fmtDate(mail.date)+'ï¼‰') : 'å½“å‰æ¡ˆä»¶æš‚æ— é‚®ä»¶';
  var header = (toneSel==='counsel') ? 'å„ä½å¥½ï¼Œ' : 'å„ä½ä»£ç†äººï¼š';
  var lead = (base==='email' && mail) ? ('å…³äºã€Š'+mail.subject+'ã€‹ä¸€ä¿¡ï¼Œå›å¤å¦‚ä¸‹ï¼š') : 'åŸºäºå½“å‰å·²é‡‡çº³è¦ç‚¹ï¼Œå›å¤å¦‚ä¸‹ï¼š';
  var bullets = (base==='email' && mail)
      ? ((mail.tags&&mail.tags.topic||[]).length?('â€¢ æ¶‰åŠè®®é¢˜ï¼š'+mail.tags.topic.join('ã€')):'')
      : (lines.length?('â€¢ é‡‡çº³è¦ç‚¹ï¼š\n  - '+lines.join('\n  - ')):'');
  var closing = (toneSel==='counsel') ? 'å¦‚æ— å¼‚è®®ï¼Œæˆ‘ä»¬å°†æ®æ­¤æ¨è¿›ã€‚' : 'è¯·åŒæ–¹åœ¨ä¸¤ä¸ªå·¥ä½œæ—¥å†…ç¡®è®¤ã€‚';
  var txt = [
    header,'',lead,
    'â€¢ èˆ¹åï¼š'+(sum.vessel||'â€”'),
    'â€¢ Laycanï¼š'+(sum.laycan||'â€”'),
    'â€¢ è£…/å¸æ¸¯ï¼š'+(sum.load||'â€”')+' / '+(sum.disc||'â€”'),
    'â€¢ è´¹ç‡ä¸è§„åˆ™ï¼š'+(sum.rate||'â€”')+'ï¼›'+(sum.rules&&sum.rules.length?sum.rules.join('ã€'):'â€”'),
    bullets||null,
    '',closing
  ].filter(Boolean).join('\n');
  $('#replyDraft').value=txt;
}
$('#replyTone').onchange=regenReplyDraft;
$('#replyBase').onchange=regenReplyDraft;
$('#btnRegenReply').onclick=regenReplyDraft;
$('#btnCopyReply').onclick=function(){ navigator.clipboard.writeText($('#replyDraft').value||''); };
$('#btnSaveReply').onclick=function(){ localStorage.setItem(replyKey(), $('#replyDraft').value||''); alert('å·²ä¿å­˜è‰ç¨¿'); };
$('#btnLoadReply').onclick=function(){ var t=localStorage.getItem(replyKey()); if(t!=null){ $('#replyDraft').value=t; } else { alert('æ— ä¿å­˜çš„è‰ç¨¿'); } };

/* ===== é‚®ä»¶é¡µé€»è¾‘ï¼ˆä¸ä½ ä¿®å¤ç‰ˆä¸€è‡´ï¼‰ ===== */
var state={scope:{type:'mailbox',id:'inbox'},selected:null};
function setBadgeCounts(){
  var c={inbox:EMAILS.filter(function(e){return e.folder==='inbox';}).length,
         sent:EMAILS.filter(function(e){return e.folder==='sent';}).length,
         flag:EMAILS.filter(function(e){return e.flag;}).length,
         arch:EMAILS.filter(function(e){return e.arch;}).length,
         unfiled:EMAILS.filter(function(e){return !e.caseId;}).length};
  for(var k in c){var el=document.getElementById('b_'+k);if(el)el.textContent=c[k];}
}
function renderCaseGroup(){
  var wrap=$('#caseBody'); wrap.innerHTML='';
  CASES.forEach(function(c){
    var row=document.createElement('div'); row.className='item'+(state.scope.type==='case'&&state.scope.id===c.id?' active':'');
    row.innerHTML='<div class="name" style="display:flex;align-items:center;gap:8px"><span style="width:8px;height:8px;border-radius:50%;background:'+c.color+'"></span>'+c.name+'</div><div class="subctrl"><button class="tiny" data-act="toggle">â–¾</button><span class="badge">'+EMAILS.filter(function(e){return e.caseId===c.id;}).length+'</span></div>';
    row.onclick=function(ev){
      if(ev.target && ev.target.getAttribute('data-act')==='toggle'){
        var box=wrap.querySelector('.sublist[data-case="'+c.id+'"]'); box.style.display=box.style.display==='none'?'':'none'; ev.stopPropagation(); return;
      }
      state.scope={type:'case',id:c.id}; state.selected=null; renderAllMail();
    };
    wrap.appendChild(row);

    var sub=document.createElement('div'); sub.className='sublist pdf-list'; sub.setAttribute('data-case',c.id);
    if(!c.pdfIds.length){ var emp=document.createElement('div'); emp.className='pdf-empty'; emp.innerText='ï¼ˆæœªå…³è”åˆåŒï¼‰'; sub.appendChild(emp); }
    else c.pdfIds.forEach(function(pid){
      var p=findOne(PDFS,function(x){return x.id===pid;}); if(!p) return;
      var s=document.createElement('div'); s.className='pdf-row';
      s.innerHTML='<div class="pdf-ico">ğŸ“</div><div class="pdf-name" title="'+p.name+'">'+p.name+'</div><button class="tiny primary" data-act="open">æ‰“å¼€</button><button class="tiny" data-act="unlink">ç§»é™¤</button>';
      s.onclick=function(ev){ var act=ev.target && ev.target.getAttribute('data-act'); if(act==='open'){ openPdf(p.url,{zoom:'page-fit'}); setReaderTitleForPdf(p.name); ev.stopPropagation(); } if(act==='unlink'){ c.pdfIds=c.pdfIds.filter(function(x){return x!==pid;}); renderCaseGroup(); ev.stopPropagation(); } };
      sub.appendChild(s);
    });
    var ctrl=document.createElement('div'); ctrl.className='link-row';
    var sel='<select class="tiny" style="width:100%">'; PDFS.forEach(function(p){ sel+='<option value="'+p.id+'">'+p.name+'</option>'; }); sel+='</select>';
    ctrl.innerHTML='<div class="pdf-ico">â•</div>'+sel+'<button class="tiny" data-act="link">å…³è”</button>';
    ctrl.onclick=function(ev){ if(ev.target && ev.target.getAttribute('data-act')==='link'){ var s=ctrl.querySelector('select'); var pid=s.value; if(pid && c.pdfIds.indexOf(pid)<0){ c.pdfIds.push(pid); renderCaseGroup(); } ev.stopPropagation(); } };
    sub.appendChild(ctrl);
    wrap.appendChild(sub);
  });
}
function renderShelf(){
  var wrap=$('#shelfBody'); wrap.innerHTML=''; if(!PDFS.length){ wrap.innerHTML='<div class="pdf-empty">æš‚æ— PDF</div>'; return; }
  PDFS.forEach(function(p){
    var row=document.createElement('div'); row.className='item'+(state.scope.type==='pdf'&&state.scope.id===p.id?' active':'');
    row.innerHTML='<div class="name">ğŸ“„ '+p.name+'</div><div class="subctrl"><span class="badge">PDF</span></div>';
    row.onclick=function(){ state.scope={type:'pdf',id:p.id}; renderAllMail(); openPdf(p.url,{zoom:'page-fit'}); setReaderTitleForPdf(p.name); };
    wrap.appendChild(row);
  });
}
function wireMailboxes(){
  document.querySelectorAll('[data-mailbox]').forEach(function(el){
    el.onclick=function(){ state.scope={type:'mailbox',id:el.getAttribute('data-mailbox')}; state.selected=null; renderAllMail(); };
  });
}
function pool(){
  if(state.scope.type==='case') return EMAILS.filter(function(e){return e.caseId===state.scope.id;});
  if(state.scope.type==='pdf') return [];
  if(state.scope.id==='flag') return EMAILS.filter(function(e){return e.flag;});
  if(state.scope.id==='arch') return EMAILS.filter(function(e){return e.arch;});
  if(state.scope.id==='unfiled') return EMAILS.filter(function(e){return !e.caseId;});
  return EMAILS.filter(function(e){return e.folder===state.scope.id;});
}
function renderList(){
  var arr=pool().sort(function(a,b){return new Date(b.date)-new Date(a.date);});
  var pill= state.scope.type==='case' ? ('æ¡ˆä»¶ Â· '+(findOne(CASES,function(c){return c.id===state.scope.id;})||{}).name) :
           state.scope.type==='pdf'  ? ('PDF Â· '+(findOne(PDFS,function(p){return p.id===state.scope.id;})||{}).name) :
           (findOne(MAILBOXES,function(m){return m.id===state.scope.id;})||{name:'è§†å›¾'}).name;
  $('#viewPill').textContent=pill||'è§†å›¾';
  var box=$('#list'); box.innerHTML='';
  if(state.scope.type==='pdf'){ box.innerHTML='<div style="padding:14px;color:#64748b">å½“å‰åœ¨â€œPDF é¢„è§ˆâ€æ¨¡å¼ã€‚é€‰æ‹©å·¦ä¾§é‚®ä»¶æˆ–æ¡ˆä»¶å¯æ¢å¤åˆ—è¡¨ã€‚</div>'; return; }
  var last=''; arr.forEach(function(e){
    var lb=groupLabel(e.date); if(lb!==last){ last=lb; var hd=document.createElement('div'); hd.className='section-hd'; hd.innerText=lb; box.appendChild(hd); }
    var row=document.createElement('div'); row.className='row-mail';
    row.innerHTML='<div class="dot"></div><div style="min-width:0"><div class="subject">'+e.subject+'</div><div class="meta">'+e.from+' Â· '+(e.to||[]).join(', ')+'</div></div><div class="meta">'+fmtDate(e.date)+'</div>';
    row.onclick=function(){ selectMail(e.id); };
    box.appendChild(row);
  });
}
var currentPdfUrl='';
function pills(addrs){return (addrs||[]).map(function(a){return '<span class="pill-addr">'+a+'</span>';}).join(' ');}
function selectMail(id){
  var e=findOne(EMAILS,function(x){return x.id===id;}); if(!e) return; state.selected=id; CURRENT_MAIL_ID=id;
  APP.caseId=e.caseId; $('#caseSelect').value=APP.caseId; // åŒæ­¥æ¡ˆä»¶
  $('#subj').textContent=e.subject;
  $('#hFrom').innerHTML=pills([e.from]); $('#hTo').innerHTML=pills(e.to||[]);
  if(e.cc && e.cc.length){ $('#ccLine').style.display='flex'; $('#hCc').innerHTML=pills(e.cc); } else { $('#ccLine').style.display='none'; }
  $('#hTime').textContent=fmtDate(e.date);
  $('#kp').innerHTML='â€¢ è®®é¢˜ï¼š'+((e.tags&&e.tags.topic)||[]).join('ã€')+'<br>â€¢ å…³è”æ¡ˆä»¶ï¼š'+((findOne(CASES,function(c){return c.id===e.caseId;})||{}).name||'â€”');
  var kws=extractKeywords(e), chips=kws.map(function(k){return '<span class="chip link" data-k="'+k.replace(/"/g,'&quot;')+'">'+k+'</span>';}); $('#chips').innerHTML=chips.join(' ');
  var atts=e.attachments||[]; $('#attach').innerHTML=atts.map(function(a){return '<span class="file">ğŸ“ '+a.name+'</span>';}).join(' ');
  $('#body').textContent=e.body||'';
  var url=null, att=(e.attachments||[]).filter(function(a){return /\.pdf$/i.test(a.name);})[0];
  if(att) url=att.url||att.name;
  if(!url && e.caseId){ var c=findOne(CASES,function(x){return x.id===e.caseId;}); if(c && c.pdfIds.length){ var p=findOne(PDFS,function(pp){return pp.id===c.pdfIds[0];}); url=p&&p.url; } }
  if(!url && PDFS.length) url=PDFS[0].url;
  if(url) openPdf(url,{zoom:'page-fit'});
  document.querySelectorAll('.chip.link').forEach(function(el){ el.onclick=function(){ jumpSearch(el.getAttribute('data-k')); }; });
  updateSidePanels(e);
}
function openPdf(url,opts){opts=opts||{};currentPdfUrl=url;var ps=[];if(opts.page)ps.push('page='+opts.page);if(opts.search)ps.push('search='+encodeURIComponent(opts.search));if(opts.zoom)ps.push('zoom='+opts.zoom);$('#pdfFrame').src=url+(ps.length?'#'+ps.join('&'):'#zoom=page-fit');}
function setReaderTitleForPdf(n){$('#subj').textContent='åˆåŒé¢„è§ˆï¼š'+n;$('#kp').innerHTML='â€¢ ä»å·¦ä¾§â€œåˆåŒæ–‡ä»¶å¤¹/æ¡ˆä»¶â€æ‰“å¼€<br>â€¢ ä½¿ç”¨ä¸‹æ–¹å·¥å…·æ æœç´¢å…³é”®å­—å¹¶é«˜äº®';$('#chips').innerHTML='';$('#attach').innerHTML='';$('#body').textContent='';}
function jumpSearch(q){ if(!currentPdfUrl){ pendingPdfSearch=q; return; } openPdf(currentPdfUrl,{search:q}); $('#pdfFind').value=q; }
function extractKeywords(e){var p={},add=function(s){if(s&&!p[s])p[s]=1;};var t=(e.subject+' '+e.body).toLowerCase();var a=(e.tags&&e.tags.topic)||[];a.forEach(add);var po=['Applicable Arbitration Rules','Constitution of the Tribunal','Fees and Expenses','Presence and Quorum','Rulings of the Tribunal','Power to Fix Time Limits','Secretary of the Tribunal','Representation of the Parties','Apportionment of Costs','Place of Proceeding','Procedural Language','Routing of Communications','Number of Copies','Sequence of Pleadings','Production of Documents','Submission of Documents','Witness Statements','Examination of Witnesses','Pre-Hearing','Hearings','Records of Hearings','Post-Hearing','Publication'];po.forEach(function(x){ if(t.indexOf(x.toLowerCase().split(' ')[0])>-1) add(x);});['Laycan','PDPR','NOR','SHINC','Demurrage','Beira','Tianjin','Recap','Busan','Manila'].forEach(function(x){ if(t.indexOf(x.toLowerCase())>-1) add(x);});(e.body.match(/Option\s*\d/ig)||[]).forEach(add);return Object.keys(p).slice(0,12);}
function extractFields(t){var f={rate:null,laycan:null,load:null,disc:null,rules:null},m=t.match(/USD[\s$]*([0-9,]+)\s*PDPR/i);if(m)f.rate='USD '+m[1]+' PDPR';m=t.match(/Laycan[^0-9]*([0-9]{1,2}[\-\â€“â€”][0-9]{1,2}\s*[A-Za-z]{3})/i);if(m)f.laycan=m[1];m=t.match(/Load\s*port\s*([A-Za-z]+)/i);if(m)f.load=m[1];m=t.match(/discharge\s*([A-Za-z]+)/i);if(m)f.disc=m[1];if(/SHINC/i.test(t))f.rules='SHINC';if(/ICSID/i.test(t))f.rules=f.rules?f.rules+', ICSID':'ICSID';return f;}
function updateSidePanels(email){
  var caseObj=email.caseId?findOne(CASES,function(c){return c.id===email.caseId;}):null;
  var topics=(email.tags&&email.tags.topic)||[],brief=topics.length?('æœ¬é‚®ä»¶æ¶‰åŠï¼š'+topics.join('ã€')+'ã€‚å¯åœ¨åˆåŒä¸­å¿«é€Ÿæ£€ç´¢å¹¶æ ¸å¯¹ç›¸åº”æ¡æ¬¾ã€‚'):'æ ¹æ®å…³é”®è¯åœ¨ä¸‹æ–¹åˆåŒä¸­å®šä½æ¡æ¬¾å¹¶é«˜äº®ï¼›å¿…è¦æ—¶åˆ‡æ¢æ¡ˆä»¶å…³è”åˆåŒã€‚';
  $('#aisum').textContent=brief;
  var f=extractFields(email.subject+' '+email.body);
  $('#kvCase').textContent=caseObj?caseObj.name:'â€”'; $('#kvRate').textContent=f.rate||'â€”'; $('#kvLaycan').textContent=f.laycan||'â€”'; $('#kvLoad').textContent=f.load||'â€”'; $('#kvDisc').textContent=f.disc||'â€”'; $('#kvRules').textContent=f.rules||'â€”';
  var html=''; if(caseObj){ html+='<div style="margin-bottom:6px"><b>æ¡ˆä»¶ï¼š</b>'+caseObj.name+'</div>'; if(caseObj.pdfIds.length){ caseObj.pdfIds.forEach(function(id){ var p=findOne(PDFS,function(x){return x.id===id;}); if(p){ html+='<div class="bookmark"><span>ğŸ“„ '+p.name+'</span><span class="mini-link" data-open="'+p.url+'">æ‰“å¼€</span></div>'; } }); } else { html+='<div class="pdf-empty">æš‚æ— å…³è”åˆåŒ</div>'; } } else { html='æœªå…³è”åˆ°ä»»ä½•æ¡ˆä»¶ã€‚'; }
  $('#relInfo').innerHTML=html; document.querySelectorAll('[data-open]').forEach(function(a){ a.onclick=function(){ openPdf(a.getAttribute('data-open'),{zoom:'page-fit'}); }; });
  $('#opFlag').checked=!!email.flag; $('#opArch').checked=!!email.arch;
  $('#opFlag').onchange=function(){ email.flag=this.checked; setBadgeCounts(); renderList(); };
  $('#opArch').onchange=function(){ email.arch=this.checked; setBadgeCounts(); renderList(); };
  $('#opToCase').onclick=function(){ if(!caseObj){ alert('è¯¥é‚®ä»¶æœªç»‘å®šæ¡ˆä»¶'); return; } email.caseId=caseObj.id; renderList(); setBadgeCounts(); alert('å·²ç§»åŠ¨åˆ°æ¡ˆä»¶ï¼š'+caseObj.name); };
  var list=$('#relEmails'); list.innerHTML=''; var rel=EMAILS.filter(function(e){return e.caseId && caseObj && e.caseId===caseObj.id && e.id!==email.id;}).sort(function(a,b){return new Date(b.date)-new Date(a.date);}).slice(0,5);
  if(!rel.length){ list.textContent='æš‚æ— '; } else rel.forEach(function(r){ var d=document.createElement('div'); d.className='rel-item'; d.innerHTML='<div><a href="javascript:void(0)">'+r.subject+'</a><div class="rel-meta">'+fmtDate(r.date)+'</div></div><div class="rel-meta">'+(r.from||'')+'</div>'; d.onclick=function(){ selectMail(r.id); }; list.appendChild(d); });
  renderBookmarks(email.caseId||'GLOBAL');
}
function bmKey(c){return 'arbimail.bm.'+(c||'GLOBAL');}
function getBookmarks(c){try{var t=localStorage.getItem(bmKey(c));return t?JSON.parse(t):[];}catch(e){return[]}}
function setBookmarks(c,a){try{localStorage.setItem(bmKey(c),JSON.stringify(a));}catch(e){}}
function renderBookmarks(c){var box=$('#bmList'),arr=getBookmarks(c); if(!arr.length){box.textContent='æš‚æ— ä¹¦ç­¾';return;} box.innerHTML=''; arr.forEach(function(b,idx){ var row=document.createElement('div'); row.className='bookmark'; row.innerHTML='<span>'+(b.type==='page'?'é¡µç  ':'å…³é”®å­— ')+b.value+'</span><span><span class="mini-link" data-goto="'+idx+'">è·³è½¬</span> Â· <span class="mini-link" data-del="'+idx+'">åˆ é™¤</span></span>'; box.appendChild(row); }); box.querySelectorAll('[data-goto]').forEach(function(g){ g.onclick=function(){ var a=getBookmarks(c)[parseInt(this.getAttribute('data-goto'),10)]; if(a){ if(a.type==='page')openPdf(currentPdfUrl||(PDFS[0]&&PDFS[0].url),{page:parseInt(a.value,10)||1}); else openPdf(currentPdfUrl||(PDFS[0]&&PDFS[0].url),{search:a.value}); } }; }); box.querySelectorAll('[data-del]').forEach(function(d){ d.onclick=function(){ var arr=getBookmarks(c); arr.splice(parseInt(this.getAttribute('data-del'),10),1); setBookmarks(c,arr); renderBookmarks(c); }; });}
$('#btnReload').onclick=function(){ openPdf(currentPdfUrl||(PDFS[0]&&PDFS[0].url),{zoom:'page-fit'}); };
$('#filePicker2').onchange=function(e){ var f=e.target.files[0]; if(!f)return; openPdf(URL.createObjectURL(f),{zoom:'page-fit'}); };
$('#btnPage').onclick=function(){ var p=parseInt($('#pdfPage').value||''); if(p>0) openPdf(currentPdfUrl||(PDFS[0]&&PDFS[0].url),{page:p}); };
$('#btnFind').onclick=function(){ var q=$('#pdfFind').value.trim(); if(q) jumpSearch(q); };
$('#btnAddPdf').onclick=function(){ $('#pdfPicker').click(); };
$('#pdfPicker').onchange=function(e){ var f=e.target.files[0]; if(!f)return; var id='pdf_'+Math.random().toString(36).slice(2,8); var url=URL.createObjectURL(f); PDFS.unshift({id:id,name:f.name,url:url}); renderShelf(); renderCaseGroup(); };

function renderAllMail(){ setBadgeCounts(); renderCaseGroup(); renderShelf(); renderList(); wireMailboxes(); }

/* é¡¶éƒ¨â€œè‡ªåŠ¨å›å¤â€å¿«é€Ÿå…¥å£ */
$('#btnAutoReply').onclick=function(){
  APP.tab='desk'; applyTab();
  $('#tabReply').click();
  $('#replyBase').value='email';
  regenReplyDraft();
  window.scrollTo(0,0);
};

/* ===== åˆå§‹åŒ– & åˆ‡æ¢æ¡ˆä»¶åˆ·æ–° ===== */
function refreshAllForCase(){
  // å·¥ä½œå°
  renderMatrix(); regenRecapDraft(); regenReplyDraft(); $('#contractBox').value='';
  // é‚®ä»¶ï¼ˆåˆ—è¡¨æŒ‰æ¡ˆä»¶ï¼‰
  state.scope={type:'case',id:APP.caseId}; renderAllMail();
}
function init(){
  initTop();
  refreshAllForCase();
  // é»˜è®¤é€‰ä¸€å°é‚®ä»¶
  var first=EMAILS.find(function(e){return e.caseId===APP.caseId;})||EMAILS[0]; if(first){ selectMail(first.id); }
}
init();
</script>
</body>
</html>
