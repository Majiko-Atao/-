<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ArbiMail Â· æ¡ˆä»¶é‚®ä»¶ & åˆåŒ Â· Recap/çŸ©é˜µ é¡¶éƒ¨è§†å›¾ç‰ˆ</title>
<style>
  :root{
    --ink:#0f172a; --muted:#667085; --line:#e6edf5; --bg:#f6f9fc; --brand:#2f6efb;
    --left:280px; --mid:520px; --side:360px; --gut:8px;
    --shadow:0 10px 28px rgba(15,23,42,.08);
  }
  *{box-sizing:border-box} html,body{height:100%}
  body{margin:0;font:14px/1.55 -apple-system,BlinkMacSystemFont,"Segoe UI","PingFang SC",Arial,sans-serif;color:var(--ink);background:var(--bg)}
  .topbar{height:54px;display:flex;align-items:center;justify-content:space-between;padding:0 12px;background:#fff;border-bottom:1px solid var(--line)}
  .brand{font-weight:800}
  .actions{display:flex;gap:8px}
  .btn{height:32px;padding:0 12px;border:1px solid var(--line);border-radius:10px;background:#fff;cursor:pointer}
  .btn.primary{background:#2f6efb;border-color:#2f6efb;color:#fff}
  .select{height:32px;border:1px solid var(--line);border-radius:10px;background:#fff;padding:0 10px}

  /* èº«ä»½åˆ‡æ¢å™¨ & ä¸»åŠŸèƒ½æ®µæ§ */
  .role-switch{display:flex;border:1px solid var(--line);border-radius:10px;overflow:hidden;background:#fff}
  .role-switch button{height:32px;border:0;background:transparent;padding:0 14px;cursor:pointer}
  .role-switch button.on{background:#2f6efb;color:#fff}
  .seg{display:flex;border:1px solid var(--line);border-radius:10px;overflow:hidden;background:#fff}
  .seg button{height:32px;border:0;background:transparent;padding:0 14px;cursor:pointer}
  .seg button.on{background:#eef2ff;color:#1f2a44;font-weight:700}
  .hidden{display:none !important}

  /* ä¸»å¸ƒå±€ï¼šå·¦ä¾§å¯¼èˆª / ä¸­é—´ä¸»è§†å›¾ / å³ä¾§æ—¶é—´è½´ä¸ä¿¡æ¯ */
  .layout{height:calc(100vh - 54px);display:grid;grid-template-columns:var(--left) var(--gut) 1fr var(--gut) var(--side)}
  .col{min-width:0;overflow:auto}

  /* å·¦ä¾§åˆ†ç»„ */
  .left{background:#fff;border-right:1px solid var(--line);padding:12px 10px}
  .group{margin-bottom:10px}
  .g-head{display:flex;align-items:center;justify-content:space-between;padding:8px;border-radius:10px;font-weight:700;background:#f7fafc;border:1px solid var(--line);cursor:pointer}
  .g-head:hover{background:#f1f6ff}
  .g-title{display:flex;align-items:center;gap:8px}
  .caret{transition:.2s}
  .g-body{margin-top:6px;border-left:2px solid #eaf1fb;padding-left:8px;display:flex;flex-direction:column;gap:6px}
  .item{display:flex;justify-content:space-between;align-items:center;padding:6px 8px;border-radius:10px;cursor:pointer}
  .item:hover{background:#f8fbff}
  .item.active{background:#e7efff}
  .name{white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .subctrl{display:flex;align-items:center;gap:8px}
  .badge{min-width:18px;height:18px;padding:0 6px;border-radius:999px;background:#eef2ff;color:#334155;font-size:12px;display:inline-flex;align-items:center;justify-content:center}
  .tiny{border:1px solid var(--line);border-radius:8px;height:28px;padding:0 10px;background:#fff;cursor:pointer;font-size:12px}
  .tiny.primary{background:#2f6efb;color:#fff;border-color:#2f6efb}
  .tiny[data-act="toggle"]{width:28px;padding:0;display:flex;align-items:center;justify-content:center}
  .sublist{display:flex;flex-direction:column;gap:6px;margin-left:14px}
  .pdf-list{display:flex;flex-direction:column;gap:6px}
  .pdf-row{display:grid;grid-template-columns:20px 1fr auto auto;align-items:center;gap:8px;
           padding:6px 8px;border:1px solid var(--line);border-radius:10px;background:#fff}
  .pdf-ico{text-align:center}
  .pdf-name{white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .link-row{display:grid;grid-template-columns:20px 1fr auto;align-items:center;gap:8px;
            padding:6px 8px;border:1px dashed #e5eaf5;border-radius:10px;background:#fbfdff}
  .pdf-empty{padding:8px;border:1px dashed #e5eaf5;border-radius:10px;background:#fbfdff;color:#94a3b8}

  /* è§†å›¾å®¹å™¨ï¼ˆä¸­é—´ä¸»åŒºï¼‰ */
  .main{padding:12px}
  .card{background:#fff;border:1px solid var(--line);border-radius:12px;box-shadow:var(--shadow);padding:12px;margin-bottom:12px}
  .card h3{margin:0 0 8px}
  .kv{font-weight:700;color:#475569;width:72px}
  .row-flex{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .chip{padding:2px 8px;border:1px solid #e3e8ff;background:#eef2ff;border-radius:999px}
  .chip.link{cursor:pointer}
  .mono{font-family:ui-monospace, Menlo, Consolas, monospace;white-space:pre-wrap}

  /* é‚®ä»¶è§†å›¾ï¼ˆå¤ç”¨ä½ ä¹‹å‰çš„ï¼‰ */
  .list-wrap{display:flex;flex-direction:column;height:100%;background:#fff;border:1px solid var(--line);border-radius:12px;overflow:hidden}
  .toolbar{display:flex;gap:10px;align-items:center;padding:8px;border-bottom:1px solid var(--line);background:#fff}
  .search{flex:1;display:flex;gap:8px;align-items:center;background:#f7f9fd;border:1px solid var(--line);border-radius:10px;padding:6px 10px}
  .search input{flex:1;border:none;background:transparent;outline:none}
  .pill{border:1px solid var(--line);border-radius:999px;padding:2px 10px;background:#fff;color:#334155}
  .list{overflow:auto}
  .section-hd{position:sticky;top:0;background:#fff;padding:6px 10px;color:#7a869f;font-size:12px;border-top:1px solid var(--line);border-bottom:1px solid var(--line)}
  .row-mail{display:grid;grid-template-columns:10px 1fr auto;gap:8px;align-items:center;padding:9px 10px;border-bottom:1px solid var(--line);cursor:pointer}
  .row-mail:hover{background:#f8fbff} .dot{width:8px;height:8px;border-radius:50%;background:#d1d9e8;margin-left:2px}
  .subject{font-weight:650;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}
  .meta{color:#6b7280;font-size:12px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

  .paper{background:#fff;border:1px solid var(--line);box-shadow:var(--shadow);border-radius:12px;padding:0}
  .mailbar{display:flex;gap:6px;flex-wrap:wrap;align-items:center;padding:8px;border-bottom:1px solid var(--line);background:#fbfbfe;border-top-left-radius:12px;border-top-right-radius:12px}
  .mb-btn{height:28px;padding:0 10px;border:1px solid var(--line);border-radius:8px;background:#fff;cursor:pointer;font-size:12px}
  .mb-btn:hover{background:#f5f7ff}
  .header{padding:10px 12px;border-bottom:1px solid var(--line)}
  .h-subject{font-weight:800;font-size:18px;margin-bottom:6px}
  .h-line{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin:6px 0}
  .pill-addr{background:#fff6d7;border:1px solid #f0e3b1;padding:0 8px;height:22px;display:inline-flex;align-items:center;border-radius:999px;font-size:12px}
  .r-grid{display:grid;grid-template-columns:360px 1fr;gap:14px;padding:12px}
  .kp{border:1px dashed #dbeafe;background:#f8fbff;border-radius:10px;padding:10px}
  .info{border:1px solid var(--line);border-radius:10px;padding:10px}
  .kvline{display:flex;flex-wrap:wrap;gap:8px;margin-top:6px}
  .attachments{grid-column:1/3;display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
  .file{border:1px solid var(--line);border-radius:8px;padding:6px 10px;background:#fff}
  .body{grid-column:1/3;white-space:pre-wrap;margin-top:6px;line-height:1.8}

  /* PDF é¢æ¿ï¼ˆPDF è§†å›¾å…±ç”¨ï¼‰ */
  .pdf-card{margin-top:12px;border:1px solid var(--line);border-radius:12px;box-shadow:var(--shadow);background:#fff}
  .pdf-toolbar{display:flex;gap:8px;align-items:center;justify-content:space-between;padding:8px 10px;border-bottom:1px solid var(--line);background:#fbfdff;border-top-left-radius:12px;border-top-right-radius:12px}
  .pdf-tools{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .mini{height:30px;padding:0 10px;border:1px solid var(--line);border-radius:8px;background:#fff;cursor:pointer}
  .pdf-chips{display:flex;gap:6px;flex-wrap:wrap}
  .pdf-wrap{height:64vh;overflow:hidden;border-bottom-left-radius:12px;border-bottom-right-radius:12px}
  .pdf-frame{width:100%;height:100%;border:0;display:block;background:#f6f9fc}

  /* å³ä¾§æ ï¼ˆå«æ—¶é—´è½´ï¼‰ */
  .side{background:#fff;border-left:1px solid var(--line);padding:10px}
  .kvtable{width:100%;border-collapse:collapse}
  .kvtable td{padding:6px 4px;border-bottom:1px dashed #eef2f7;font-size:13px}
  .op-group{display:flex;gap:8px;flex-wrap:wrap}
  .switch{display:inline-flex;align-items:center;gap:6px}
  .switch input{accent-color:#2f6efb}
  .bookmark{display:flex;justify-content:space-between;align-items:center;padding:6px 8px;border-radius:8px}
  .bookmark:hover{background:#f7faff}
  .mini-link{font-size:12px;color:#2f6efb;cursor:pointer}
  .rel-list{display:flex;flex-direction:column;gap:8px}
  .rel-item{display:flex;justify-content:space-between;gap:8px}
  .rel-item a{color:#0f172a;text-decoration:none}
  .rel-meta{color:#64748b;font-size:12px}

  /* Recap å†…å®¹å— */
  .recap-grid{display:grid;grid-template-columns:1fr;gap:12px}
  .timeline{border-left:2px solid #eaeef6;margin-left:8px;padding-left:12px}
  .t-item{position:relative;margin:8px 0}
  .t-item:before{content:"";position:absolute;left:-13px;top:6px;width:8px;height:8px;border-radius:50%;background:#9aa6b2}
  .section-title{font-weight:700;margin-bottom:6px}

  /* çŸ©é˜µé¢æ¿ */
  .matrix-wrap{max-height:420px;overflow:auto;border:1px solid var(--line);border-radius:10px;background:#fff}
  .matrix{width:100%;border-collapse:collapse}
  .matrix th,.matrix td{border-bottom:1px solid #eef2f7;padding:8px 10px;vertical-align:top;font-size:13px}
  .matrix th{position:sticky;top:0;background:#fbfdff;z-index:1}
  .m-topic{font-weight:700}
  .m-sub{color:#64748b;font-size:12px}
  .m-badge{display:inline-flex;align-items:center;gap:6px;padding:2px 8px;border-radius:999px;border:1px solid var(--line);background:#fbfdff;font-size:12px;color:#475569}
  .m-badge.us{background:#eef2ff;border-color:#dbeafe}
  .m-badge.them{background:#fff1f2;border-color:#ffe4e6}
  .m-badge.ai{background:#ecfeff;border-color:#cffafe}
  .pick{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .btn-ghost{height:28px;padding:0 10px;border:1px dashed #dbeafe;background:#f8fbff;border-radius:8px;cursor:pointer}

  @media (max-width:1360px){
    :root{--side:0px}
    #sideCol{display:none}
    .layout{grid-template-columns:var(--left) var(--gut) 1fr}
  }
</style>
</head>
<body>
  <div class="topbar">
    <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
      <div class="brand">ArbiMail</div>

      <!-- èº«ä»½åˆ‡æ¢ -->
      <div class="role-switch" id="roleSwitch">
        <button data-role="counsel">ä»£ç†å¾‹å¸ˆ</button>
        <button data-role="arbitrator">ä»²è£å‘˜</button>
      </div>

      <!-- æ¡ˆä»¶é€‰æ‹©å™¨ -->
      <select id="caseSelect" class="select" title="é€‰æ‹©æ¡ˆä»¶"></select>

      <!-- ä¸»åŠŸèƒ½åˆ†æ®µï¼šRecap / çŸ©é˜µ / é‚®ä»¶ / PDF -->
      <div class="seg" id="viewSeg">
        <button data-view="recap">Recap</button>
        <button data-view="matrix">çŸ©é˜µåˆ†æ</button>
        <button data-view="mail">é‚®ä»¶</button>
        <button data-view="pdf">åˆåŒPDF</button>
      </div>
    </div>
    <div class="actions">
      <button class="btn" onclick="window.print()">å¯¼å‡ºPDF</button>
      <button class="btn primary">æ–°å»ºæ¡ˆä»¶</button>
    </div>
  </div>

  <div class="layout">
    <!-- å·¦ä¾§ï¼šé‚®ç®±/æ¡ˆä»¶/åˆåŒæ–‡ä»¶å¤¹ -->
    <div class="col left">
      <div class="group">
        <div class="g-head" data-toggle="mbx"><div class="g-title"><span class="caret">â–¾</span> é‚®ä»¶ç®±</div></div>
        <div class="g-body" id="mbxBody">
          <div class="item" data-mailbox="inbox"><div class="name">æ”¶ä»¶ç®±</div><div class="subctrl"><span class="badge" id="b_inbox">0</span></div></div>
          <div class="item" data-mailbox="sent"><div class="name">å·²å‘é€</div><div class="subctrl"><span class="badge" id="b_sent">0</span></div></div>
          <div class="item" data-mailbox="flag"><div class="name">çº¢æ——é‚®ä»¶</div><div class="subctrl"><span class="badge" id="b_flag">0</span></div></div>
          <div class="item" data-mailbox="arch"><div class="name">å·²å½’æ¡£</div><div class="subctrl"><span class="badge" id="b_arch">0</span></div></div>
          <div class="item" data-mailbox="unfiled"><div class="name">æœªå½’æ¡£</div><div class="subctrl"><span class="badge" id="b_unfiled">0</span></div></div>
        </div>
      </div>

      <div class="group">
        <div class="g-head" data-toggle="case"><div class="g-title"><span class="caret">â–¾</span> æˆ‘çš„æ¡ˆä»¶</div></div>
        <div class="g-body" id="caseBody"></div>
      </div>

      <div class="group">
        <div class="g-head" data-toggle="shelf">
          <div class="g-title"><span class="caret">â–¾</span> åˆåŒæ–‡ä»¶å¤¹</div>
          <div><button class="tiny" id="btnAddPdf">ï¼‹ æ·»åŠ PDF</button><input id="pdfPicker" type="file" accept="application/pdf" style="display:none"></div>
        </div>
        <div class="g-body" id="shelfBody"></div>
      </div>
    </div>

    <div></div> <!-- gutter -->

    <!-- ä¸­é—´ä¸»åŒºï¼šä¸åŒè§†å›¾åˆ‡æ¢ -->
    <div class="col main" id="mainCol">
      <!-- Recap è§†å›¾ -->
      <div id="recapView" class="mainview">
        <div class="card">
          <h3>æ¡ˆä»¶åŸºæœ¬æ¦‚è¦</h3>
          <div id="recapSummary">â€”</div>
          <div class="row-flex" style="margin-top:10px">
            <button class="btn" id="btnReAnalyze">é‡æ–°åˆ†æ</button>
            <button class="btn" id="btnCopyRecap">å¤åˆ¶æ¦‚è¦</button>
          </div>
        </div>
        <div class="card">
          <h3>å…³é”®æ•°æ®é”šç‚¹ï¼ˆç‚¹å‡»å¯åœ¨PDFä¸­é«˜äº®ï¼‰</h3>
          <div id="recapAnchors" class="row-flex"></div>
        </div>
        <div class="card" data-roles="counsel,arbitrator">
          <h3>è‡ªåŠ¨å›å¤å»ºè®®ï¼ˆåˆ†èº«ç³»ç»Ÿï¼‰</h3>
          <div class="row-flex" style="align-items:center">
            <label>è§’è‰²</label>
            <select id="roleSelect">
              <option value="counsel">ä»£ç†å¾‹å¸ˆ</option>
              <option value="arbitrator">ä»²è£å‘˜</option>
            </select>
            <button class="btn" id="regenReply">é‡æ–°ç”Ÿæˆ</button>
          </div>
          <textarea id="autoReply" class="mono" style="width:100%;height:160px;margin-top:8px;"></textarea>
        </div>
      </div>

      <!-- çŸ©é˜µ è§†å›¾ -->
      <div id="matrixView" class="mainview">
        <div class="card">
          <div class="row-flex" style="justify-content:space-between">
            <h3 style="margin:0">çŸ©é˜µå†³è®®ï¼ˆä»é‚®ä»¶ä¸­æŠ½å–ï¼Œé€‰æ‹©é‡‡çº³è°çš„å»ºè®®ï¼‰</h3>
            <div class="row-flex">
              <button class="btn primary" id="btnApplyMatrix">ä½¿ç”¨çŸ©é˜µå†³è®®ç”Ÿæˆæ¦‚è¦</button>
            </div>
          </div>
          <div class="matrix-wrap">
            <table class="matrix" id="matrixTable">
              <thead>
                <tr>
                  <th style="width:200px">è®®é¢˜</th>
                  <th>æˆ‘æ–¹å»ºè®®</th>
                  <th>å¯¹æ–¹å»ºè®®</th>
                  <th>AIå»ºè®®</th>
                  <th style="width:180px">é‡‡çº³</th>
                  <th style="width:120px">è¯æ®</th>
                </tr>
              </thead>
              <tbody id="matrixBody"><tr><td colspan="6" style="text-align:center;color:#94a3b8">â€” è¯·é€‰æ‹©æ¡ˆä»¶æˆ–è¿è¡Œåˆ†æ â€”</td></tr></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- é‚®ä»¶ è§†å›¾ -->
      <div id="mailView" class="mainview">
        <div class="row-flex" style="gap:12px; align-items:flex-start">
          <div style="flex:0 0 480px; min-width:420px">
            <div class="list-wrap">
              <div class="toolbar">
                <div class="search"><span>ğŸ”</span><input id="q" placeholder="æœç´¢ï¼ˆfrom: party: clause: has:attachmentï¼‰"></div>
                <span class="pill" id="viewPill">æ¡ˆä»¶</span>
              </div>
              <div id="list" class="list"></div>
            </div>
          </div>
          <div style="flex:1 1 auto; min-width:420px">
            <article class="paper">
              <div class="mailbar">
                <button class="mb-btn" data-roles="counsel,arbitrator">å›å¤</button>
                <button class="mb-btn" data-roles="counsel,arbitrator">å›å¤å…¨éƒ¨</button>
                <button class="mb-btn" data-roles="counsel,arbitrator">è½¬å‘</button>

                <button class="mb-btn" id="btnGenRecap" data-roles="counsel">ç”ŸæˆRecap</button>

                <button class="mb-btn" id="btnOrder" data-roles="arbitrator">ç¨‹åºä»¤è‰æ¡ˆ</button>
                <button class="mb-btn" id="btnDeadline" data-roles="arbitrator">è®¾ç½®æœŸé™</button>
                <button class="mb-btn" id="btnRequestDocs" data-roles="arbitrator">è¦æ±‚æäº¤ææ–™</button>
              </div>

              <div class="header" id="mailHeader">
                <div class="h-subject" id="subj">â€”</div>
                <div class="h-line"><div class="kv">å‘ä»¶äºº</div><div id="hFrom"></div></div>
                <div class="h-line"><div class="kv">æ”¶ä»¶äºº</div><div id="hTo"></div></div>
                <div class="h-line" id="ccLine" style="display:none;"><div class="kv">æŠ„é€</div><div id="hCc"></div></div>
                <div class="h-line"><div class="kv">æ—¶é—´</div><div id="hTime"></div></div>
              </div>

              <section class="r-grid">
                <div class="kp"><div style="font-weight:700;margin-bottom:6px">å…³é”®è¦ç‚¹</div><div id="kp"></div></div>
                <div class="info">
                  <div style="font-weight:700;margin-bottom:6px">å…³é”®è¯</div>
                  <div class="kvline" id="chips"></div>
                </div>
                <div class="attachments" id="attach"></div>
                <div class="body" id="body"></div>

                <div class="pdf-card">
                  <div class="pdf-toolbar">
                    <div class="pdf-tools">
                      <button class="mini" id="btnReload">åˆ·æ–°</button>
                      <label class="mini" style="display:flex;align-items:center;gap:6px;cursor:pointer">é€‰æ‹©PDF
                        <input type="file" id="filePicker" accept="application/pdf" style="display:none">
                      </label>
                      <div class="pdf-chips" id="pdfChips"></div>
                    </div>
                    <div>
                      <input id="pdfPage" placeholder="é¡µç â€¦" style="height:30px;border:1px solid var(--line);border-radius:8px;padding:0 10px;width:90px">
                      <button class="mini" id="btnPage">è·³è½¬</button>
                      <input id="pdfFind" placeholder="åœ¨PDFä¸­æŸ¥æ‰¾â€¦" style="height:30px;border:1px solid var(--line);border-radius:8px;padding:0 10px;width:220px;margin-left:8px">
                      <button class="mini" id="btnFind">æŸ¥æ‰¾</button>
                    </div>
                  </div>
                  <div class="pdf-wrap"><iframe id="pdfFrame" class="pdf-frame" title="åˆåŒPDF"></iframe></div>
                </div>
              </section>
            </article>
          </div>
        </div>
      </div>

      <!-- PDF è§†å›¾ï¼ˆç‹¬ç«‹æ”¾å¤§ï¼‰ -->
      <div id="pdfView" class="mainview">
        <div class="card">
          <div class="pdf-toolbar">
            <div class="pdf-tools">
              <button class="mini" id="btnReload2">åˆ·æ–°</button>
              <label class="mini" style="display:flex;align-items:center;gap:6px;cursor:pointer">é€‰æ‹©PDF
                <input type="file" id="filePicker2" accept="application/pdf" style="display:none">
              </label>
              <div class="pdf-chips" id="pdfChips2"></div>
            </div>
            <div>
              <input id="pdfPage2" placeholder="é¡µç â€¦" style="height:30px;border:1px solid var(--line);border-radius:8px;padding:0 10px;width:90px">
              <button class="mini" id="btnPage2">è·³è½¬</button>
              <input id="pdfFind2" placeholder="åœ¨PDFä¸­æŸ¥æ‰¾â€¦" style="height:30px;border:1px solid var(--line);border-radius:8px;padding:0 10px;width:220px;margin-left:8px">
              <button class="mini" id="btnFind2">æŸ¥æ‰¾</button>
            </div>
          </div>
          <div class="pdf-wrap"><iframe id="pdfFrame2" class="pdf-frame" title="åˆåŒPDFï¼ˆæ”¾å¤§ï¼‰"></iframe></div>
        </div>
      </div>
    </div>

    <div></div> <!-- gutter -->

    <!-- å³ä¾§ï¼šæŒ‰èº«ä»½æ˜¾ç¤ºçš„ä¿¡æ¯ + å¸¸é©»â€œæ—¶é—´è½´â€ -->
    <div class="col side" id="sideCol">
      <!-- ä»£ç†å¾‹å¸ˆè§†å›¾ -->
      <div class="card" data-roles="counsel">
        <h4>AI æ‘˜è¦</h4><div id="aisum" style="color:#475569">é€‰æ‹©ä¸€å°é‚®ä»¶æˆ–è¿è¡Œåˆ†æã€‚</div>
      </div>
      <div class="card" data-roles="counsel">
        <h4>æ™ºèƒ½æŠ½å–å­—æ®µ</h4>
        <table class="kvtable" id="kvExtract">
          <tbody>
            <tr><td style="width:84px;color:#64748b">æ¡ˆä»¶</td><td id="kvCase">â€”</td></tr>
            <tr><td style="color:#64748b">è´¹ç‡/ä»·æ ¼</td><td id="kvRate">â€”</td></tr>
            <tr><td style="color:#64748b">Laycan</td><td id="kvLaycan">â€”</td></tr>
            <tr><td style="color:#64748b">è£…æ¸¯</td><td id="kvLoad">â€”</td></tr>
            <tr><td style="color:#64748b">å¸æ¸¯</td><td id="kvDisc">â€”</td></tr>
            <tr><td style="color:#64748b">è§„åˆ™</td><td id="kvRules">â€”</td></tr>
          </tbody>
        </table>
      </div>
      <div class="card" data-roles="counsel">
        <h4>å…³è”åˆåŒ</h4><div id="relInfo" style="color:#475569">â€”</div>
      </div>

      <!-- ä»²è£å‘˜è§†å›¾ -->
      <div class="card" data-roles="arbitrator">
        <h4>åº­å®¡å®‰æ’ï¼ˆç¨‹åºæ€§æ¦‚è§ˆï¼‰</h4>
        <div id="arbSchedule">
          <div>Â· ä¹¦çŠ¶äº¤æ¢ I æˆªæ­¢ï¼š2025-08-21</div>
          <div>Â· è¯äººå£°æ˜æäº¤ï¼š2025-09-05</div>
          <div>Â· å¬è¯ä¼šé¢„å¤‡ä¼šè®®ï¼š2025-09-20</div>
        </div>
      </div>
      <div class="card" data-roles="arbitrator">
        <h4>ç¨‹åºä»¤æ¨¡æ¿</h4>
        <div class="op-group">
          <button class="mini" id="tplPO1">PO-1 æ¨¡æ¿</button>
          <button class="mini" id="tplScheduling">æ’æœŸä»¤æ¨¡æ¿</button>
        </div>
      </div>

      <!-- å¸¸é©»ï¼šPDF ä¹¦ç­¾ -->
      <div class="card" data-roles="counsel,arbitrator">
        <h4>PDF ä¹¦ç­¾</h4>
        <div class="op-group" style="margin-bottom:8px">
          <button class="mini" id="bmAddPage">æ·»åŠ é¡µç ä¹¦ç­¾</button>
          <button class="mini" id="bmAddSearch">æ·»åŠ å…³é”®å­—ä¹¦ç­¾</button>
          <button class="mini" id="bmClear">æ¸…ç©º</button>
        </div>
        <div id="bmList">æš‚æ— ä¹¦ç­¾</div>
      </div>

      <!-- å¸¸é©»ï¼šæ—¶é—´è½´ -->
      <div class="card" data-roles="counsel,arbitrator">
        <h4 style="display:flex;justify-content:space-between;align-items:center">
          <span>æ—¶é—´è½´</span>
          <span class="row-flex" style="gap:6px">
            <select id="tlRange" class="select" style="height:26px"><option value="today">ä»Šå¤©</option><option value="7d" selected>è¿‘7å¤©</option><option value="all">å…¨éƒ¨</option></select>
            <select id="tlTypes" class="select" style="height:26px">
              <option value="mail,matrix,bookmark,schedule">å…¨éƒ¨</option>
              <option value="mail,matrix">é‚®ä»¶+çŸ©é˜µ</option>
              <option value="mail">ä»…é‚®ä»¶</option>
              <option value="matrix">ä»…çŸ©é˜µ</option>
              <option value="bookmark">ä»…ä¹¦ç­¾</option>
              <option value="schedule">ä»…ç¨‹åº</option>
            </select>
          </span>
        </h4>
        <div id="timelineBox" class="timeline"></div>
      </div>
    </div>
  </div>

<script>
/* ======================== ç¤ºä¾‹æ•°æ® ======================== */
var PDFS=[
  {id:'pdfA', name:'Test Contract (ClickDimensions)', url:'https://www.clickdimensions.com/links/TestPDFfile.pdf'},
  {id:'pdfB', name:'W3C Dummy PDF', url:'https://www.w3.org/WAI/ER/tests/xhtml/testfiles/resources/pdf/dummy.pdf'},
  {id:'pdfC', name:'Mozilla Sample (PDF.js)', url:'https://mozilla.github.io/pdf.js/web/compressed.tracemonkey-pldi-09.pdf'}
];
var CASES=[
  {id:'C-001', name:'[ICSID] Procedural Order No.1 å¯¹é½', color:'#3b82f6', pdfIds:['pdfC']},
  {id:'C-002', name:'MV Ocean Star â€” Main Terms',       color:'#10b981', pdfIds:['pdfA']},
  {id:'C-003', name:'MV Silver Wave â€” Spot Voyage',     color:'#f59e0b', pdfIds:[]}
];
var MAILBOXES=[
  {id:'inbox',name:'æ”¶ä»¶ç®±'}, {id:'sent',name:'å·²å‘é€'},
  {id:'flag',name:'çº¢æ——é‚®ä»¶'}, {id:'arch',name:'å·²å½’æ¡£'}, {id:'unfiled',name:'æœªå½’æ¡£'}
];
var EMAILS=[
  {id:'e1',folder:'inbox',flag:true, arch:false,
    subject:'Proposed edits â€” Quorum & Procedural Language',
    from:'claimant.counsel@example.com',to:['respondent.counsel@example.com'],cc:[],date:'2025-08-12 10:30',
    body:'We propose: (i) Option 1 (two-person quorum) in Â§4; (ii) Procedural Language: English only (Option 1) in Â§11; (iii) transcript be available in real-time; (iv) Production of Documents to follow ICSID Rules 33â€“36.',
    attachments:[{name:'TestPDFfile.pdf',url:'https://www.clickdimensions.com/links/TestPDFfile.pdf'}],
    tags:{topic:['Quorum','Procedural Language','Hearings','Production of Documents']}, caseId:'C-001'
  },
  {id:'e2',folder:'inbox',flag:false, arch:false,
    subject:'Re: Edits â€” Publication Option 2',
    from:'respondent.counsel@example.com',to:['claimant.counsel@example.com'],cc:[],date:'2025-08-12 14:10',
    body:'In Â§23, we prefer Publication Option 2 (award published only with both parties consent).',
    attachments:[], tags:{topic:['Publication','Option 2']}, caseId:'C-001'
  },
  {id:'e3',folder:'inbox',flag:false, arch:false,
    subject:'Offer freight at USD 56,000 PDPR for 12 months',
    from:'broker@ship.com',to:['owners@co.com','charterer@qs.com'],cc:[],date:'2025-08-11 09:12',
    body:'Laycan 19â€“25 Nov. Load port Beira, discharge Tianjin. Time counting SHINC. Please confirm.',
    attachments:[{name:'W3C Dummy.pdf',url:'https://www.w3.org/WAI/ER/tests/xhtml/testfiles/resources/pdf/dummy.pdf'}],
    tags:{topic:['Laycan','PDPR','NOR','SHINC','Beira','Tianjin']}, caseId:'C-002'
  },
  {id:'e4',folder:'inbox',flag:true, arch:false,
    subject:'NOR validity question at Beira (SHINC)',
    from:'charterer@qs.com',to:['owners@co.com'],cc:[],date:'2025-08-10 08:23',
    body:'Please confirm NOR tendering window at Beira and applicable SHINC rule.',
    attachments:[], tags:{topic:['NOR','SHINC','Beira']}, caseId:'C-002'
  },
  {id:'e5',folder:'inbox',flag:false, arch:false,
    subject:'MV Silver Wave â€” recap (Busan to Manila, 25â€“27 Aug)',
    from:'broker@sea.com',to:['ops@ship.com'],cc:[],date:'2025-08-11 16:05',
    body:'Fixture recap attached; laycan 25â€“27 Aug, Busan to Manila.',
    attachments:[{name:'Mozilla Sample.pdf',url:'https://mozilla.github.io/pdf.js/web/compressed.tracemonkey-pldi-09.pdf'}],
    tags:{topic:['Laycan','Recap','Busan','Manila']}, caseId:'C-003'
  }
];

/* ======================== å°å·¥å…· & çŠ¶æ€ ======================== */
function $(s){return document.querySelector(s);}
function fmtDate(s){var d=new Date(s);function p(n){return (n<10?'0':'')+n;}return d.getFullYear()+'-'+p(d.getMonth()+1)+'-'+p(d.getDate())+' '+p(d.getHours())+':'+p(d.getMinutes());}
function groupLabel(d){var dd=Math.floor((new Date()-new Date(d))/86400000);return dd<=0?'ä»Šå¤©':dd===1?'æ˜¨å¤©':'æ›´æ—©';}
function findOne(arr, pred){for(var i=0;i<arr.length;i++){if(pred(arr[i]))return arr[i];}return null;}
function stripTags(html){var div=document.createElement('div'); div.innerHTML=html; return div.innerText||div.textContent||'';}
var APP={role:localStorage.getItem('arbimail.role')||'counsel', view:location.hash.replace('#','')||'recap', caseId:localStorage.getItem('arbimail.case')||null};
function setHash(v){location.hash=v;}

/* ======================== é¡¶éƒ¨ï¼šèº«ä»½ / è§†å›¾ / æ¡ˆä»¶ ======================== */
function applyRole(){
  document.querySelectorAll('#roleSwitch button').forEach(function(b){ b.classList.toggle('on', b.getAttribute('data-role')===APP.role); });
  document.querySelectorAll('[data-roles]').forEach(function(el){
    var allow = el.getAttribute('data-roles').split(',').map(function(s){return s.trim();});
    el.classList.toggle('hidden', allow.indexOf(APP.role)===-1);
  });
}
function applyView(){
  document.querySelectorAll('#viewSeg button').forEach(function(b){ b.classList.toggle('on', b.getAttribute('data-view')===APP.view); });
  document.querySelectorAll('.mainview').forEach(function(v){ v.style.display = (v.id===APP.view+'View')?'block':'none'; });
  // è¿›å…¥é‚®ä»¶è§†å›¾ï¼šé»˜è®¤æŒ‰å½“å‰æ¡ˆä»¶è¿‡æ»¤
  if(APP.view==='mail' && APP.caseId){ state.scope={type:'case',id:APP.caseId}; renderList(); }
  // è¿›å…¥PDFè§†å›¾ï¼šåŒæ­¥å½“å‰ pdf åˆ°å¤§è§†å›¾
  if(APP.view==='pdf'){ syncPdfToBigView(); }
  renderTimeline(); // å³ä¾§æ—¶é—´è½´åœ¨ä»»ä½•è§†å›¾éƒ½åˆ·æ–°
}
function initTopBar(){
  // è§’è‰²
  document.querySelectorAll('#roleSwitch button').forEach(function(b){
    b.onclick=function(){ APP.role=this.getAttribute('data-role'); localStorage.setItem('arbimail.role',APP.role); applyRole(); renderTimeline(); };
  });
  // è§†å›¾
  document.querySelectorAll('#viewSeg button').forEach(function(b){
    b.onclick=function(){ APP.view=this.getAttribute('data-view'); setHash(APP.view); applyView(); };
  });
  window.addEventListener('hashchange', function(){ APP.view=location.hash.replace('#','')||'recap'; applyView(); });
  // æ¡ˆä»¶é€‰æ‹©
  var sel=$('#caseSelect'); sel.innerHTML=CASES.map(function(c){return '<option value="'+c.id+'">'+c.name+'</option>';}).join('');
  if(!APP.caseId) APP.caseId=CASES[0]&&CASES[0].id;
  sel.value=APP.caseId; sel.onchange=function(){ APP.caseId=this.value; localStorage.setItem('arbimail.case',APP.caseId); refreshForCase(); };
}

/* ======================== å·¦ä¾§ï¼šé‚®ç®±/æ¡ˆä»¶/åˆåŒ ======================== */
var state={scope:{type:'mailbox',id:'inbox'}, selected:null};
function setBadgeCounts(){
  var c={
    inbox:EMAILS.filter(function(e){return e.folder==='inbox';}).length,
    sent:EMAILS.filter(function(e){return e.folder==='sent';}).length,
    flag:EMAILS.filter(function(e){return e.flag;}).length,
    arch:EMAILS.filter(function(e){return e.arch;}).length,
    unfiled:EMAILS.filter(function(e){return !e.caseId;}).length
  };
  for(var k in c){var el=document.getElementById('b_'+k); if(el) el.textContent=c[k];}
}
function renderCaseGroup(){
  var wrap=$('#caseBody'); wrap.innerHTML='';
  CASES.forEach(function(c){
    var row=document.createElement('div'); row.className='item'+(state.scope.type==='case'&&state.scope.id===c.id?' active':'');
    row.innerHTML='<div class="name" style="display:flex;align-items:center;gap:8px">'
                 +'<span style="width:8px;height:8px;border-radius:50%;background:'+c.color+'"></span>'+c.name
                 +'</div>'
                 +'<div class="subctrl"><button class="tiny" data-act="toggle">â–¾</button><span class="badge">'
                 +EMAILS.filter(function(e){return e.caseId===c.id;}).length+'</span></div>';
    row.onclick=function(ev){
      if(ev.target && ev.target.getAttribute('data-act')==='toggle'){
        var box = wrap.querySelector('.sublist[data-case="'+c.id+'"]');
        box.style.display = box.style.display==='none'?'':'none'; ev.stopPropagation(); return;
      }
      APP.caseId=c.id; $('#caseSelect').value=c.id; localStorage.setItem('arbimail.case',c.id);
      refreshForCase();
    };
    wrap.appendChild(row);

    var sub=document.createElement('div'); sub.className='sublist pdf-list'; sub.setAttribute('data-case',c.id);
    if(!c.pdfIds.length){
      var emp=document.createElement('div'); emp.className='pdf-empty'; emp.innerText='ï¼ˆæœªå…³è”åˆåŒï¼‰'; sub.appendChild(emp);
    }else{
      c.pdfIds.forEach(function(pid){
        var p=findOne(PDFS,function(x){return x.id===pid;}); if(!p) return;
        var s=document.createElement('div'); s.className='pdf-row';
        s.innerHTML='<div class="pdf-ico">ğŸ“</div><div class="pdf-name" title="'+p.name+'">'+p.name+'</div>'
                   +'<button class="tiny primary" data-act="open">æ‰“å¼€</button><button class="tiny" data-act="unlink">ç§»é™¤</button>';
        s.onclick=function(ev){
          var act=ev.target && ev.target.getAttribute('data-act');
          if(act==='open'){ openPdf(p.url,{zoom:'page-fit'}); openPdfBig(p.url,{zoom:'page-fit'}); APP.view='pdf'; setHash('pdf'); applyView(); ev.stopPropagation(); }
          if(act==='unlink'){ c.pdfIds=c.pdfIds.filter(function(x){return x!==pid;}); renderCaseGroup(); ev.stopPropagation(); }
        };
        sub.appendChild(s);
      });
    }
    var ctrl=document.createElement('div'); ctrl.className='link-row';
    var sel='<select class="tiny" style="width:100%">'; PDFS.forEach(function(p){ sel+='<option value="'+p.id+'">'+p.name+'</option>'; }); sel+='</select>';
    ctrl.innerHTML='<div class="pdf-ico">â•</div>'+sel+'<button class="tiny" data-act="link">å…³è”</button>';
    ctrl.onclick=function(ev){
      if(ev.target && ev.target.getAttribute('data-act')==='link'){
        var s=ctrl.querySelector('select'); var pid=s.value; if(pid && c.pdfIds.indexOf(pid)<0){ c.pdfIds.push(pid); renderCaseGroup(); }
        ev.stopPropagation();
      }
    };
    sub.appendChild(ctrl);
    wrap.appendChild(sub);
  });
}
function renderShelf(){
  var wrap=$('#shelfBody'); wrap.innerHTML='';
  if(!PDFS.length){ wrap.innerHTML='<div class="pdf-empty">æš‚æ— PDF</div>'; return; }
  PDFS.forEach(function(p){
    var row=document.createElement('div'); row.className='item';
    row.innerHTML='<div class="name">ğŸ“„ '+p.name+'</div><div class="subctrl"><span class="badge">PDF</span></div>';
    row.onclick=function(){ openPdf(p.url,{zoom:'page-fit'}); openPdfBig(p.url,{zoom:'page-fit'}); APP.view='pdf'; setHash('pdf'); applyView(); };
    wrap.appendChild(row);
  });
}
function wireToggles(){
  document.querySelectorAll('[data-toggle]').forEach(function(h){
    h.onclick=function(){
      var key=h.getAttribute('data-toggle');
      var bodyId = key==='mbx'?'mbxBody':(key==='case'?'caseBody':'shelfBody');
      var body = document.getElementById(bodyId);
      var caret = h.querySelector('.caret');
      var show = body.style.display==='' || body.style.display==='block';
      if(show){ body.style.display='none'; caret.style.transform='rotate(-90deg)'; }
      else{ body.style.display=''; caret.style.transform='rotate(0deg)'; }
    };
  });
}
function wireMailboxes(){
  document.querySelectorAll('[data-mailbox]').forEach(function(el){
    el.onclick=function(){ state.scope={type:'mailbox',id:el.getAttribute('data-mailbox')}; state.selected=null; APP.view='mail'; setHash('mail'); renderList(); applyView(); };
  });
}

/* ======================== é‚®ä»¶åˆ—è¡¨ & é˜…è¯» ======================== */
function pool(){
  if(state.scope.type==='case') return EMAILS.filter(function(e){return e.caseId===state.scope.id;});
  if(state.scope.type==='pdf') return [];
  if(state.scope.id==='flag') return EMAILS.filter(function(e){return e.flag;});
  if(state.scope.id==='arch') return EMAILS.filter(function(e){return e.arch;});
  if(state.scope.id==='unfiled') return EMAILS.filter(function(e){return !e.caseId;});
  return EMAILS.filter(function(e){return e.folder==='inbox';}); // é»˜è®¤ inbox
}
function renderList(){
  var arr=(state.scope.type==='case'? EMAILS.filter(function(e){return e.caseId===state.scope.id;}): pool())
          .sort(function(a,b){return new Date(b.date)-new Date(a.date);});
  var label= state.scope.type==='case' ? ('æ¡ˆä»¶ Â· '+(findOne(CASES,function(c){return c.id===state.scope.id;})||{}).name) :
              (findOne(MAILBOXES,function(m){return m.id===state.scope.id;})||{name:'è§†å›¾'}).name;
  $('#viewPill').textContent = label || 'è§†å›¾';

  var box=$('#list'); box.innerHTML='';
  if(state.scope.type==='pdf'){ box.innerHTML='<div style="padding:14px;color:#64748b">å½“å‰åœ¨â€œPDF é¢„è§ˆâ€æ¨¡å¼ã€‚</div>'; return; }
  var last='';
  arr.forEach(function(e){
    var lb=groupLabel(e.date);
    if(lb!==last){ last=lb; var hd=document.createElement('div'); hd.className='section-hd'; hd.innerText=lb; box.appendChild(hd); }
    var row=document.createElement('div'); row.className='row-mail';
    row.innerHTML='<div class="dot"></div>'
                 +'<div style="min-width:0"><div class="subject">'+e.subject+'</div>'
                 +'<div class="meta">'+e.from+' Â· '+(e.to||[]).join(', ')+'</div></div>'
                 +'<div class="meta">'+fmtDate(e.date)+'</div>';
    row.onclick=function(){ selectMail(e.id); };
    box.appendChild(row);
  });
}
var currentPdfUrl='';
function pills(addrs){return (addrs||[]).map(function(a){return '<span class="pill-addr">'+a+'</span>';}).join(' ');}
function selectMail(id){
  var e=findOne(EMAILS,function(x){return x.id===id;}); if(!e) return; state.selected=id; APP.caseId=e.caseId; $('#caseSelect').value=APP.caseId;

  $('#subj').textContent=e.subject;
  $('#hFrom').innerHTML=pills([e.from]);
  $('#hTo').innerHTML=pills(e.to||[]);
  if(e.cc && e.cc.length){ $('#ccLine').style.display='flex'; $('#hCc').innerHTML=pills(e.cc); }
  else{ $('#ccLine').style.display='none'; }
  $('#hTime').textContent=fmtDate(e.date);

  $('#kp').innerHTML='â€¢ è®®é¢˜ï¼š'+((e.tags&&e.tags.topic)||[]).join('ã€')+'<br>â€¢ å…³è”æ¡ˆä»¶ï¼š'+((findOne(CASES,function(c){return c.id===e.caseId;})||{}).name||'â€”');
  var kws=extractKeywords(e), chips=kws.map(function(k){return '<span class="chip link" data-k="'+k.replace(/"/g,'&quot;')+'">'+k+'</span>';});
  $('#chips').innerHTML=chips.join(' ');
  var atts=e.attachments||[]; $('#attach').innerHTML=atts.map(function(a){return '<span class="file">ğŸ“ '+a.name+'</span>';}).join(' ');
  $('#body').textContent=e.body||'';

  // é€‰æ‹©é»˜è®¤ PDF
  var url=null, att=(e.attachments||[]).filter(function(a){return /\.pdf$/i.test(a.name);})[0];
  if(att) url=att.url||att.name;
  if(!url && e.caseId){ var c=findOne(CASES,function(x){return x.id===e.caseId;}); if(c && c.pdfIds.length){ var p=findOne(PDFS,function(pp){return pp.id===c.pdfIds[0];}); url=p&&p.url; } }
  if(!url && PDFS.length) url=PDFS[0].url;
  if(url){ openPdf(url,{zoom:'page-fit'}); openPdfBig(url,{zoom:'page-fit'}); }

  document.querySelectorAll('.chip.link').forEach(function(el){ el.onclick=function(){ jumpSearch(el.getAttribute('data-k')); jumpSearchBig(el.getAttribute('data-k')); }; });

  updateSidePanels(e);
  renderTimeline(); // é€‰ä¸­é‚®ä»¶åï¼Œæ—¶é—´è½´é«˜äº®
}

/* ======================== PDF ç›¸å…³ï¼ˆå°è§†å›¾/å¤§è§†å›¾ï¼‰ ======================== */
function openPdf(url, opts){opts=opts||{};currentPdfUrl=url;var ps=[];if(opts.page)ps.push('page='+opts.page);if(opts.search)ps.push('search='+encodeURIComponent(opts.search));if(opts.zoom)ps.push('zoom='+opts.zoom);$('#pdfFrame').src=url+(ps.length?'#'+ps.join('&'):'#zoom=page-fit');}
function openPdfBig(url, opts){opts=opts||{};var ps=[];if(opts.page)ps.push('page='+opts.page);if(opts.search)ps.push('search='+encodeURIComponent(opts.search));if(opts.zoom)ps.push('zoom='+opts.zoom);$('#pdfFrame2').src=url+(ps.length?'#'+ps.join('&'):'#zoom=page-fit');}
function jumpSearch(q){ if(!currentPdfUrl) return; openPdf(currentPdfUrl,{search:q}); $('#pdfFind').value=q; }
function jumpSearchBig(q){ var url=$('#pdfFrame2').src || currentPdfUrl; if(!url) return; var base=url.split('#')[0]; $('#pdfFrame2').src=base+'#search='+encodeURIComponent(q); $('#pdfFind2').value=q; }
function syncPdfToBigView(){ var url=$('#pdfFrame').src || currentPdfUrl || (PDFS[0]&&PDFS[0].url); if(url) $('#pdfFrame2').src=url; }
$('#btnReload').onclick=function(){ openPdf(currentPdfUrl || (PDFS[0]&&PDFS[0].url), {zoom:'page-fit'}); };
$('#filePicker').onchange=function(ev){ var f=ev.target.files[0]; if(!f) return; openPdf(URL.createObjectURL(f),{zoom:'page-fit'}); };
$('#btnPage').onclick=function(){ var p=parseInt($('#pdfPage').value||''); if(p>0) openPdf(currentPdfUrl || (PDFS[0]&&PDFS[0].url), {page:p}); };
$('#btnFind').onclick=function(){ var q=$('#pdfFind').value.trim(); if(q) {jumpSearch(q); jumpSearchBig(q);} };
$('#btnReload2').onclick=function(){ var url=$('#pdfFrame2').src || currentPdfUrl || (PDFS[0]&&PDFS[0].url); $('#pdfFrame2').src=url.split('#')[0]+'#zoom=page-fit'; };
$('#filePicker2').onchange=function(ev){ var f=ev.target.files[0]; if(!f) return; openPdfBig(URL.createObjectURL(f),{zoom:'page-fit'}); };
$('#btnPage2').onclick=function(){ var p=parseInt($('#pdfPage2').value||''); if(p>0){ var base=($('#pdfFrame2').src||'').split('#')[0]; $('#pdfFrame2').src=base+'#page='+(parseInt(p,10)||1); } };
$('#btnFind2').onclick=function(){ var q=$('#pdfFind2').value.trim(); if(q) jumpSearchBig(q); };
$('#btnAddPdf').onclick=function(){ $('#pdfPicker').click(); };
$('#pdfPicker').onchange=function(ev){
  var f=ev.target.files[0]; if(!f) return;
  var id='pdf_'+Math.random().toString(36).slice(2,8);
  var url=URL.createObjectURL(f);
  PDFS.unshift({id:id,name:f.name,url:url});
  renderShelf(); renderCaseGroup();
};

/* ======================== å³ä¾§ä¿¡æ¯é¢æ¿ï¼ˆæ‘˜è¦/æŠ½å–/å…³è”åˆåŒï¼‰ ======================== */
function extractFields(text){
  var f={rate:null,laycan:null,load:null,disc:null,rules:null};
  var m=text.match(/USD[\s$]*([0-9,]+)\s*PDPR/i); if(m) f.rate='USD '+m[1]+' PDPR';
  m=text.match(/Laycan[^0-9]*([0-3]?\d[\-\â€“â€”][0-3]?\d\s*(Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec))/i); if(m) f.laycan=m[1];
  m=text.match(/Load\s*port\s*([A-Za-z][A-Za-z\s\-]+)/i); if(m) f.load=m[1].trim();
  m=text.match(/discharge\s*([A-Za-z][A-Za-z\s\-]+)/i); if(m) f.disc=m[1].trim();
  if(/SHINC/i.test(text)) f.rules='SHINC';
  if(/ICSID/i.test(text)) f.rules=f.rules?f.rules+', ICSID': 'ICSID';
  return f;
}
function updateSidePanels(email){
  var caseObj = email.caseId ? findOne(CASES,function(c){return c.id===email.caseId;}) : null;
  var topics=(email.tags&&email.tags.topic)||[];
  var brief= topics.length?('æœ¬é‚®ä»¶æ¶‰åŠï¼š'+topics.join('ã€')+'ã€‚å¯åœ¨åˆåŒä¸­å¿«é€Ÿæ£€ç´¢å¹¶æ ¸å¯¹ç›¸åº”æ¡æ¬¾ã€‚')
                         :'æ ¹æ®å…³é”®è¯åœ¨ä¸‹æ–¹åˆåŒä¸­å®šä½æ¡æ¬¾å¹¶é«˜äº®ï¼›å¿…è¦æ—¶åˆ‡æ¢æ¡ˆä»¶å…³è”åˆåŒã€‚';
  var s=$('#aisum'); if(s) s.textContent=brief;

  var f=extractFields(email.subject+' '+email.body);
  if($('#kvCase')) $('#kvCase').textContent = caseObj?caseObj.name:'â€”';
  if($('#kvRate')) $('#kvRate').textContent = f.rate||'â€”';
  if($('#kvLaycan')) $('#kvLaycan').textContent = f.laycan||'â€”';
  if($('#kvLoad')) $('#kvLoad').textContent = f.load||'â€”';
  if($('#kvDisc')) $('#kvDisc').textContent = f.disc||'â€”';
  if($('#kvRules')) $('#kvRules').textContent = f.rules||'â€”';

  var html='';
  if($('#relInfo')){
    if(caseObj){
      html+='<div style="margin-bottom:6px"><b>æ¡ˆä»¶ï¼š</b>'+caseObj.name+'</div>';
      if(caseObj.pdfIds.length){
        caseObj.pdfIds.forEach(function(id){
          var p=findOne(PDFS,function(x){return x.id===id;});
          if(p) html+='<div class="bookmark"><span>ğŸ“„ '+p.name+'</span><span class="mini-link" data-open="'+p.url+'">æ‰“å¼€</span></div>';
        });
      }else html+='<div class="pdf-empty">æš‚æ— å…³è”åˆåŒ</div>';
    }else html='æœªå…³è”åˆ°ä»»ä½•æ¡ˆä»¶ã€‚';
    $('#relInfo').innerHTML=html;
    document.querySelectorAll('[data-open]').forEach(function(a){ a.onclick=function(){ openPdf(a.getAttribute('data-open'),{zoom:'page-fit'}); openPdfBig(a.getAttribute('data-open'),{zoom:'page-fit'}); APP.view='pdf'; setHash('pdf'); applyView(); }; });
  }

  renderBookmarks(email.caseId||'GLOBAL');
}

/* ======================== å…³é”®è¯æŠ½å–ï¼ˆchipsï¼‰ ======================== */
function extractKeywords(e){
  var phrases={}, add=function(s){ if(s && !phrases[s]) phrases[s]=1; };
  var t=(e.subject+' '+e.body).toLowerCase();
  var a=(e.tags && e.tags.topic)||[]; a.forEach(add);
  var po=['Applicable Arbitration Rules','Constitution of the Tribunal','Fees and Expenses','Presence and Quorum','Rulings of the Tribunal','Power to Fix Time Limits','Secretary of the Tribunal','Representation of the Parties','Apportionment of Costs','Place of Proceeding','Procedural Language','Routing of Communications','Number of Copies','Sequence of Pleadings','Production of Documents','Submission of Documents','Witness Statements','Examination of Witnesses','Pre-Hearing','Hearings','Records of Hearings','Post-Hearing','Publication'];
  po.forEach(function(x){ if(t.indexOf(x.toLowerCase().split(' ')[0])>-1) add(x); });
  var sea=['Laycan','PDPR','NOR','SHINC','Demurrage','Beira','Tianjin','Recap','Busan','Manila'];
  sea.forEach(function(x){ if(t.indexOf(x.toLowerCase())>-1) add(x); });
  var m=e.body.match(/Option\s*\d/ig)||[]; m.forEach(add);
  return Object.keys(phrases).slice(0,12);
}

/* ======================== ä¹¦ç­¾ï¼ˆæœ¬åœ°å­˜å‚¨ï¼‰ ======================== */
function bmKey(caseId){ return 'arbimail.bm.'+(caseId||'GLOBAL'); }
function getBookmarks(caseId){ try{ var t=localStorage.getItem(bmKey(caseId)); return t?JSON.parse(t):[]; }catch(e){ return []; } }
function setBookmarks(caseId,arr){ try{ localStorage.setItem(bmKey(caseId),JSON.stringify(arr)); }catch(e){} }
function renderBookmarks(caseId){
  var box=$('#bmList'); var arr=getBookmarks(caseId);
  if(!box) return;
  if(!arr.length){ box.textContent='æš‚æ— ä¹¦ç­¾'; return; }
  box.innerHTML='';
  arr.forEach(function(b,idx){
    var row=document.createElement('div'); row.className='bookmark';
    row.innerHTML='<span>'+(b.type==='page'?'é¡µç  ':'å…³é”®å­— ')+b.value+'</span>'
                 +'<span><span class="mini-link" data-goto="'+idx+'">è·³è½¬</span> Â· <span class="mini-link" data-del="'+idx+'">åˆ é™¤</span></span>';
    box.appendChild(row);
  });
  box.querySelectorAll('[data-goto]').forEach(function(g){
    g.onclick=function(){
      var a=getBookmarks(caseId)[parseInt(g.getAttribute('data-goto'),10)];
      if(a){ if(a.type==='page'){ openPdf(currentPdfUrl|| (PDFS[0]&&PDFS[0].url), {page:parseInt(a.value,10)||1}); openPdfBig($('#pdfFrame2').src.split('#')[0]||currentPdfUrl, {page:parseInt(a.value,10)||1}); }
            else { jumpSearch(a.value); jumpSearchBig(a.value); } }
    };
  });
  box.querySelectorAll('[data-del]').forEach(function(g){
    g.onclick=function(){
      var idx=parseInt(g.getAttribute('data-del'),10); var arr=getBookmarks(caseId); arr.splice(idx,1); setBookmarks(caseId,arr); renderBookmarks(caseId);
      renderTimeline();
    };
  });
}
$('#bmAddPage').onclick=function(){
  var page = prompt('è¾“å…¥è¦æ·»åŠ çš„é¡µç ï¼š'); if(!page) return;
  var key = APP.caseId||'GLOBAL'; var arr=getBookmarks(key); arr.push({type:'page',value:page,ts:Date.now()}); setBookmarks(key,arr); renderBookmarks(key); renderTimeline();
};
$('#bmAddSearch').onclick=function(){
  var kw = $('#pdfFind').value.trim() || $('#pdfFind2').value.trim() || prompt('è¾“å…¥å…³é”®å­—ï¼š'); if(!kw) return;
  var key = APP.caseId||'GLOBAL'; var arr=getBookmarks(key); arr.push({type:'search',value:kw,ts:Date.now()}); setBookmarks(key,arr); renderBookmarks(key); renderTimeline();
};
$('#bmClear').onclick=function(){ var key=APP.caseId||'GLOBAL'; setBookmarks(key,[]); renderBookmarks(key); renderTimeline(); };

/* ======================== Recap ç”Ÿæˆï¼ˆæ¦‚è¦/é”šç‚¹/æ—¶é—´è½´/åˆ†èº«ï¼‰ ======================== */
function extractFromTextLite(text){
  var res={vessel:null, rate:null, laycan:null, load:null, disc:null, rules:[], options:[], clauses:[], rawHits:[]};
  if(!text) return res;
  var t=text;

  var m=t.match(/(MV\s+[A-Za-z][\w\- ]+)/i); if(m) res.vessel=m[1];
  var rm, rre=/USD[\s$]*([\d,]+(?:\.\d+)?)\s*(PDPR|PCT|MT|day)?/ig;
  while((rm=rre.exec(t))){ var val=('USD '+rm[1]+(rm[2]?' '+rm[2].toUpperCase():'')); if(!res.rate && /PDPR/i.test(val)) res.rate=val; }
  m=t.match(/Laycan[^0-9]*([0-3]?\d[\-\â€“â€”][0-3]?\d\s*(Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec))/i); if(m) res.laycan=m[1];
  m=t.match(/Load\s*port\s*([A-Za-z][A-Za-z\s\-]+)/i); if(m) res.load=m[1].trim();
  m=t.match(/discharge\s*([A-Za-z][A-Za-z\s\-]+)/i); if(m) res.disc=m[1].trim();
  var rules=(t.match(/\b(NOR|SHINC|ICSID)\b/ig)||[]); res.rules = Array.from(new Set(rules.map(function(x){return x.toUpperCase();})));
  var opts=(t.match(/Publication\s*Option\s*\d/ig)||[]).concat(t.match(/Option\s*\d/ig)||[]);
  res.options = Array.from(new Set(opts.map(function(x){return x.replace(/\s+/g,' ');})));
  res.clauses = Array.from(new Set((t.match(/(Â§\s*\d+|Clause\s*\d+|Section\s*\d+)/ig)||[])));
  res.rawHits = [res.vessel,res.rate,res.laycan,res.load,res.disc].filter(Boolean).concat(res.rules,res.options,res.clauses).slice(0,6);
  return res;
}
function mergeCaseSummary(items){
  var sum={vessel:null, rate:null, laycan:null, load:null, disc:null, rules:[], options:[], missing:[]};
  function pick(prev,now){return now || prev;}
  items.forEach(function(x){
    sum.vessel=pick(sum.vessel,x.vessel);
    sum.rate=pick(sum.rate,x.rate);
    sum.laycan=pick(sum.laycan,x.laycan);
    sum.load=pick(sum.load,x.load);
    sum.disc=pick(sum.disc,x.disc);
    sum.rules=Array.from(new Set(sum.rules.concat(x.rules||[])));
    sum.options=Array.from(new Set(sum.options.concat(x.options||[])));
  });
  ['vessel','laycan','load','disc','rate'].forEach(function(k){if(!sum[k]) sum.missing.push(k);});
  return sum;
}
function buildCaseRecap(caseId){
  var mails = EMAILS.filter(function(e){return e.caseId===caseId;})
                    .sort(function(a,b){return new Date(a.date)-new Date(b.date);});
  if(!mails.length) return null;
  var exts = mails.map(function(m){ return {mail:m, ext:extractFromTextLite((m.subject||'')+'\n'+(m.body||''))}; });
  var summary = mergeCaseSummary(exts.map(function(x){return x.ext;}));

  var anchors=[];
  exts.forEach(function(x){
    ['rate','laycan','load','disc','vessel'].forEach(function(k){ if(x.ext[k]) anchors.push({type:k,value:x.ext[k], mailId:x.mail.id}); });
    (x.ext.rules||[]).forEach(function(v){anchors.push({type:'rule',value:v,mailId:x.mail.id});});
    (x.ext.options||[]).forEach(function(v){anchors.push({type:'option',value:v,mailId:x.mail.id});});
    (x.ext.clauses||[]).forEach(function(v){anchors.push({type:'clause',value:v,mailId:x.mail.id});});
  });
  var seen={}; anchors = anchors.filter(function(a){var key=a.type+':'+a.value; if(seen[key]) return false; seen[key]=1; return true;});

  var timeline = mails.map(function(m){ var hit=extractFromTextLite((m.subject||'')+'\n'+(m.body||'')).rawHits; return {ts:m.date, title:m.subject, hits:hit, mailId:m.id}; });

  return {summary:summary, anchors:anchors, timeline:timeline};
}

/* åˆ†èº«ç³»ç»Ÿï¼ˆè§’è‰²æ¨¡ç‰ˆï¼‰ */
var PERSONAS = {
  counsel: {
    name:'ä»£ç†å¾‹å¸ˆ',
    template: function(sum){
      var want=[];
      if(!sum.rate) want.push('è´¹ç‡/è®¡ä»·æ–¹å¼ï¼ˆå¦‚ PDPRï¼‰');
      if(!sum.laycan) want.push('Laycan çª—å£');
      if(!sum.load) want.push('è£…æ¸¯');
      if(!sum.disc) want.push('å¸æ¸¯');
      return [
        'å„ä½å¥½ï¼Œ',
        '',
        'åŸºäºç›®å‰å¾€æ¥é‚®ä»¶ï¼Œæˆ‘æ–¹å¯¹è¦ç‚¹çš„ç†è§£å¦‚ä¸‹ï¼š',
        'â€¢ èˆ¹åï¼š'+(sum.vessel||'â€”'),
        'â€¢ Laycanï¼š'+(sum.laycan||'â€”'),
        'â€¢ è£…/å¸æ¸¯ï¼š'+(sum.load||'â€”')+' / '+(sum.disc||'â€”'),
        'â€¢ è´¹ç‡ï¼š'+(sum.rate||'â€”'),
        'â€¢ è§„åˆ™ï¼š'+(sum.rules && sum.rules.length? sum.rules.join('ã€') : 'â€”'),
        (sum.options && sum.options.length? ('â€¢ æ¡æ¬¾åå¥½/é€‰é¡¹ï¼š'+sum.options.join('ã€')):''),
        '',
        want.length?('ä¸ºæ¨è¿›å®šç¨¿ï¼Œè¿˜è¯·ç¡®è®¤ï¼š'+want.join('ã€')+'ã€‚'):'',
        'å¦‚æ— å¼‚è®®ï¼Œæˆ‘æ–¹å°†æ®æ­¤æ›´æ–°Recap/åˆåŒæ¡æ¬¾å¹¶å›ä¼ ã€‚',
        '',
        'æ­¤è‡´'
      ].join('\n');
    }
  },
  arbitrator: {
    name:'ä»²è£å‘˜',
    template: function(sum){
      return [
        'å„ä½ä»£ç†äººï¼š',
        '',
        'ä¸ºç¡®ä¿ç¨‹åºæ¸…æ™°ï¼Œç°æ±‡æ€»æœ¬æ¡ˆå½“å‰èŠ‚ç‚¹è¦ç‚¹ï¼š',
        'â€¢ èˆ¹åï¼š'+(sum.vessel||'â€”')+'ï¼›Laycanï¼š'+(sum.laycan||'â€”'),
        'â€¢ è£…/å¸æ¸¯ï¼š'+(sum.load||'â€”')+' / '+(sum.disc||'â€”'),
        'â€¢ è´¹ç‡ä¸è§„åˆ™ï¼š'+(sum.rate||'â€”')+'ï¼›'+(sum.rules && sum.rules.length? sum.rules.join('ã€'):'â€”'),
        'â€¢ è‹¥å¯¹ä»¥ä¸Šè¦ç‚¹å­˜åœ¨åˆ†æ­§ï¼Œè¯·åœ¨ä¸¤ä¸ªå·¥ä½œæ—¥å†…ä»¥ä¹¦é¢è¯´æ˜ï¼Œä¾¿äºç¡®å®šåç»­ç¨‹åºå®‰æ’ï¼ˆå«æäº¤é¡ºåºä¸æœŸé™ï¼‰ã€‚',
        '',
        'æ•¬è¯·éµå®ˆç›¸åº”æ—¶é—´è¡¨ã€‚'
      ].join('\n');
    }
  }
};

/* ======= Recap è§†å›¾æ¸²æŸ“ ======= */
function renderRecap(){
  if(!APP.caseId){ $('#recapSummary').innerHTML='è¯·å…ˆé€‰æ‹©æ¡ˆä»¶ã€‚'; return; }
  var data = buildCaseRecap(APP.caseId); if(!data){ $('#recapSummary').innerHTML='è¯¥æ¡ˆä»¶æš‚æ— é‚®ä»¶ã€‚'; return; }
  var sum=data.summary;
  $('#recapSummary').innerHTML=[
    'â€¢ èˆ¹åï¼š'+(sum.vessel||'â€”'),
    'â€¢ Laycanï¼š'+(sum.laycan||'â€”'),
    'â€¢ è£…/å¸æ¸¯ï¼š'+(sum.load||'â€”')+' / '+(sum.disc||'â€”'),
    'â€¢ è´¹ç‡ï¼š'+(sum.rate||'â€”'),
    'â€¢ è§„åˆ™ï¼š'+(sum.rules && sum.rules.length? sum.rules.join('ã€'):'â€”'),
    (sum.options && sum.options.length? ('â€¢ æ¡æ¬¾åå¥½/é€‰é¡¹ï¼š'+sum.options.join('ã€')):''),
    (sum.missing && sum.missing.length? ('â€¢ å¾…ç¡®è®¤ï¼š'+sum.missing.join('ã€')):'' )
  ].filter(Boolean).join('<br>');
  // é”šç‚¹
  var aBox=$('#recapAnchors'); aBox.innerHTML='';
  data.anchors.slice(0,48).forEach(function(a){
    var btn=document.createElement('span'); btn.className='chip link'; btn.textContent=a.type+'ï¼š'+a.value;
    btn.onclick=function(){ jumpSearch(a.value); jumpSearchBig(a.value); APP.view='pdf'; setHash('pdf'); applyView(); };
    aBox.appendChild(btn);
  });
  // è‡ªåŠ¨å›å¤
  var roleSel=$('#roleSelect'); roleSel.value=APP.role||'counsel';
  $('#autoReply').value = (PERSONAS[roleSel.value]||PERSONAS.counsel).template(sum);
  $('#regenReply').onclick=function(){ var r=roleSel.value; $('#autoReply').value=(PERSONAS[r]||PERSONAS.counsel).template(sum); };

  // å¤åˆ¶æŒ‰é’® & é‡æ–°åˆ†æ
  $('#btnCopyRecap').onclick=function(){
    var txt = stripTags($('#recapSummary').innerHTML);
    navigator.clipboard.writeText(txt);
  };
  $('#btnReAnalyze').onclick=function(){ renderRecap(); };
}

/* ======================== çŸ©é˜µè§„åˆ™/æ„å»º/æ¸²æŸ“ ======================== */
function mailSide(email){
  if(/claimant\.counsel/i.test(email.from)) return 'us';
  if(/respondent\.counsel/i.test(email.from)) return 'them';
  return 'neutral';
}
var MATRIX_RULES = [
  {key:'quorum', title:'Presence & Quorumï¼ˆæ³•å®šäººæ•°ï¼‰',
   hit:function(t){return /quorum/i.test(t)||/two[-\s]?person/i.test(t);},
   norm:function(t){ if(/two[-\s]?person/i.test(t)) return 'Option 1ï¼šä¸¤äººæˆå‘˜åˆ°åœºä¸ºæ³•å®šäººæ•°'; return 'ç»´æŒå¸¸è§„æ³•å®šäººæ•°ï¼ˆæœªæŒ‡æ˜ï¼‰'; }},
  {key:'language', title:'Procedural Languageï¼ˆç¨‹åºè¯­è¨€ï¼‰',
   hit:function(t){return /procedural\s+language/i.test(t)||/english only/i.test(t);},
   norm:function(t){ return /english\s+only/i.test(t)? 'Option 1ï¼šä»…ç”¨è‹±æ–‡' : 'åŒè¯­/æœªæŒ‡æ˜'; }},
  {key:'publication', title:'Publicationï¼ˆè£å†³å…¬å¸ƒï¼‰',
   hit:function(t){return /publication\s+option/i.test(t);},
   norm:function(t){ var m=t.match(/publication\s+option\s*(\d)/i); return m? ('Option '+m[1]) : 'æœªæŒ‡æ˜'; }},
  {key:'transcript', title:'Hearing Transcriptï¼ˆåº­å®¡é€Ÿè®°ï¼‰',
   hit:function(t){return /transcript/i.test(t);},
   norm:function(t){ return /real[-\s]?time/i.test(t)? 'å®æ—¶é€Ÿè®°' : 'å¸¸è§„é€Ÿè®°'; }},
  {key:'production', title:'Production of Documentsï¼ˆæ–‡ä¹¦å±•ç¤ºï¼‰',
   hit:function(t){return /production of documents|rules?\s*33[\-\â€“]36/i.test(t);},
   norm:function(){return 'ä¾ ICSID è§„åˆ™ 33â€“36'; }},
  {key:'laycan', title:'Laycanï¼ˆè£…æœŸï¼‰',
   hit:function(t){return /laycan/i.test(t);},
   norm:function(t){ var m=t.match(/laycan[^0-9]*([0-3]?\d[\-\â€“â€”][0-3]?\d\s*(Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec))/i); return m?m[1]:'æœªæŒ‡æ˜'; }},
  {key:'ports', title:'è£…/å¸æ¸¯',
   hit:function(t){return /load\s*port|discharge/i.test(t);},
   norm:function(t){
     var l=t.match(/Load\s*port\s*([A-Za-z][A-Za-z\s\-]+)/i);
     var d=t.match(/discharge\s*([A-Za-z][A-Za-z\s\-]+)/i);
     return (l?('è£… '+l[1].trim()):'è£…æœªæŒ‡æ˜')+'ï¼›'+(d?('å¸ '+d[1].trim()):'å¸æœªæŒ‡æ˜');
   }},
  {key:'rate', title:'è´¹ç‡/è§„åˆ™',
   hit:function(t){return /USD/i.test(t)||/PDPR/i.test(t)||/SHINC/i.test(t);},
   norm:function(t){
     var r=t.match(/USD[\s$]*([\d,]+)\s*PDPR/i); var s=/SHINC/i.test(t)?'ï¼›SHINC':'';
     return r?('USD '+r[1]+' PDPR'+s):('ï¼ˆæœªæ˜ï¼‰'+s);
   }},
  {key:'nor', title:'NORï¼ˆå‡†å¤‡å°±ç»ªé€šçŸ¥ï¼‰',
   hit:function(t){return /\bNOR\b/i.test(t);},
   norm:function(t){ return /window|valid/i.test(t)? 'NOR æœ‰æ•ˆæ€§/æ—¶é—´çª—éœ€ç¡®è®¤' : 'NOR æ¡æ¬¾'; }}
];
function buildMatrix(caseId){
  var mails = EMAILS.filter(function(e){return e.caseId===caseId;});
  var rows = {};
  mails.forEach(function(m){
    var t=(m.subject||'')+'\n'+(m.body||'');
    MATRIX_RULES.forEach(function(r){
      if(r.hit(t)){
        var val = r.norm(t);
        if(!rows[r.key]) rows[r.key] = {key:r.key, title:r.title, us:null, them:null, neutral:null, ai:null};
        var side = mailSide(m);
        rows[r.key][side] = rows[r.key][side] || {text:val, mailId:m.id, from:m.from, date:m.date};
      }
    });
  });
  Object.keys(rows).forEach(function(k){
    var r=rows[k];
    var pick = r.us && r.them
      ? ( (r.us.text.length>=r.them.text.length) ? r.us : r.them )
      : ( r.us || r.them || r.neutral );
    r.ai = pick ? {text:pick.text, from:'AI', mailId:(pick.mailId||null)} : null;
  });
  return Object.keys(rows).map(function(k){return rows[k];});
}
function renderMatrix(rows, caseId){
  var body = document.getElementById('matrixBody');
  if(!rows.length){ body.innerHTML = '<tr><td colspan="6" style="text-align:center;color:#94a3b8">æœªåœ¨é‚®ä»¶ä¸­è¯†åˆ«åˆ°å¯ç»“æ„åŒ–çš„è®®é¢˜ã€‚</td></tr>'; return; }
  body.innerHTML='';
  var saved = JSON.parse(localStorage.getItem('arbimail.matrix.pick.'+caseId) || '{}');

  rows.forEach(function(r){
    var tr=document.createElement('tr');

    var tdTopic=document.createElement('td');
    tdTopic.innerHTML='<div class="m-topic">'+r.title+'</div><div class="m-sub">'+r.key+'</div>';
    tr.appendChild(tdTopic);

    function cell(who,label){
      var td=document.createElement('td');
      var d=r[who];
      if(d){
        td.innerHTML = '<div class="m-badge '+who+'">'+label+'</div> '
          + (d.text||'') + (d.text?(' <span class="mini-link" data-find="'+encodeURIComponent(d.text)+'">ï¼ˆé«˜äº®ï¼‰</span>'):'');
      }else{
        td.innerHTML = '<span style="color:#94a3b8">â€”</span>';
      }
      return td;
    }
    tr.appendChild(cell('us','æˆ‘æ–¹'));
    tr.appendChild(cell('them','å¯¹æ–¹'));
    tr.appendChild(cell('ai','AI'));

    var tdPick=document.createElement('td'); tdPick.className='pick';
    ['us','them','ai'].forEach(function(k){
      var dis = !r[k];
      var checked = (saved[r.key]||'ai')===k && !dis;
      tdPick.innerHTML += '<label style="opacity:'+(dis?'.4':'1')+'"><input type="radio" name="pick_'+r.key+'" value="'+k+'" '+(checked?'checked':'')+' '+(dis?'disabled':'')+'> '+({'us':'é‡‡çº³æˆ‘æ–¹','them':'é‡‡çº³å¯¹æ–¹','ai':'é‡‡çº³AI'})[k]+'</label> ';
    });
    tr.appendChild(tdPick);

    var tdEv=document.createElement('td');
    var ev = r.us||r.them||r.neutral;
    tdEv.innerHTML = ev ? ('<span class="mini-link" data-goto="'+ev.mailId+'">æŸ¥çœ‹é‚®ä»¶</span>') : '<span style="color:#94a3b8">â€”</span>';
    tr.appendChild(tdEv);

    body.appendChild(tr);
  });

  body.querySelectorAll('[data-goto]').forEach(function(a){ a.onclick=function(){ APP.view='mail'; setHash('mail'); applyView(); selectMail(this.getAttribute('data-goto')); }; });
  body.querySelectorAll('[data-find]').forEach(function(a){ a.onclick=function(){ var q=decodeURIComponent(this.getAttribute('data-find')); jumpSearch(q); jumpSearchBig(q); APP.view='pdf'; setHash('pdf'); applyView(); }; });

  body.querySelectorAll('input[type=radio]').forEach(function(rdo){
    rdo.onchange=function(){
      var key = this.name.replace('pick_','');
      var val = this.value;
      saved[key]=val;
      localStorage.setItem('arbimail.matrix.pick.'+caseId, JSON.stringify(saved));
      renderTimeline(); // ç«‹å³åœ¨æ—¶é—´è½´ç”Ÿæˆâ€œçŸ©é˜µå†³è®®â€èŠ‚ç‚¹
    };
  });
}
function applyMatrixToRecap(rows, caseId){
  var saved = JSON.parse(localStorage.getItem('arbimail.matrix.pick.'+caseId) || '{}');
  var lines = [];
  rows.forEach(function(r){
    var k = saved[r.key] || 'ai';
    var src = r[k];
    if(src && src.text){
      lines.push('â€¢ '+r.title+'ï¼š'+src.text+(k==='us'?'ï¼ˆé‡‡çº³æˆ‘æ–¹ï¼‰':k==='them'?'ï¼ˆé‡‡çº³å¯¹æ–¹ï¼‰':'ï¼ˆé‡‡çº³AIï¼‰'));
    }
  });
  if(!lines.length){ alert('è¯·è‡³å°‘é€‰æ‹©ä¸€é¡¹é‡‡çº³ã€‚'); return; }

  var box = document.getElementById('recapSummary');
  var base = box.innerHTML.replace(/<br>\s*<b>çŸ©é˜µå†³è®®ï¼š<\/b>[\s\S]*$/,'');
  box.innerHTML = base + '<br><b>çŸ©é˜µå†³è®®ï¼š</b><br>' + lines.join('<br>');

  var txt = box.innerText || box.textContent || '';
  var role = (document.getElementById('roleSelect')||{}).value || 'counsel';
  var persona = (PERSONAS[role]||PERSONAS.counsel);
  document.getElementById('autoReply').value =
    persona.template({vessel:'',laycan:'',load:'',disc:'',rate:'',rules:[],options:[]}) + '\n\nâ€”â€” é™„ï¼šçŸ©é˜µå†³è®®æ‘˜è¦ â€”â€”\n' + lines.join('\n');

  renderTimeline(); // å†³è®®å†™å›åï¼Œæ—¶é—´è½´ä¹Ÿæ›´æ–°
}

/* ======================== æ—¶é—´è½´ï¼ˆå³ä¾§å¸¸é©»ï¼‰ ======================== */
function tlItems(caseId){
  var arr=[];
  // é‚®ä»¶
  EMAILS.filter(function(e){return e.caseId===caseId;}).forEach(function(e){
    var hits = extractFromTextLite((e.subject||'')+'\n'+(e.body||'')).rawHits;
    arr.push({type:'mail', ts:+new Date(e.date), label:e.subject, hits:hits, id:e.id, side:mailSide(e)});
  });
  // çŸ©é˜µå†³è®®ï¼ˆå·²é‡‡çº³ï¼‰
  var saved = JSON.parse(localStorage.getItem('arbimail.matrix.pick.'+caseId) || '{}');
  Object.keys(saved).forEach(function(key){
    var rows = buildMatrix(caseId).filter(function(r){return r.key===key;});
    if(rows[0]){
      var src = rows[0][ saved[key] ];
      if(src) arr.push({type:'matrix', ts:+new Date(src.date||Date.now()), label:'çŸ©é˜µï¼š'+rows[0].title, hits:[src.text], id:key, pick:saved[key]});
    }
  });
  // ä¹¦ç­¾
  (getBookmarks(caseId)||[]).forEach(function(b){
    arr.push({type:'bookmark', ts:b.ts||Date.now(), label: (b.type==='page'?'é¡µç  ':'å…³é”®å­— ')+b.value, hits:[], sub:b.type, value:b.value});
  });
  // ç¨‹åºï¼ˆä»²è£ï¼‰
  var sched=[{ts:+new Date('2025-08-21T09:00:00'), label:'ä¹¦çŠ¶äº¤æ¢ I æˆªæ­¢', type:'schedule'},
             {ts:+new Date('2025-09-05T18:00:00'), label:'è¯äººå£°æ˜æäº¤', type:'schedule'},
             {ts:+new Date('2025-09-20T10:00:00'), label:'å¬è¯ä¼šé¢„å¤‡ä¼šè®®', type:'schedule'}];
  sched.forEach(function(s){ s.hits=[]; arr.push(s); });
  return arr.sort(function(a,b){return b.ts-a.ts;});
}
function renderTimeline(){
  var box=$('#timelineBox'); if(!box) return;
  if(!APP.caseId){ box.innerHTML='<div style="color:#94a3b8">è¯·é€‰æ‹©æ¡ˆä»¶ã€‚</div>'; return; }
  var typesSel=$('#tlTypes').value.split(',');
  var range=$('#tlRange').value;
  var now=Date.now(), start = range==='today'? new Date().setHours(0,0,0,0) : (range==='7d'? now-7*86400000 : 0);
  var items=tlItems(APP.caseId).filter(function(x){ return x.ts>=start && (typesSel.indexOf(x.type)>=0); });

  if(!items.length){ box.innerHTML='<div style="color:#94a3b8">è¯¥æ¡ä»¶ä¸‹æ— æ—¶é—´è½´æ•°æ®ã€‚</div>'; return; }
  box.innerHTML='';
  var groups={};
  items.forEach(function(it){
    var lbl = groupLabel(it.ts);
    (groups[lbl]=groups[lbl]||[]).push(it);
  });
  Object.keys(groups).forEach(function(g){
    var h=document.createElement('div'); h.style.cssText='color:#7a869f;font-size:12px;margin-top:6px'; h.textContent=g; box.appendChild(h);
    groups[g].forEach(function(it){
      var row=document.createElement('div'); row.className='t-item';
      var typeTag = it.type==='mail'?'ğŸ“§': it.type==='matrix'?'âœ…': it.type==='bookmark'?'ğŸ”–':'â±';
      var sub = it.type==='matrix'? ('ï¼ˆ'+({us:'æˆ‘æ–¹',them:'å¯¹æ–¹',ai:'AI'}[it.pick||'ai']||'')+'ï¼‰') : (it.type==='bookmark'?('ï¼ˆ'+(it.sub==='page'?'é¡µç ':'å…³é”®å­—')+'ï¼‰'):'');
      row.innerHTML='<div style="font-weight:600">'+typeTag+' '+fmtDate(it.ts)+'</div>'
                   +'<div>'+it.label+ (sub||'') +'</div>'
                   + (it.hits && it.hits.length?('<div style="color:#64748b;font-size:12px">è¦ç‚¹ï¼š'+it.hits.slice(0,3).join('ï¼Œ')+'</div>'):'');
      row.onclick=function(){
        if(it.type==='mail'){ APP.view='mail'; setHash('mail'); applyView(); selectMail(it.id); }
        if(it.type==='matrix'){ APP.view='matrix'; setHash('matrix'); applyView(); jumpSearch(it.hits[0]||''); jumpSearchBig(it.hits[0]||''); }
        if(it.type==='bookmark'){ APP.view='pdf'; setHash('pdf'); applyView(); if(it.sub==='page'){ openPdf(currentPdfUrl|| (PDFS[0]&&PDFS[0].url), {page:parseInt(it.value,10)||1}); openPdfBig($('#pdfFrame2').src.split('#')[0]||currentPdfUrl, {page:parseInt(it.value,10)||1}); } else { jumpSearch(it.value); jumpSearchBig(it.value); } }
        if(it.type==='schedule'){ /* å¯é€‰ï¼šè·³ç›¸å…³é“¾æ¥ */ }
      };
      box.appendChild(row);
    });
  });
}
$('#tlRange').onchange=renderTimeline; $('#tlTypes').onchange=renderTimeline;

/* ======================== é¡¶éƒ¨è§†å›¾ï¼šRecap & çŸ©é˜µ äº‹ä»¶ ======================== */
$('#btnApplyMatrix').onclick=function(){
  var rows=buildMatrix(APP.caseId||''); applyMatrixToRecap(rows, APP.caseId||''); };
$('#btnGenRecap').onclick=function(){
  APP.view='recap'; setHash('recap'); applyView(); renderRecap(); };

/* ======================== å·¦ä¾§äº‹ä»¶ç»‘å®šä¸åˆå§‹åŒ– ======================== */
function wireBasics(){ wireToggles(); wireMailboxes(); }

/* ======================== æ¡ˆä»¶åˆ‡æ¢åçš„åˆ·æ–° ======================== */
function refreshForCase(){
  // é‚®ä»¶è§†å›¾ï¼šé»˜è®¤æŒ‰æ¡ˆä»¶
  state.scope={type:'case',id:APP.caseId}; renderList();
  // Recap/çŸ©é˜µ
  renderRecap();
  var rows=buildMatrix(APP.caseId||''); renderMatrix(rows, APP.caseId||'');
  // ä¹¦ç­¾/æ—¶é—´è½´
  renderBookmarks(APP.caseId||'GLOBAL'); renderTimeline();
  // æ‰“å¼€å…³è”åˆåŒ
  var c=findOne(CASES,function(x){return x.id===APP.caseId;});
  if(c && c.pdfIds && c.pdfIds.length){ var p=findOne(PDFS,function(pp){return pp.id===c.pdfIds[0];}); if(p){ openPdf(p.url,{zoom:'page-fit'}); openPdfBig(p.url,{zoom:'page-fit'}); } }
}

/* ======================== åˆå§‹åŒ– ======================== */
function init(){
  initTopBar(); applyRole(); applyView();
  setBadgeCounts(); renderCaseGroup(); renderShelf(); wireBasics();

  // é»˜è®¤é€‰æ‹©ä¸€å°é‚®ä»¶ï¼ˆè‹¥åœ¨é‚®ä»¶è§†å›¾ï¼‰
  if(APP.view==='mail'){
    var first = EMAILS.find(function(e){return e.caseId===(APP.caseId||CASES[0].id);}) || EMAILS[0];
    if(first){ selectMail(first.id); }
  }

  // åˆæ¬¡æ¸²æŸ“ Recap ä¸çŸ©é˜µ
  renderRecap();
  renderMatrix(buildMatrix(APP.caseId||CASES[0].id), APP.caseId||CASES[0].id);

  // å³ä¾§æ—¶é—´è½´ä¸ä¹¦ç­¾
  renderBookmarks(APP.caseId||'GLOBAL');
  renderTimeline();
}
init();

/* ======================== ç¤ºä¾‹ï¼šä»²è£å‘˜æŒ‰é’®ï¼ˆå ä½ï¼‰ ======================== */
if($('#btnOrder'))     $('#btnOrder').onclick     = function(){ alert('æ‰“å¼€ã€Œç¨‹åºä»¤è‰æ¡ˆã€ç¼–è¾‘å™¨ï¼ˆç¤ºä¾‹ï¼‰ã€‚'); };
if($('#btnDeadline'))  $('#btnDeadline').onclick  = function(){ alert('è®¾ç½®ç¨‹åºæœŸé™ï¼ˆç¤ºä¾‹ï¼‰ã€‚'); };
if($('#btnRequestDocs'))$('#btnRequestDocs').onclick=function(){ alert('å‘é€ã€Œææ–™æäº¤ã€è¯·æ±‚ï¼ˆç¤ºä¾‹ï¼‰ã€‚'); };
</script>
</body>
</html>
